Imports System.IO
Partial Class manager_Desktop_WriteSendMessage
    Inherits System.Web.UI.Page
    Dim Base As New Base
    Public Login_User As String
    Dim UserID As Integer
    Dim Sid As Integer
    Dim Kind As Integer
    Dim BaseUrl As String       '在读取XML文件内容时的基目录

    Dim LCDM As Integer
    Dim XMDM As Integer                 '当传过来是项目的时候.

    Dim MaxAtt As Integer       '表示附件存储的当前个数

    Dim TempFolder As String
    Dim msgID As Integer
    Dim msgContent As String
    Dim isgroup As Integer
    Dim sendBm As String '发送部门名称
    Dim msgTitle As String '标题
    Dim msgKeyName As String '需要改变状态的字段名
    Dim msgState As String '指定字段名需要改变的内容
    Dim sendUserName As String '指定发送用户（如果不为空，则自动发送）
    Dim sendUserNames As String() '指定发送用户组
    Public bm As String     '指定部门名称

    Dim isreply As Boolean '是否回复



    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        '得到用户信息
        Login_User = Base.GetWebUserName
        UserID = Base.GetUserID(Login_User)

        TempFolder = Server.MapPath("../../" & "PersonalFolders/" & Login_User & "/临时附件文件夹")
        Base.IO.CreateDir(TempFolder)

        Dim tb As New Data.DataTable
        Dim FID As String = Request("FID")
        Dim i As Integer
        Try
            Sid = Request("SID")
        Catch ex As Exception
        End Try

        Try         '来源类型
            Kind = Request("Kind")
        Catch ex As Exception
            Kind = 0
        End Try

        If Kind = 1 Then            '如果当是分发的时候。则显示限时回收的功能。
            CheckBox2.Visible = True
        Else
            CheckBox2.Visible = False
        End If

        Try
            XMDM = Request("XMDM")
        Catch ex As Exception
            XMDM = 0
        End Try

        If Not IsPostBack Then

            If RadioButtonList1.SelectedItem.Value = "0" Then
                iframe1.Attributes("src") = "../Dialog/UserListDialog.aspx?obj=userlist&bm=" & bm
            ElseIf RadioButtonList1.SelectedItem.Value = "1" Then
                iframe1.Attributes("src") = "../Dialog/DepartmentListDialog.aspx?obj=userlist&bm=" & bm
            End If

        End If

        '指定发送的部门
        Try
            bm = Base.SqlFilter(Request("bm").ToString)
        Catch ex As Exception
            bm = ""
        End Try

        '指定发送用户（如果不为空，则自动发送）
        Try
            sendUserName = Base.SqlFilter(Request("username").ToString)
        Catch ex As Exception
            sendUserName = ""
        End Try

        '发送标题
        Try
            msgTitle = Base.SqlFilter(Request("str").ToString())
        Catch ex As Exception
            msgTitle = ""
        End Try


        Dim strIsgroup As String
        Try
            strIsgroup = Base.SqlFilter(Request("isgroup").ToString)
        Catch ex As Exception
            strIsgroup = ""
        End Try

        If strIsgroup = "" Then
            If CheckBox3.Checked = True Then
                isgroup = 1
            Else
                isgroup = 0
            End If
        Else
            Try
                isgroup = Convert.ToInt32(strIsgroup)
            Catch ex As Exception
                isgroup = 0
            End Try

        End If

        

        '需要改变状态的字段名
        Try
            msgKeyName = Base.SqlFilter(Request("keyname").ToString())
        Catch ex As Exception
            msgKeyName = ""
        End Try

        '指定字段名需要改变的内容
        Try
            msgContent = Base.SqlFilter(Request("str").ToString())
        Catch ex As Exception
            msgContent = ""
        End Try

        '指定的流程状态
        Try
            msgState = Base.SqlFilter(Request("state").ToString())
        Catch ex As Exception
            msgState = ""
        End Try

        '自动发送用户
        If sendUserName <> "" And sendUserName <> "undefined" Then
            sendUserNames = sendUserName.Split(",")
            For i = 0 To sendUserNames.Length - 1
                Dim temp As String
                tb = Base.DB.Table("SELECT [YGDM], [YGXM],[DLMC] FROM [GY_YGDM] WHERE  (IsOut = 0 or IsOut is null)  and ([QYBZ] = 1) and [DLMC]='" & sendUserNames(i) & "'", "aa")
                If tb.Rows.Count > 0 Then
                    temp = tb.Rows(0).Item("YGXM").ToString.Trim & "<span style=color:#acacac>(" & tb.Rows(0).Item("DLMC").ToString.Trim & ");</span>"
                    scriptdiv.InnerHtml = "<script language='javascript' type='text/javascript'>select_test('" & temp & "','" & tb.Rows(0).Item("YGDM").ToString.Trim & "')</script>"
                End If
            Next
            msgAutoSend(FID, 0)
            Exit Sub
        End If

        '自动发送部门
        If sendBm <> "" Then
            Dim temp As String
            tb = Base.DB.Table("SELECT [KSDM], [KSMC] FROM [GY_KSDM] WHERE KSMC='" & sendBm & "'", "aa")
            If tb.Rows.Count > 0 Then
                temp = "" & tb.Rows(i).Item(1).ToString.Trim & "<span style=color:#acacac>;</span>"
                scriptdiv.InnerHtml = "<script language='javascript' type='text/javascript'>select_test('" & temp & "','" & tb.Rows(0).Item("ksdm").ToString.Trim & "')</script>"
            End If
            msgAutoSend(FID, 1)
            Exit Sub
        End If

        If Page.IsPostBack = False Then
            '删除附件
            Try
                Dim sel As String
                sel = Base.SqlFilter(Request("Sel").ToString)
                If sel.Length > 0 Then
                    IO.File.Delete(TempFolder & "\" & sel)
                End If
            Catch ex As Exception
            End Try

            Dim TmpFid As Integer
            If FID Is Nothing Then FID = ""

            If FID.Trim.Length > 0 Then
                If FID.IndexOf(",") > 0 Then
                    FID = FID & "-1"                '如果是  10,10,这样子的话,则变成10,10,-1
                End If
                Fids.Text = FID.Trim

                If FID.Split(",").Length > 0 Then
                    Try
                        TmpFid = FID.Split(",")(0)
                    Catch ex As Exception
                        TmpFid = -1
                    End Try
                End If
            Else
                'Panel1.Visible = False
            End If

            tb = Base.DB.Table("SELECT NoLcDM,MKMC  FROM GY_MKXX,XX_XMJC where GY_MKXX.MKDM=XX_XMJC.MKDM and FID = " & TmpFid, "dd")
            If tb.Rows.Count > 0 Then
                Try
                    If msgTitle <> "" Then
                        Title.Text = msgTitle.Replace("'", "")
                    Else
                        Title.Text = tb.Rows(0)(1).ToString.Replace("wzdj_", "")
                    End If
                Catch ex As Exception
                    Title.Text = tb.Rows(0)(1).ToString
                End Try

                LCDM = tb.Rows(0)(0)
                BaseUrl = Server.MapPath("../../") & "FormFolder/" & tb.Rows(0)(1).ToString.Trim & "/"
            Else
                LCDM = -1
            End If

            '显示表单附件
            'Try
            '    Base.CreateGridviewTitle(GridView1, LCDM, False)
            '    Base.FillDataToGridview(GridView1, LCDM, "", "SELECT XX_XMJC.FID,GY_XMXX.XMDM,XX_XMJC.State FROM GY_XMXX,XX_XMJC where XX_XMJC.FID in (" & FID.Trim & ") and XX_XMJC.XMDM = GY_XMXX.XMDM and (GY_XMXX.XMJD is not null)", "", False)
            'Catch ex As Exception
            '    Response.Write("此功能的模板已经不存在,请刷新菜单!")
            '    Response.End()
            'End Try
            'GridView1.DataBind()


            '这里对回复的内容进行处理，得到相应的短消息内容
            If isreply = True Then
                tb = Base.DB.Table("Select Title,FromID,Content From SendMessage where CId=" & Sid, "SendMessage")
                If tb.Rows.Count > 0 Then
                    If msgTitle <> "" Then
                        Title.Text = "[回复] " & msgTitle
                    Else
                        Title.Text = "[回复] " & tb.Rows(0).Item(0)
                    End If
                End If
                Dim tb1 As New DataTable
                tb1 = Base.DB.Table("SELECT [YGDM], [YGXM],[DLMC] FROM [GY_YGDM] WHERE (IsOut = 0 or IsOut is null) and ([QYBZ] = 1) and YGDM=" & tb.Rows(i).Item(1), "d1")
                replyUser.InnerHtml = tb1.Rows(0).Item(1) & "(" & tb1.Rows(0).Item("DLMC").ToString.Trim & ")"
                replyUser.Visible = True
                userlist.Visible = False
            Else
                tb = Base.DB.Table("Select Title,FromID,Content From SendMessage where CId=" & Sid, "SendMessage")
                If tb.Rows.Count > 0 Then
                    If msgTitle <> "" Then
                        Title.Text = "[转发] " & msgTitle
                    Else
                        Title.Text = "[转发] " & tb.Rows(0).Item(0)
                    End If
                    Content.Text = tb.Rows(0).Item(2)
                End If
                replyUser.Visible = False
                userlist.Visible = True
            End If
        End If
        ShowFileAttachment()            '显示附件
    End Sub

    Sub msgAutoSend(ByVal fid As Integer, ByVal where As Integer)
        Dim AttFolder As String = Server.MapPath("../../") & "\PersonalFolders\MessageAttachment\"
        Base.IO.CreateDir(AttFolder)

        Dim j As Integer = 0
        Dim i As Integer = 0
        Dim num As Integer = 0


        If where = 0 Then
            Dim UserStrings As String = ""
            Dim YGDM As Integer
            Dim userlist As String = ""
            For num = 0 To sendUserNames.Length - 1
                userlist += Base.GetUserNameByDLMC(sendUserNames(num)) & "(" & sendUserNames(num) & ");"
                UserStrings = UserStrings & sendUserNames(num) & ";"
            Next

            Dim datenow As String = System.DateTime.Now.ToString()

            For num = 0 To sendUserNames.Length - 1
                YGDM = Base.GetUserID(sendUserNames(num))
                Try
                    'msgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,toidlist) values('" & msgContent & "'," & UserID & ",''," & YGDM & ",getdate(),0," & Kind & ",'" & userlist & "');Select CId from SendMessage where Cid = @@IDENTITY")
                    If isgroup = 1 Then
                        msgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,isgroup) values('" & msgContent & "'," & UserID & ",''," & YGDM & ",'" & datenow & "',0," & Kind & "," & isgroup & ");Select CId from SendMessage where Cid = @@IDENTITY")
                    Else
                        msgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,isgroup) values('" & msgContent & "'," & UserID & ",''," & YGDM & ",getdate(),0," & Kind & "," & isgroup & ");Select CId from SendMessage where Cid = @@IDENTITY")
                    End If
                    If Kind = 5 Then Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],XMDM,[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (0," & XMDM & "," & YGDM & ",''," & UserID & ",0," & msgID & ")")
                    If fid <> -1 Then
                        Select Case Kind
                            Case 1          '表示是分发/修订
                                If CheckBox2.Checked = True Then            '限时回收
                                    Dim RCTime As Date = Now.AddDays(DropDownList1.SelectedValue)
                                    Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid,RcTime) VALUES (" & fid & "," & YGDM & ",''," & UserID & ",0," & msgID & ",'" & RCTime & "')")
                                Else
                                    Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & fid & "," & YGDM & ",''," & UserID & ",0," & msgID & ")")
                                End If
                            Case 2          '表示是审阅
                        End Select
                    End If

                    '写入附件文件
                    Base.IO.CreateDir(AttFolder & "\" & msgID & "\")
                    Dim Values As New ArrayList
                    Dim MyFiles As String()
                    MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
                    Values.AddRange(MyFiles)                            '//加入文件
                    Dim TmpFileName As String
                    For j = 0 To Values.Count - 1
                        TmpFileName = Values.Item(j).ToString.Replace(TempFolder & "\", "")
                        IO.File.Copy(TempFolder & "\" & TmpFileName, AttFolder & "\" & msgID & "\" & TmpFileName)
                        Base.DB.Query("insert into MessageAttachment(msgid,filepath) values(" & msgID & ",'" & Base.SqlFilter(TmpFileName) & "')")
                    Next
                Catch ex As Exception
                End Try
            Next


            ''写发送信息
            Try
                msgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,ToIdList) values('" & msgContent & "'," & UserID & ",'',0,getdate(),0," & Kind & ",'" & userlist & "');Select CId from SendMessage where Cid = @@IDENTITY")
                ''插分发/修订表
                Dim tmpfids As String() = Fids.Text.Split(",")
                For j = 0 To tmpfids.Length - 1
                    If tmpfids(j).ToString <> "" Then
                        fid = Convert.ToInt32(tmpfids(j).ToString)
                        If fid <> -1 Then
                            Select Case Kind
                                Case 1          '表示是分发/修订
                                    If CheckBox2.Checked = True Then            '限时回收
                                        Dim RCTime As Date = Now.AddDays(DropDownList1.SelectedValue)
                                        Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid,Rctime) VALUES (" & fid & ",0,''," & UserID & ",0," & msgID & ",'" & RCTime & "')")
                                    Else
                                        Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & fid & ",0,''," & UserID & ",0," & msgID & ")")
                                    End If
                                Case 2          '表示是审阅
                            End Select
                        End If
                    End If
                Next

                '写入附件文件
                Base.IO.CreateDir(AttFolder & "\" & msgID & "\")
                Dim Values As New ArrayList
                Dim MyFiles As String()
                MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
                Values.AddRange(MyFiles)                            '//加入文件
                Dim TmpFileName As String
                For i = 0 To Values.Count - 1
                    TmpFileName = Values.Item(i).ToString.Replace(TempFolder & "\", "")
                    IO.File.Move(TempFolder & "\" & TmpFileName, AttFolder & "\" & msgID & "\" & TmpFileName)
                    Base.DB.Query("insert into MessageAttachment(msgid,filepath) values(" & msgID & ",'" & Base.SqlFilter(TmpFileName) & "')")
                Next

            Catch ex As Exception

            End Try

            Try
                If Kind <> 0 Then
                    Dim tb As New DataTable
                    tb = Base.DB.Table("SELECT XX_XMJC.FID,Gy_MKXX.MKMC,GY_MKXX.XsnDir,GY_MKXX.MKDM,XX_XMJC.XMDM,[View] FROM XX_XMJC, GY_MKXX WHERE XX_XMJC.MKDM = GY_MKXX.MKDM AND (XX_XMJC.Fid = " & fid & ")", "XX_XMJC")
                    If tb.Rows.Count = 0 Then
                        Base.Js.alert(Me, "非法访问2")
                        Exit Sub
                    End If
                    Dim MKMC As String = tb.Rows(0).Item(1)
                    Dim FileName As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & "\" & fid & ".xml"
                    Dim TmpFileName As String = Server.MapPath("../../") & "\Submit_Temp\" & Login_User & "\" & fid & ".xml"
                    Dim xml As New System.Xml.XmlDocument
                    Try
                        xml.Load(FileName)
                        Dim namespaces As System.Xml.XmlNamespaceManager = Base.GetXmlNamespaceManager(xml)
                        xml.SelectSingleNode("//my:流程状态", namespaces).InnerXml = msgState
                        xml.SelectSingleNode("//my:备用7", namespaces).InnerText = UserStrings
                        xml.Save(FileName)
                    Catch ex As Exception
                        Response.Write("XML不存在！")
                        Response.End()
                    End Try


                    Try
                        xml.Load(TmpFileName)
                        Dim namespaces As System.Xml.XmlNamespaceManager = Base.GetXmlNamespaceManager(xml)
                        xml.SelectSingleNode("//my:流程状态", namespaces).InnerXml = msgState
                        xml.SelectSingleNode("//my:备用7", namespaces).InnerText = UserStrings
                        xml.Save(FileName)

                    Catch ex As Exception
                        Response.Write("XML不存在！")
                        Response.End()
                    End Try


                    'xml.Load(TmpFileName)
                    'namespaces = Base.GetXmlNamespaceManager(xml)
                    'xml.SelectSingleNode("//my:备用4", namespaces).InnerXml = msgState
                    'xml.Save(TmpFileName)
                    FormInfo.SubmitForm(fid)
                    'Base.SynSubmit(fid, "提交")   '同步表单状态到数据库状态
                End If
            Catch ex As Exception
                Response.Write(ex.ToString)
                Response.End()
            End Try


            Base.Js.closestr(Me, "已成功发送给：" + userlist + "")

        Else
            Dim tmpDepartmentName As String
            Dim ksdm As String

            tmpDepartmentName = sendBm
            ksdm = Base.GetKSDM(tmpDepartmentName)
            'YGDM = Base.GetUserID(tmpDepartmentName)
            Try
                msgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,toksdm,SendDate,LookFlag,msgkind,bz) values('" & msgContent & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & ksdm & ",getdate(),0," & Kind & ",'由" & Base.GetUserName(UserID, 2) & "发送至" & tmpDepartmentName & "');Select CId from SendMessage where Cid = @@IDENTITY")
                If Kind = 5 Then Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],XMDM,[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (0," & XMDM & "," & ksdm & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & msgID & ")")
                ''插分发/修订表
                If fid <> -1 Then
                    Select Case Kind
                        Case 1          '表示是分发/修订
                            If CheckBox2.Checked = True Then            '限时回收
                                Dim RCTime As Date = Now.AddDays(DropDownList1.SelectedValue)
                                Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid,RcTime) VALUES (" & fid & "," & ksdm & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & msgID & ",'" & RCTime & "')")
                            Else
                                Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & fid & "," & ksdm & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & msgID & ")")
                            End If
                        Case 2          '表示是审阅
                    End Select
                End If

                '写入附件文件
                Base.IO.CreateDir(AttFolder & "\" & msgID & "\")
                Dim Values As New ArrayList
                Dim MyFiles As String()
                MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
                Values.AddRange(MyFiles)                            '//加入文件
                Dim TmpFileName As String
                For j = 0 To Values.Count - 1
                    TmpFileName = Values.Item(j).ToString.Replace(TempFolder & "\", "")
                    IO.File.Copy(TempFolder & "\" & TmpFileName, AttFolder & "\" & msgID & "\" & TmpFileName)
                    Base.DB.Query("insert into MessageAttachment(msgid,filepath) values(" & msgID & ",'" & Base.SqlFilter(TmpFileName) & "')")
                Next
            Catch ex As Exception
            End Try

            ''写发送信息
            Try
                msgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,toksdm,SendDate,LookFlag,msgkind) values('" & msgContent & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "',0,getdate(),0," & Kind & ");Select CId from SendMessage where Cid = @@IDENTITY")
                ''插分发/修订表
                If fid <> -1 Then
                    Select Case Kind
                        Case 1          '表示是分发/修订
                            If CheckBox2.Checked = True Then            '限时回收
                                Dim RCTime As Date = Now.AddDays(DropDownList1.SelectedValue)
                                Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid,Rctime) VALUES (" & fid & ",0,'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & msgID & ",'" & RCTime & "')")
                            Else
                                Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & fid & ",0,'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & msgID & ")")
                            End If
                        Case 2          '表示是审阅
                    End Select
                End If



                '写入附件文件
                Base.IO.CreateDir(AttFolder & "\" & msgID & "\")
                Dim Values As New ArrayList
                Dim MyFiles As String()
                MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
                Values.AddRange(MyFiles)                            '//加入文件
                Dim TmpFileName As String
                For i = 0 To Values.Count - 1
                    TmpFileName = Values.Item(i).ToString.Replace(TempFolder & "\", "")
                    IO.File.Move(TempFolder & "\" & TmpFileName, AttFolder & "\" & msgID & "\" & TmpFileName)
                    Base.DB.Query("insert into MessageAttachment(msgid,filepath) values(" & msgID & ",'" & Base.SqlFilter(TmpFileName) & "')")
                Next

            Catch ex As Exception

            End Try

            If msgState <> "" And msgState <> "undefined" Then
                Dim tb As New DataTable
                tb = Base.DB.Table("SELECT XX_XMJC.FID,Gy_MKXX.MKMC,GY_MKXX.XsnDir,GY_MKXX.MKDM,XX_XMJC.XMDM,[View] FROM XX_XMJC, GY_MKXX WHERE XX_XMJC.MKDM = GY_MKXX.MKDM AND (XX_XMJC.Fid = " & fid & ")", "XX_XMJC")
                If tb.Rows.Count = 0 Then
                    Base.Js.alert(Me, "非法访问3")
                    Exit Sub
                End If
                Dim MKMC As String = tb.Rows(0).Item(1)
                Dim FileName As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & "\" & fid & ".xml"
                Dim TmpFileName As String = Server.MapPath("../../") & "\Submit_Temp\" & Login_User & "\" & fid & ".xml"
                Dim xml As New System.Xml.XmlDocument
                Try
                    xml.Load(FileName)
                Catch ex As Exception
                    Response.Write("XML不存在！")

                End Try
                Dim namespaces As System.Xml.XmlNamespaceManager = Base.GetXmlNamespaceManager(xml)
                xml.SelectSingleNode("//my:流程状态", namespaces).InnerXml = msgState
                xml.Save(FileName)

                'xml.Load(TmpFileName)
                'namespaces = Base.GetXmlNamespaceManager(xml)
                'xml.SelectSingleNode("//my:备用4", namespaces).InnerXml = msgState
                'xml.Save(TmpFileName)
                FormInfo.SubmitForm(fid)
                'Base.SynSubmit(fid, "提交")   '同步表单状态到数据库状态
            End If
            Base.Js.closestr(Me, "已成功发送至部门：" & tmpDepartmentName & "")

        End If

    End Sub

    Protected Sub Button1_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles Button1.Click, Button5.Click

        If Title.Text.Trim.Length = 0 Then
            Base.Js.alert(Me, "主题不能为空")
            Exit Sub
        End If
        If Title.Text.Trim.Length > 500 Then
            Base.Js.alert(Me, "主题内容不能大于500个字符")
            Exit Sub
        End If
        If Content.Text.Trim.Length = 0 Then
            Content.Text = "空"
        End If
        If Content.Text.Trim.Length > 5000 Then
            Base.Js.alert(Me, "正文内容不能大于5000个字符")
            Exit Sub
        End If

        If isreply = False Then '不是回复时 收件人不能为空
            If userlist.Value.Trim.Length = 0 Then
                Base.Js.alert(Me, "收件人不能为空")
                Exit Sub
            End If
        End If

        Dim YGDM, FID As Integer
        Dim IdList As String

        If isreply = True Then
            IdList = replyUser.InnerHtml
        Else
            IdList = userlist.Value
        End If


        Dim tmp As String()         '用户组
        tmp = IdList.Split(";")
        Dim idx As Integer
        Dim i, j As Integer
        Dim MsgID As Integer

        Dim AttFolder As String = Server.MapPath("../../") & "\PersonalFolders\MessageAttachment\"
        Base.IO.CreateDir(AttFolder)

        If Me.RadioButtonList1.SelectedValue = "0" Then '如果是选择用户发送
            Dim datenow As String = System.DateTime.Now.ToString()
            Dim TmpUserName As String
            Dim UserStrings As String = ""
            For i = 0 To tmp.Length - 2
                TmpUserName = tmp(i).ToString.Trim
                idx = TmpUserName.LastIndexOf("(")
                If idx > 0 Then
                    TmpUserName = TmpUserName.Substring(idx + 1).Replace(")", "")
                    YGDM = Base.GetUserID(TmpUserName)
                    UserStrings = UserStrings & TmpUserName & ";"
                    Try

                        If isgroup = 1 Then

                            MsgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,isgroup) values('" & Base.SqlFilter(Title.Text) & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & YGDM & ",'" & datenow & "',0," & Kind & "," & isgroup & ");Select CId from SendMessage where Cid = @@IDENTITY")
                        Else
                            MsgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,isgroup) values('" & Base.SqlFilter(Title.Text) & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & YGDM & ",getdate(),0," & Kind & "," & isgroup & ");Select CId from SendMessage where Cid = @@IDENTITY")
                        End If


                        If CheckBox1.Checked = False Then        '表示不是密送
                            Base.DB.Query("Update SendMessage set ToIDList='" & Base.SqlFilter(IdList) & "' where Cid=" & MsgID)
                        End If
                        If Kind = 5 Then Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],XMDM,[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (0," & XMDM & "," & YGDM & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ")")
                        ''插分发/修订表
                        Dim tmpfids As String() = Fids.Text.Split(",")
                        For j = 0 To tmpfids.Length - 1
                            If tmpfids(j).ToString <> "" Then
                                FID = Convert.ToInt32(tmpfids(j).ToString)
                                If FID <> -1 Then
                                    Select Case Kind
                                        Case 1          '表示是分发/修订
                                            If CheckBox2.Checked = True Then            '限时回收
                                                Dim RCTime As Date = Now.AddDays(DropDownList1.SelectedValue)
                                                Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid,RcTime) VALUES (" & FID & "," & YGDM & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ",'" & RCTime & "')")
                                            Else
                                                Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & FID & "," & YGDM & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ")")
                                            End If
                                        Case 2          '表示是审阅
                                    End Select
                                End If
                            End If
                        Next
                        '写入附件文件
                        Base.IO.CreateDir(AttFolder & "\" & MsgID & "\")
                        Dim Values As New ArrayList
                        Dim MyFiles As String()
                        MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
                        Values.AddRange(MyFiles)                            '//加入文件
                        Dim TmpFileName As String
                        For j = 0 To Values.Count - 1
                            TmpFileName = Values.Item(j).ToString.Replace(TempFolder & "\", "")
                            IO.File.Copy(TempFolder & "\" & TmpFileName, AttFolder & "\" & MsgID & "\" & TmpFileName)
                            Base.DB.Query("insert into MessageAttachment(msgid,filepath) values(" & MsgID & ",'" & Base.SqlFilter(TmpFileName) & "')")
                        Next
                    Catch ex As Exception
                        Response.Write(ex.ToString)
                    End Try
                Else
                    '非法用户ID
                End If
            Next

            ''写发送信息
            Try
                If isgroup = 1 Then
                    MsgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,ToIdList,isgroup) values('" & Base.SqlFilter(Title.Text) & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "',0,'" & datenow & "',0," & Kind & ",'" & Base.SqlFilter(IdList) & "'," & isgroup & ");Select CId from SendMessage where Cid = @@IDENTITY")
                Else
                    MsgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,ToIdList,isgroup) values('" & Base.SqlFilter(Title.Text) & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "',0,getdate(),0," & Kind & ",'" & Base.SqlFilter(IdList) & "'," & isgroup & ");Select CId from SendMessage where Cid = @@IDENTITY")
                End If

                ''插分发/修订表
                Dim tmpfids As String() = Fids.Text.Split(",")
                For j = 0 To tmpfids.Length - 1
                    If tmpfids(j).ToString <> "" Then
                        FID = Convert.ToInt32(tmpfids(j).ToString)
                        If FID <> -1 Then
                            Select Case Kind
                                Case 1          '表示是分发/修订
                                    If CheckBox2.Checked = True Then            '限时回收
                                        Dim RCTime As Date = Now.AddDays(DropDownList1.SelectedValue)
                                        Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid,Rctime) VALUES (" & FID & ",0,'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ",'" & RCTime & "')")
                                    Else
                                        Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & FID & ",0,'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ")")
                                    End If
                                Case 2          '表示是审阅
                            End Select
                        End If
                    End If
                Next

                '写入附件文件
                Base.IO.CreateDir(AttFolder & "\" & MsgID & "\")
                Dim Values As New ArrayList
                Dim MyFiles As String()
                MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
                Values.AddRange(MyFiles)                            '//加入文件
                Dim TmpFileName As String
                For i = 0 To Values.Count - 1
                    TmpFileName = Values.Item(i).ToString.Replace(TempFolder & "\", "")
                    IO.File.Move(TempFolder & "\" & TmpFileName, AttFolder & "\" & MsgID & "\" & TmpFileName)
                    Base.DB.Query("insert into MessageAttachment(msgid,filepath) values(" & MsgID & ",'" & Base.SqlFilter(TmpFileName) & "')")
                Next

            Catch ex As Exception

            End Try

            Try
                If Kind <> 0 Then


                    Dim tb As New DataTable
                    tb = Base.DB.Table("SELECT XX_XMJC.FID,Gy_MKXX.MKMC,GY_MKXX.XsnDir,GY_MKXX.MKDM,XX_XMJC.XMDM,[View] FROM XX_XMJC, GY_MKXX WHERE XX_XMJC.MKDM = GY_MKXX.MKDM AND (XX_XMJC.Fid = " & FID & ")", "XX_XMJC")
                    If tb.Rows.Count = 0 Then
                        Base.Js.alert(Me, "非法访问4")
                        Exit Sub
                    End If
                    Dim MKMC As String = tb.Rows(0).Item(1)
                    Dim FileName As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & "\" & FID & ".xml"
                    Dim TmpFileName As String = Server.MapPath("../../") & "\Submit_Temp\" & Login_User & "\" & FID & ".xml"
                    Dim xml As New System.Xml.XmlDocument
                    Try
                        xml.Load(FileName)
                    Catch ex As Exception
                        Response.Write("XML不存在！")
                        Response.End()
                    End Try
                    Dim namespaces As System.Xml.XmlNamespaceManager = Base.GetXmlNamespaceManager(xml)
                    xml.SelectSingleNode("//my:流程状态", namespaces).InnerXml = msgState
                    xml.SelectSingleNode("//my:备用7", namespaces).InnerText = UserStrings
                    xml.Save(FileName)

                    'xml.Load(TmpFileName)
                    'namespaces = Base.GetXmlNamespaceManager(xml)
                    'xml.SelectSingleNode("//my:备用4", namespaces).InnerXml = msgState
                    'xml.Save(TmpFileName)
                    FormInfo.SubmitForm(FID)
                    'Base.SynSubmit(FID, "提交")   '同步表单状态到数据库状态
                End If

            Catch ex As Exception

                Response.Write(ex.ToString())
                Response.End()
            End Try


            Base.Js.closestr(Me, "操作成功")

            '对选中的名单进行一一的插表
            'Cid = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag) values('" & Base.SqlFilter(Title.Text) & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & CheckBoxList1.Items(i).Value & ",'" & Date.Now & "',0);Select CId from SendMessage where Cid = @@IDENTITY")
            'Base.DB.Query("INSERT INTO [DesktopMessage] ([YGDM],[DTitle],[Dkind],[DKID]) VALUES(" & IdList & ",'" & Base.SqlFilter(Title.Text) & "','短消息'," & Cid & " )")
            'Base.Js.WriteScript(Me, "opener.window.parent.MessageBox('操作成功','短消息已经发送成功');var url = opener.window.location.href;opener.window.location.href=url;window.close();")
        Else
            Dim tmpDepartmentName As String
            Dim ksdm As String
            For i = 0 To tmp.Length - 2
                tmpDepartmentName = tmp(i).ToString.Trim
                ksdm = Base.GetKSDM(tmpDepartmentName)
                'YGDM = Base.GetUserID(tmpDepartmentName)
                Try
                    MsgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,toksdm,SendDate,LookFlag,msgkind,bz) values('" & Base.SqlFilter(Title.Text) & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & ksdm & ",getdate(),0," & Kind & ",'由" & Base.GetUserName(UserID, 2) & "发送至" & tmpDepartmentName & "');Select CId from SendMessage where Cid = @@IDENTITY")
                    If CheckBox1.Checked = False Then        '表示不是密送
                        Base.DB.Query("Update SendMessage set ToIDList='" & Base.SqlFilter(IdList) & "' where Cid=" & MsgID)
                    End If
                    If Kind = 5 Then Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],XMDM,[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (0," & XMDM & "," & ksdm & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ")")
                    ''插分发/修订表
                    Dim tmpfids As String() = Fids.Text.Split(",")
                    For j = 0 To tmpfids.Length - 1
                        If tmpfids(j).ToString <> "" Then
                            FID = Convert.ToInt32(tmpfids(j).ToString)
                            If FID <> -1 Then
                                Select Case Kind
                                    Case 1          '表示是分发/修订
                                        If CheckBox2.Checked = True Then            '限时回收
                                            Dim RCTime As Date = Now.AddDays(DropDownList1.SelectedValue)
                                            Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid,RcTime) VALUES (" & FID & "," & ksdm & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ",'" & RCTime & "')")
                                        Else
                                            Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & FID & "," & ksdm & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ")")
                                        End If
                                    Case 2          '表示是审阅
                                End Select
                            End If
                        End If
                    Next
                    '写入附件文件
                    Base.IO.CreateDir(AttFolder & "\" & MsgID & "\")
                    Dim Values As New ArrayList
                    Dim MyFiles As String()
                    MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
                    Values.AddRange(MyFiles)                            '//加入文件
                    Dim TmpFileName As String
                    For j = 0 To Values.Count - 1
                        TmpFileName = Values.Item(j).ToString.Replace(TempFolder & "\", "")
                        IO.File.Copy(TempFolder & "\" & TmpFileName, AttFolder & "\" & MsgID & "\" & TmpFileName)
                        Base.DB.Query("insert into MessageAttachment(msgid,filepath) values(" & MsgID & ",'" & Base.SqlFilter(TmpFileName) & "')")
                    Next
                Catch ex As Exception
                End Try

            Next

            ''写发送信息
            Try
                MsgID = Base.DB.ExeScalar("insert into SendMessage(Title,FromID,Content,toksdm,SendDate,LookFlag,msgkind,ToIdList) values('" & Base.SqlFilter(Title.Text) & "'," & UserID & ",'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "',0,getdate(),0," & Kind & ",'" & Base.SqlFilter(IdList) & "');Select CId from SendMessage where Cid = @@IDENTITY")
                ''插分发/修订表
                Dim tmpfids As String() = Fids.Text.Split(",")
                For j = 0 To tmpfids.Length - 1
                    If tmpfids(j).ToString <> "" Then
                        FID = Convert.ToInt32(tmpfids(j).ToString)
                        If FID <> -1 Then
                            Select Case Kind
                                Case 1          '表示是分发/修订
                                    If CheckBox2.Checked = True Then            '限时回收
                                        Dim RCTime As Date = Now.AddDays(DropDownList1.SelectedValue)
                                        Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid,Rctime) VALUES (" & FID & ",0,'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ",'" & RCTime & "')")
                                    Else
                                        Base.DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[KSDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & FID & ",0,'" & Server.HtmlEncode(Base.SqlFilter(Content.Text)) & "'," & UserID & ",0," & MsgID & ")")
                                    End If
                                Case 2          '表示是审阅
                            End Select
                        End If
                    End If
                Next

                '写入附件文件
                Base.IO.CreateDir(AttFolder & "\" & MsgID & "\")
                Dim Values As New ArrayList
                Dim MyFiles As String()
                MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
                Values.AddRange(MyFiles)                            '//加入文件
                Dim TmpFileName As String
                For i = 0 To Values.Count - 1
                    TmpFileName = Values.Item(i).ToString.Replace(TempFolder & "\", "")
                    IO.File.Move(TempFolder & "\" & TmpFileName, AttFolder & "\" & MsgID & "\" & TmpFileName)
                    Base.DB.Query("insert into MessageAttachment(msgid,filepath) values(" & MsgID & ",'" & Base.SqlFilter(TmpFileName) & "')")
                Next

            Catch ex As Exception

            End Try

            If msgState <> "" And msgState <> "undefined" Then
                Dim tb As New DataTable
                tb = Base.DB.Table("SELECT XX_XMJC.FID,Gy_MKXX.MKMC,GY_MKXX.XsnDir,GY_MKXX.MKDM,XX_XMJC.XMDM,[View] FROM XX_XMJC, GY_MKXX WHERE XX_XMJC.MKDM = GY_MKXX.MKDM AND (XX_XMJC.Fid = " & FID & ")", "XX_XMJC")
                If tb.Rows.Count = 0 Then
                    Base.Js.alert(Me, "非法访问1")
                    Exit Sub
                End If
                Dim MKMC As String = tb.Rows(0).Item(1)
                Dim FileName As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & "\" & FID & ".xml"
                Dim TmpFileName As String = Server.MapPath("../../") & "\Submit_Temp\" & Login_User & "\" & FID & ".xml"
                Dim xml As New System.Xml.XmlDocument
                Try
                    xml.Load(FileName)
                Catch ex As Exception
                    Response.Write("XML不存在！")
                    Response.End()
                End Try
                Dim namespaces As System.Xml.XmlNamespaceManager = Base.GetXmlNamespaceManager(xml)
                xml.SelectSingleNode("//my:流程状态", namespaces).InnerXml = msgState
                xml.Save(FileName)

                'xml.Load(TmpFileName)
                'namespaces = Base.GetXmlNamespaceManager(xml)
                'xml.SelectSingleNode("//my:备用4", namespaces).InnerXml = msgState
                'xml.Save(TmpFileName)
                FormInfo.SubmitForm(FID)
                'Base.SynSubmit(FID, "提交")   '同步表单状态到数据库状态
            End If

            Base.Js.closestr(Me, "操作成功")



        End If


    End Sub

    

    'Protected Sub GridView1_DataBound(ByVal sender As Object, ByVal e As System.EventArgs) Handles GridView1.DataBound
    '    Dim i, j, FID As Integer
    '    Dim FileName As String
    '    Dim ShowTb As New Data.DataTable
    '    ShowTb = Base.DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")

    '    For i = 0 To GridView1.Rows.Count - 1
    '        GridView1.Rows(i).Attributes.Add("onmouseover", "OnMouseOver(this)")
    '        GridView1.Rows(i).Attributes.Add("onmouseout", "OnMouseOut(this)")
    '        GridView1.Rows(i).Attributes.Add("OnDblClick", "DbClickEvent(" & GridView1.DataKeys(i).Item(0) & ");")

    '        FID = GridView1.DataKeys(i).Item(0)
    '        FileName = BaseUrl & FID & ".xml"

    '        If Base.XmlClass.GetXmlFile(FileName) Is Nothing Then
    '            '表示找不到记录，则显示空记录
    '            For j = 0 To ShowTb.Rows.Count - 1
    '                GridView1.Rows(i).Cells(j).Text = "空"
    '            Next
    '        Else
    '            '再列自定义的列
    '            For j = 0 To ShowTb.Rows.Count - 1
    '                Dim dd As System.Xml.XmlNode = Base.XmlClass.FindNode("//" & ShowTb.Rows(j).Item(1).ToString.Replace("<", "").Replace(">", ""))
    '                If dd Is Nothing Then
    '                    GridView1.Rows(i).Cells(j).Text = "空"
    '                Else
    '                    If dd.ChildNodes.Item(0) Is Nothing Then
    '                        GridView1.Rows(i).Cells(j).Text = "空"
    '                    Else
    '                        If dd.ChildNodes.Item(0).Value Is Nothing Then
    '                            If dd.HasChildNodes = True Then     '当是父节点.但是存在子节点时.则显示子节点的内容(或是超文本框)
    '                                Dim TempOut As String = dd.ChildNodes.Item(0).OuterXml.ToString.Trim
    '                                If TempOut.Length >= 100 Then
    '                                    GridView1.Rows(i).Cells(j).Text = Server.HtmlEncode(TempOut.Substring(0, 98)) & "..."
    '                                Else
    '                                    GridView1.Rows(i).Cells(j).Text = Server.HtmlEncode(TempOut)
    '                                End If
    '                            Else
    '                                GridView1.Rows(i).Cells(j).Text = "空"
    '                            End If
    '                        Else
    '                            If dd.ChildNodes.Item(0).Value.ToString.Trim.Length >= 100 Then
    '                                GridView1.Rows(i).Cells(j).Text = Server.HtmlEncode(dd.ChildNodes.Item(0).Value.ToString.Substring(0, 98)) & "..."
    '                            Else
    '                                GridView1.Rows(i).Cells(j).Text = Server.HtmlEncode(dd.ChildNodes.Item(0).Value)
    '                            End If
    '                        End If
    '                    End If
    '                End If
    '            Next
    '        End If
    '    Next
    '    GridView1.Columns(GridView1.Columns.Count - 1).Visible = False
    'End Sub



    'Protected Sub GridView1_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles GridView1.SelectedIndexChanged

    'End Sub

    Protected Sub Button2_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles Button2.Click
        '文件上传功能,大小为1M
        Dim TempFolder As String = "../../" & "PersonalFolders/" & Login_User & "/临时附件文件夹"
        Base.pub.CreateDir(Server.MapPath(TempFolder))

        If FileUpload1.PostedFile.ContentLength = 0 Then Exit Sub
        Base.Upload.Sizes = 1000 * 1024
        Base.Upload.Path = TempFolder
        Dim FileType As String = Base.GetSystemParameters("UpLoad_Filter")
        If FileType Is Nothing Then FileType = "空"
        Base.Upload.FileType = FileType
        Base.Upload.ReWriteFlag = True
        If Base.Upload.FileSaveAs(FileUpload1) = True Then
            ShowFileAttachment()
            'Base.Js.alert(Me, "上传成功")
        Else
            Base.Js.alert(Me, Base.Upload.ReturnMessage)
        End If
    End Sub

    Sub ShowFileAttachment()
        Dim DelUrl As String = "?sel="
        filelist.InnerHtml = Base.ShowFileAttachment(TempFolder, DelUrl)
    End Sub

    Protected Sub RadioButtonList1_SelectedIndexChanged(ByVal sender As Object, ByVal e As System.EventArgs) Handles RadioButtonList1.SelectedIndexChanged
        If RadioButtonList1.SelectedItem.Value = "0" Then
            userlist.InnerText = ""
            iframe1.Attributes("src") = "../Dialog/UserListDialog.aspx?obj=userlist&bm=" & bm
        ElseIf RadioButtonList1.SelectedItem.Value = "1" Then
            userlist.InnerText = ""
            iframe1.Attributes("src") = "../Dialog/DepartmentListDialog.aspx?obj=userlist&bm=" & bm
        End If
    End Sub
End Class
