Imports System.Data
Imports System.IO
Imports System.Xml

Public Class Base
    Inherits System.Web.UI.Page
    Public pub As New Pub
    Public Js As New JsClass
    Public Upload As New FileUpload
    Public DB As New SunFun.DBClass
    Public XmlClass As New SunFun.Xmlclass
    Public IO As New SunFun.IOClass
    Public EnCrypt As New SunFun.EnCrypt
    Private _ErrMessage As String       '当做所有函数中,返回的错误信息
    Public LicenseKey As String = pub.GetWebConfig("SunfunSoft.Xman.LicenseKey")            '得到序列号

    Sub New()
        DB.db_new(pub.GetConnectionString("Conn"))
        _ErrMessage = String.Empty
    End Sub


    ''' <summary>
    ''' 保存错误日志功能。
    ''' </summary>
    ''' <param name="dept"></param>
    ''' <param name="ErrStr"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function SaveErrLog(ByVal dept As Integer, ByVal ErrStr As String)
        Dim FileName As String
        Select Case dept
            Case 1
                FileName = Server.MapPath("../")
            Case 2
                FileName = Server.MapPath("../../")
            Case 3
                FileName = Server.MapPath("../../../")
            Case Else
                FileName = Server.MapPath("./")
        End Select
        FileName += "Submit_Temp\ErrLog" & Now.ToString("yyyy-mm-dd") & ".txt"
        Using sw As IO.StreamWriter = New IO.StreamWriter(FileName, True, System.Text.Encoding.UTF8)
            sw.Write(Date.Now.ToString & " " & ErrStr & vbCrLf)
            sw.Close()
        End Using
        Return True
    End Function

    ''' <summary>
    ''' 核对用户信息
    ''' </summary>
    ''' <param name="username">用户名</param>
    ''' <param name="password">密码</param>
    ''' <returns>是否正确</returns>
    ''' <remarks></remarks>
    Function CheckUserInfo(ByVal username As String, ByVal password As String) As Boolean
        Dim sqlstr As String
        sqlstr = "SELECT YGDM,DLMC FROM GY_YGDM Where DLMC='" & SqlFilter(username) & "' and DLPWD='" & EnCrypt.MD5(SqlFilter(password)) & "' and QYBZ=1"

        Dim dt As New DataTable
        dt = DB.Table(sqlstr, "dd")

        If dt.Rows.Count > 0 Then
            Return True
        Else
            Return False
        End If
    End Function


    Function GetXmlNamespaceManager_lct(ByVal xmlDoc As XmlDocument) As XmlNamespaceManager

        Dim names As XmlNamespaceManager = New XmlNamespaceManager(xmlDoc.NameTable)
        names.AddNamespace("v", "urn:schemas-microsoft-com:vml")
        names.AddNamespace("w", "http://schemas.openxmlformats.org/wordprocessingml/2006/main")
        names.AddNamespace("pkg", "http://schemas.microsoft.com/office/2006/xmlPackage")
        names.AddNamespace("o", "urn:schemas-microsoft-com:office:office")
        Return names
    End Function

    ''' <summary>
    ''' 返回附件文件列表,处于编辑状态，可以进行移除操作
    ''' </summary>
    ''' <param name="TempFolder"></param>
    ''' <param name="DelUrl"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function ShowFileAttachment(ByVal TempFolder As String, ByVal DelUrl As String) As String
        Dim TempTable As New Data.DataTable
        Dim Tmp As String
        Dim i As Integer

        Dim Values As New ArrayList
        Dim MyFiles As String()
        MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
        Values.AddRange(MyFiles)                            '//加入文件

        Dim TmpFileName As String
        Dim TmpFileType As String
        Tmp = "<table  cellpadding='1' cellspacing='4' border=0 style='color:Black;background-color:#eeeeee;font-size:9pt;width:98%;'>"
        For i = 0 To Values.Count - 1
            Dim FileInfo As New System.IO.FileInfo(Values.Item(i))
            Dim FileSize As Integer
            FileSize = FileInfo.Length
            If FileSize > 0 Then
                FileSize = FileSize \ 1024
                If FileSize = 0 Then FileSize = 1
            End If
            TmpFileName = Values.Item(i).ToString.Replace(TempFolder & "\", "")
            TmpFileType = TmpFileName.Substring(TmpFileName.LastIndexOf("."))
            Tmp = Tmp & "<tr><td width=18><img src='../../" & Me.GetFileTypeImg(TmpFileType) & "'></td><td>" & FileInfo.Name & "&nbsp;(" & FileSize & "K)&nbsp;&nbsp;&nbsp;<a href='" & DelUrl & Server.UrlDecode(FileInfo.Name) & "'>移除</a></td></tr>"
        Next
        Tmp = Tmp & "</table>"
        Return Tmp.ToString()
    End Function



    ''' <summary>
    ''' 显示附件列表，只为打开
    ''' </summary>
    ''' <param name="TempFolder"></param>
    ''' <param name="MessageId"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function ShowFileAttachment_Open(ByVal TempFolder As String, ByVal MessageId As Integer) As String
        Dim TempTable As New Data.DataTable
        Dim Tmp As String = ""
        Dim i As Integer
        If System.IO.Directory.Exists(TempFolder) = False Then Return ""

        Dim Values As New ArrayList
        Dim MyFiles As String()
        MyFiles = Directory.GetFiles(TempFolder)          '//得到该目录下所有文件
        Values.AddRange(MyFiles)                            '//加入文件

        Dim TmpFileName As String
        Dim TmpFileType As String
        Tmp += "<table border='0' cellpadding='2' cellspacing='0' width='100%' runat='server'>"
        Tmp += "<tr><td style='background-color:#E0ECF9; height:30px;'>&nbsp;&nbsp;文件附件&nbsp;(" & Values.Count & ")</td></tr>"
        Tmp += "<tr><td style='background-color:#E0ECF9;'>"
        Tmp += "<table border='0' cellpadding='0' cellspacing='0' width='100%'>"
        Tmp += "<tr><td style='background-color:White;'>"
        Tmp += "<table  cellpadding='1' cellspacing='4' border=0 style='color:Black;background-color:white;font-size:9pt;width:98%;'>"
        If Values.Count = 0 Then Return "" '表示为空
        For i = 0 To Values.Count - 1
            Dim FileInfo As New System.IO.FileInfo(Values.Item(i))
            Dim FileSize As Integer
            FileSize = FileInfo.Length
            If FileSize > 0 Then
                FileSize = FileSize \ 1024
                If FileSize = 0 Then FileSize = 1
            End If
            TmpFileName = Values.Item(i).ToString.Replace(TempFolder & "\", "")
            TmpFileType = TmpFileName.Substring(TmpFileName.LastIndexOf("."))
            'Tmp = Tmp & "<tr><td width=18><img src='../../" & Me.GetFileTypeImg(TmpFileType) & "'></td><td>" & FileInfo.Name & "&nbsp;(" & FileSize & "K)&nbsp;&nbsp;&nbsp;<a href='../Personbag/OpenFile.aspx?FileName=" & Server.UrlEncode("\MessageAttachment\" & MessageId & "\" & FileInfo.Name) & "'>打开</a></td></tr>"
            Tmp = Tmp & "<tr><td width=18><img src='../../" & Me.GetFileTypeImg(TmpFileType) & "'></td><td>" & FileInfo.Name & "&nbsp;(" & FileSize & "K)&nbsp;&nbsp;&nbsp;<a href='../Personbag/OpenFile.aspx?FileName=" & i & "&msgID=" & MessageId & "'>打开</a>&nbsp;&nbsp;&nbsp;<a href='#' onclick='savetomyfile(" & i & "," & MessageId & ")'>存至我的文件</a></td></tr>"
        Next
        Tmp += "</table>"
        Tmp += "</td></tr>"
        Tmp += "</table>"
        Tmp += "</td></tr>"
        Tmp += "</table>"
        Return Tmp.ToString()
    End Function


    ''' <summary>
    ''' 返回公共配置的信息
    ''' </summary>
    ''' <param name="Op"></param>
    ''' <param name="LCDM"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function ReadConfig(ByVal Op As String, ByVal LCDM As String) As String
        Dim Row As Data.DataRow
        Try
            Row = DB.Row("Select value From Xconfig Where Config ='" & Op & "' and LCDM=" & LCDM, "dd")
        Catch ex As Exception
            Row = Nothing
        End Try
        If Not Row Is Nothing Then
            Return Row.Item("value").ToString.Trim
        Else
            Return ""
        End If
    End Function

    ''' <summary>
    ''' 根据文件类型返回相应的图标
    ''' </summary>
    ''' <param name="FileType"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetFileTypeImg(ByVal FileType As String) As String
        Dim ResultPath As String = "images/FileManage/"
        Dim Result As String
        FileType = FileType.ToLower
        Select Case FileType
            Case ".doc"
                Result = "DOC.GIF"
            Case ".txt"
                Result = "TXT.GIF"
            Case ".zip"
                Result = "ZIP.GIF"
            Case ".rar"
                Result = "ZIP.GIF"
            Case ".xls"
                Result = "XLS.GIF"
            Case ".pic"
                Result = "PIC.GIF"
            Case ".gif"
                Result = "PIC.GIF"
            Case ".bmp"
                Result = "PIC.GIF"
            Case ".jpg"
                Result = "PIC.GIF"
            Case ".ppt"
                Result = "PPT.GIF"
            Case ".pdf"
                Result = "pdf.gif"
            Case ".wav"
                Result = "WAV.GIF"
            Case ".mdb"
                Result = "MDB.GIF"
            Case ".mpg"
                Result = "MPG.GIF"
            Case Else
                Result = "other.gif"
        End Select
        Return ResultPath & Result
    End Function

#Region "用户详细信息同步模块"


    ''' <summary>
    ''' 将用户信息同步到XML文件中去，为了兼容，因为再写一下函数
    ''' </summary>
    ''' <param name="UserID"></param>
    ''' <param name="BaseTopDept"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function UpdateUserContent(ByVal UserID As Integer, ByVal BaseTopDept As Integer) As String
        Return UpdateUserContent(UserID, BaseTopDept, False)
    End Function


    ''' <summary>
    ''' 根据保存的SQL文件生成表结构，主要应用于增加了表，但是在升级过程中需要手工同步表的问题。
    ''' </summary>
    ''' <param name="BaseTopDept"></param>
    ''' <param name="TableName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CreateTable(ByVal BaseTopDept As Integer, ByVal TableName As String) As Boolean
        Dim BaseTop As String
        Select Case BaseTopDept
            Case 1
                BaseTop = HttpContext.Current.Server.MapPath("../")
            Case 2
                BaseTop = HttpContext.Current.Server.MapPath("../../")
            Case Else
                BaseTop = HttpContext.Current.Server.MapPath("./")
        End Select
        Dim SqlFile As String = BaseTop & "\SqlText\" & TableName & ".sql"
        Dim TmpSql As String
        If System.IO.File.Exists(SqlFile) = True Then
            TmpSql = IO.Text_File_Read(SqlFile)
            DB.ExeSql(TmpSql)
        Else
            Return False
        End If
        Return True
    End Function

    ''' <summary>
    ''' 将用户信息同步到XML文件小去。
    ''' </summary>
    ''' <param name="UserID">用户ID</param>
    ''' <param name="BaseTopDept">深度</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function UpdateUserContent(ByVal UserID As Integer, ByVal BaseTopDept As Integer, ByVal WriteFlag As Boolean) As String
        Dim TmpYGDM As Integer = UserID

        Dim XsnDir As String = "XMAN-YGDM"          '设置模板名称
        Dim BaseTop As String = ""
        Select Case BaseTopDept
            Case 1
                BaseTop = HttpContext.Current.Server.MapPath("../")
            Case 2
                BaseTop = HttpContext.Current.Server.MapPath("../../")
            Case Else
                BaseTop = HttpContext.Current.Server.MapPath("./")
        End Select
        Dim BaseDir As String = BaseTop & "FormFolder\XMAN-YGDM"                   '设置基础路径


        '判断用户ID是否有效
        Dim Tb As New Data.DataTable
        Tb = DB.Table("SELECT YGDM,YGXM,DLMC,Mobile,SSKS,QYBZ,EMAIL from GY_YGDM where YGDM = " & TmpYGDM, "XX_XMJC")
        If Tb.Rows.Count = 0 Then Return "非法调用"

        '建立用户档案目录
        pub.CreateDir(BaseDir)
        Dim uri As String = BaseTop & "TemplateLibrary\" & XsnDir & ".xsn"
        If System.IO.File.Exists(uri) = False Then
            Return "用户无详细信息"
        End If

        Dim DfileName As String = BaseDir & "\" & TmpYGDM & ".xml"
        Dim templatefile As String = BaseTop & "TemplateLibrary\" & XsnDir & "\template.xml"

        If System.IO.File.Exists(DfileName) = False Then
            If System.IO.File.Exists(templatefile) = False Then
                Return "详细信息未设置"
            Else
                Try
                    System.IO.File.Copy(templatefile, DfileName, True)
                Catch ex As Exception
                    Return "读取失败,请与管理员联系"
                End Try
            End If
        End If

        Dim RootNode As System.Xml.XmlNode
        RootNode = XmlClass.GetXmlFile(DfileName)
        Dim RootNodeName As String = XmlClass.GetRootNodeName
        Dim Search_Fid As String = XmlClass.GetFormID
        '更新员工代码
        Dim Xpath As String = "//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid
        Dim TitleNode As System.Xml.XmlNode = XmlClass.FindNode(Xpath)
        TitleNode.InnerText = TmpYGDM
        TitleNode = XmlClass.FindNode("//my:姓名")
        If Not TitleNode Is Nothing Then TitleNode.InnerText = Tb.Rows(0)(1).ToString
        TitleNode = XmlClass.FindNode("//my:用户名")
        If Not TitleNode Is Nothing Then TitleNode.InnerText = Tb.Rows(0)(2).ToString
        TitleNode = XmlClass.FindNode("//my:移动电话")
        If Not TitleNode Is Nothing Then TitleNode.InnerText = Tb.Rows(0)(3).ToString
        TitleNode = XmlClass.FindNode("//my:EMAIL")
        If Not TitleNode Is Nothing Then TitleNode.InnerText = Tb.Rows(0)("EMAIL").ToString
        '---说明
        TitleNode = XmlClass.FindNode("//my:验证码")
        If WriteFlag = True Then
            If Not TitleNode Is Nothing Then TitleNode.InnerText = "111"
        Else
            If Not TitleNode Is Nothing Then TitleNode.InnerText = ""
        End If

        Dim KSDM As Integer
        Try
            KSDM = Tb.Rows(0)("SSKS").ToString
        Catch ex As Exception
            KSDM = 0
        End Try

        Dim KSMC As String = DB.ExeScalar("select KSMC from GY_KSDM where KSDM=" & KSDM)
        TitleNode = XmlClass.FindNode("//my:部门")
        If Not KSMC Is Nothing Then
            If Not TitleNode Is Nothing Then TitleNode.InnerText = KSMC.Trim
        Else
            If Not TitleNode Is Nothing Then TitleNode.InnerText = ""
        End If

        TitleNode = XmlClass.FindNode("//my:是否在岗")
        If Tb.Rows(0)("QYBZ").ToString() = "1" Then
            If Not TitleNode Is Nothing Then TitleNode.InnerText = "true"
        Else
            If Not TitleNode Is Nothing Then TitleNode.InnerText = "false"
        End If
        XmlClass.Save()


        '检测库是否存在
        Dim KuFile As String = BaseDir & ".库.xml"
        If System.IO.File.Exists(KuFile) = False Then
            If System.IO.File.Exists(templatefile) = False Then
                Return "详细信息未设置"
            Else
                Try
                    System.IO.File.Copy(templatefile, KuFile, True)
                Catch ex As Exception
                    Return "读取失败,请与管理员联系"
                End Try
            End If
        End If

        '入库操作,XML入库
        Dim TempNode As System.Xml.XmlNode
        XmlClass.GetXmlFile(DfileName)
        RootNodeName = XmlClass.GetRootNodeName
        TempNode = XmlClass.GetRootNode.Item(0)

        XmlClass.GetXmlFile(KuFile)
        Dim Node2 As XmlNode = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "[" & Search_Fid & "='" & TmpYGDM & "']")
        If Node2 Is Nothing Then
            '6.添加用户操作记录,添加新表单
            '这里对模板库中的空记录进行处理。防止在引用库时，出现空记录导致SUM不能用。
            Dim NodeNull As XmlNode = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "[" & Search_Fid & "='']")
            If NodeNull Is Nothing Then
                Try
                    XmlClass.AddNode(TempNode)
                Catch ex As Exception
                    Return "系统错误：入库失败！"
                End Try
            Else
                Try
                    XmlClass.UpdateNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "[" & Search_Fid & "='']", TempNode)
                Catch ex As Exception
                    Return "系统错误：入库失败！"
                End Try
            End If
        Else
            '6.添加用户操作记录,修改表单
            Try
                XmlClass.UpdateNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "[" & Search_Fid & "='" & TmpYGDM & "']", TempNode)
            Catch ex As Exception
                Return "系统错误：入库失败！"
            End Try
        End If


        Return Nothing
    End Function
#End Region


    ''' <summary>
    ''' 将日期转换成中文
    ''' </summary>
    ''' <param name="TmpDate"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function WeekDay2zh(ByVal TmpDate As Date) As String
        Dim numstring As Integer = Weekday(TmpDate, Microsoft.VisualBasic.FirstDayOfWeek.Monday)
        Select Case numstring
            Case "1"
                Return "一"
            Case "2"
                Return "二"
            Case "3"
                Return "三"
            Case "4"
                Return "四"
            Case "5"
                Return "五"
            Case "6"
                Return "六"
            Case "7"
                Return "日"
            Case Else
                Return numstring
        End Select
    End Function


#Region "外网 "

    ''' <summary>
    ''' 根据用户ID,得到科室代码
    ''' </summary>
    ''' <param name="UserID"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetKSDM(ByVal UserID As Integer) As Integer
        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT  SSKS FROM  GY_YGDM where YGDM=" & UserID, "dgasg")
        If tb.Rows.Count = 0 Then
            Return -1
        Else
            If IsDBNull(tb.Rows(0)(0)) = True Then
                Return -1
            Else
                Return tb.Rows(0)(0)
            End If
        End If
    End Function
    ''' <summary>
    ''' 根据科室名称,得到科室代码
    ''' </summary>
    ''' <param name="ksName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetKSDM(ByVal ksName As String) As Integer
        Dim tb As New Data.DataTable
        tb = DB.Table("select ksdm from gy_ksdm where ksmc = '" & ksName & "'", "dgasg")
        If tb.Rows.Count = 0 Then
            Return -1
        Else
            If IsDBNull(tb.Rows(0)(0)) = True Then
                Return -1
            Else
                Return tb.Rows(0)(0)
            End If
        End If
    End Function
    ''' <summary>
    ''' 根据科室名称,得到科室代码
    ''' </summary>
    ''' <param name="KSDM"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetKSMC(ByVal KSDM As Integer) As String
        Dim tb As New Data.DataTable
        tb = DB.Table("select ksmc from gy_ksdm where ksdm = " & KSDM & "", "dgasg")
        If tb.Rows.Count = 0 Then
            Return -1
        Else
            If IsDBNull(tb.Rows(0)(0)) = True Then
                Return -1
            Else
                Return tb.Rows(0)(0)
            End If
        End If
    End Function

    Function AutoAddProject_HasNoLC_Web(ByVal LCDM As Integer, ByVal Login_User As String, ByVal BasePath As String) As String
        '自动添加无流程项目

        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT LCMC FROM GY_LCDM where LCDM = " & LCDM, "GY_LCDM")
        If tb.Rows.Count = 0 Then
            _ErrMessage = "参数错误或非法访问,流程代码在数据库表中查询不到!"
            Return Nothing
        End If
        Dim XMMC As String = tb.Rows(0).Item(0)         '因为是无流程,流程名称与项目名称一样

        Dim XMLX As String = Now()
        '添加一个项目(自动添加,项目名称,登陆名,登陆时间)        '得到流程名，用流程名做为项目的名称
        Try
            DB.Query("insert into GY_XMXX(xmmc,xmsm,xmlx,lcdm) values('" & XMMC & "','" & Login_User & "','" & XMLX & "'," & LCDM & ")")
        Catch ex As Exception
            _ErrMessage = "新建失败,向项目信息表中添加记录失败!"
            Return Nothing
        End Try
        '得到新建项目的项目代码            
        Dim XMDM As String = DB.ExeScalar("select XMDM from GY_XMXX where xmmc='" & XMMC & "' and xmsm='" & Login_User & "' and xmlx='" & XMLX & "' order by xmdm desc")
        If XMDM = Nothing Then
            _ErrMessage = "数据库查询失败!查询刚插入的记录,未能查找!"
            Return Nothing
        End If
        tb = DB.Table("SELECT MKDM,xdlj,XsnDir FROM GY_MKXX where NoLcDM =" & LCDM, "GY_MKXX")
        Dim XsnDir As String = tb.Rows(0).Item(2).ToString.Trim
        Dim MKDM As Integer = tb.Rows(0).Item(0)
        '写进程表.由于是一个项目一张单.所以只写一条记录

        DB.Query("insert into XX_XMJC(xmdm,mkdm,spbz,timebz,ruletime) values(" & XMDM & "," & MKDM & ",0,0,'')")

        '得到进程ID,也就是表单ID
        tb = DB.Table("select Fid from XX_XMJC where XMDM=" & XMDM & " and MKDM = " & MKDM & " order by FID desc", "XX_XMJC")
        If tb.Rows.Count = 0 Then           '表示出错
            _ErrMessage = "查询刚插入的进程表出错,或是结果为空"
            Return Nothing
        End If
        Dim Fid As Integer = tb.Rows(0).Item(0)

        Dim XmlFileName As String = Server.MapPath(BasePath) & "\TemplateLibrary\" & XsnDir & "\template.xml"
        Dim DFileName As String = Server.MapPath(BasePath) & "\FormFolder\" & XMMC & "\" & Fid & ".xml"
        If System.IO.File.Exists(XmlFileName) = False Then      '表示模板文件不存在
            _ErrMessage = "模板存在问题,模板文件找不到,请更新此模板!"
            Return Nothing
        End If
        Try
            System.IO.File.Copy(XmlFileName, DFileName)
        Catch ex As Exception
            _ErrMessage = XmlFileName & "-" & DFileName & "功能存在问题,你重新新建功能!复制文件出错"
            Return Nothing
        End Try

        Dim Result As String = AutoFillDate(DFileName, Fid, XMDM, Login_User, True, 0)
        If Not Result Is Nothing Then               '对自动生成的值进行相应的填写
            _ErrMessage = "自动填写表单错误:" & Result
            Return Nothing
        End If
        Return DFileName
    End Function

    Function GetSSKS(ByVal UserID As Integer) As Integer
        Dim tb As New Data.DataTable
        Try
            tb = DB.Table("select SSKs from GY_YGDM where YGDM =" & UserID, "GY_YGDM")
        Catch ex As Exception
            Return 0
        End Try
        If tb.Rows.Count > 0 Then
            If IsDBNull(tb.Rows(0).Item(0)) Then
                Return 0
            Else
                Return tb.Rows(0).Item(0)
            End If
        Else
            Return 0
        End If
    End Function

    '从文件得中到数据，并存在Gridview中去．无流程,老的方法
    Function DataFromSearch_NoLC(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal SqlQuerry As String, ByVal IsPost As Boolean, ByVal SelectSQL As String, ByVal FilterName As String, ByVal FilterValue As String) As Data.DataTable
        Dim TempTable As New Data.DataTable
        Dim MaxTitle As Integer = 0
        Dim i, j As Integer
        Dim tb As New Data.DataTable

        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")
        MaxTitle = ShowTb.Rows.Count

        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Try
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim
                '过滤掉FID,项目状态,项目代码,防止出错
                If TempColumnName.Trim.ToUpper = "FID" Or TempColumnName.Trim.ToUpper = "项目状态" Or TempColumnName.Trim.ToUpper = "项目代码" Then
                    TempColumnName = TempColumnName.Trim.ToUpper & "1"
                End If
                Dim c As DataColumn = New DataColumn(TempColumnName)
                TempTable.Columns.Add(c)
                If IsPost = False Then
                    Dim TempCell1 As New HyperLinkField()
                    TempCell1.HeaderText = TempColumnName
                    TempCell1.DataTextField = TempColumnName
                    TempCell1.SortExpression = TempColumnName
                    Gridview1.Columns.Add(TempCell1)
                End If

            Catch ex As Exception
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Dim c As DataColumn = New DataColumn(TempColumnName)
                TempTable.Columns.Add(c)
                Temp1 += 1
                If IsPost = False Then
                    Dim TempCell1 As New HyperLinkField()
                    TempCell1.HeaderText = TempColumnName
                    TempCell1.DataTextField = TempColumnName
                    TempCell1.SortExpression = TempColumnName
                    Gridview1.Columns.Add(TempCell1)
                End If
            End Try
        Next
        '添加FID到Gridview1中。
        Dim c2 As DataColumn = New DataColumn("FID")
        TempTable.Columns.Add(c2)
        Dim TempCell As New HyperLinkField()
        TempCell.HeaderText = "FID"
        TempCell.DataTextField = "FID"
        TempCell.SortExpression = "FID"
        Dim c3 As DataColumn = New DataColumn("xmdm")
        TempTable.Columns.Add(c3)
        Dim TempCella As New HyperLinkField()
        TempCella.HeaderText = "xmdm"
        TempCella.DataTextField = "xmdm"
        TempCella.SortExpression = "xmdm"
        If IsPost = False Then
            Gridview1.Columns.Add(TempCell)
            Gridview1.Columns.Add(TempCella)
        End If

        tb = DB.Table("SELECT MKMC,XsnDir FROM GY_MKXX where NoLcDM =" & LCDM, "GY_MKXX")
        If tb.Rows.Count <= 0 Then
            _ErrMessage = "功能模板有问题!"
            Exit Function
        End If
        Dim MKMC As String = tb.Rows(0).Item(0).ToString.Trim

        Dim BaseUrl As String = Server.MapPath("../../") & "FormFolder/" & MKMC & "/"
        Dim FileName As String = ""

        Dim Login_User As String = System.Web.HttpContext.Current.Request.ServerVariables("LOGON_USER")
        Dim Temp As String() = Login_User.Split("\")
        Login_User = Temp(Temp.GetUpperBound(0))

        Dim Sql As String = SelectSQL
        If SqlQuerry.Trim.Length > 0 Then
            Dim Ls As String()
            Ls = SqlQuerry.Replace("'", "''").Trim.Split(" ")
            SqlQuerry = ""
            For i = 0 To Ls.GetUpperBound(0)
                If SqlQuerry.Length > 0 Then
                    SqlQuerry = SqlQuerry & " and XMDM in(SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%')"
                Else
                    SqlQuerry = "SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                End If
                If i > 2 Then Exit For
            Next
            'System.Web.HttpContext.Current.Response.Write(SqlQuerry & "-" & Ls.GetUpperBound(0))
            Sql += "  And GY_XMXX.XMDM in ( " & SqlQuerry & " GROUP BY XMDM) "
        End If
        Sql = Sql & " order by TopNum DESC,GY_XMXX.XMDM desc"

        Dim Fid As String
        Dim Xmdm As String 'aaaaaaaaaaa
        ' System.Web.HttpContext.Current.Response.Write(Sql)
        ' System.Web.HttpContext.Current.Response.End()
        tb = DB.Table(Sql, "GY_XMXX")
        For i = 0 To tb.Rows.Count - 1
            Fid = tb.Rows(i).Item("fid").ToString.Trim
            Xmdm = tb.Rows(i).Item("xmdm").ToString.Trim
            FileName = BaseUrl & Fid & ".xml"

            Dim NewRow As DataRow = TempTable.NewRow()
            NewRow(MaxTitle) = Fid
            NewRow(MaxTitle + 1) = Xmdm

            If XmlClass.GetXmlFile(FileName) Is Nothing Then
                '表示找不到记录，则显示空记录
                For j = 0 To ShowTb.Rows.Count - 1
                    NewRow(j) = "空"
                Next
            Else
                '再列自定义的列
                For j = 0 To ShowTb.Rows.Count - 1
                    Dim dd As System.Xml.XmlNode = XmlClass.FindNode("//" & ShowTb.Rows(j).Item(1).ToString.Replace("<", "").Replace(">", ""))
                    If dd Is Nothing Then
                        NewRow(j) = "空"
                    Else
                        If dd.ChildNodes.Item(0) Is Nothing Then
                            NewRow(j) = "空"
                        Else
                            If dd.ChildNodes.Item(0).Value Is Nothing Then
                                NewRow(j) = "空"
                            Else
                                If dd.ChildNodes.Item(0).Value.ToString.Trim.Length >= 100 Then
                                    NewRow(j) = Server.HtmlEncode(dd.ChildNodes.Item(0).Value.ToString.Substring(0, 98)) & "..."
                                Else
                                    NewRow(j) = Server.HtmlEncode(dd.ChildNodes.Item(0).Value)
                                End If
                            End If
                        End If
                    End If
                Next
            End If
            TempTable.Rows.Add(NewRow)      '将列添加到表中
        Next

        TempTable = FilterFunction(LCDM, TempTable, FilterName, FilterValue)
        Gridview1.DataSource = TempTable
        Gridview1.Columns(Gridview1.Columns.Count - 1).Visible = False
        Gridview1.Columns(Gridview1.Columns.Count - 2).Visible = False
        Return TempTable
    End Function


    ''' <summary>
    ''' 过滤函数
    ''' </summary>
    ''' <param name="LCDM"></param>
    ''' <param name="TempTable"></param>
    ''' <param name="FilterName"></param>
    ''' <param name="FilterValue"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function FilterFunction(ByVal LCDM As Integer, ByVal TempTable As Data.DataTable, ByVal FilterName As String, ByVal FilterValue As String) As Data.DataTable
        If FilterName = "" Then Return TempTable
        Dim i, index As Integer
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        index = -1

        For i = 0 To ShowTb.Rows.Count - 1
            If ShowTb.Rows(i).Item(0).ToString.Trim = FilterName Then
                index = i
                Exit For
            End If
        Next
        _ErrMessage = i & "-" & FilterValue
        Select Case FilterName
            Case "所属地区"         '特殊处理。因为是判断项目状态
                If index > -1 Then
                    For i = TempTable.Rows.Count - 1 To 0 Step -1
                        If TempTable.Rows(i).Item(index).ToString.Trim <> FilterValue.Trim And TempTable.Rows(i).Item(index).ToString.Trim <> "空" Then
                            TempTable.Rows(i).Delete()
                        End If
                    Next
                End If
        End Select

        Return TempTable
    End Function


    ''' <summary>
    ''' 过滤函数
    ''' </summary>
    ''' <param name="LCDM"></param>
    ''' <param name="TempTable"></param>
    ''' <param name="FilterName"></param>
    ''' <param name="FilterValue"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function FilterFunction_reports(ByVal LCDM As Integer, ByVal TempTable As Data.DataTable, ByVal FilterName As String, ByVal FilterValue As String) As Data.DataTable
        If FilterName = "" Then Return TempTable
        Dim i, index As Integer
        Dim ShowTb As New Data.DataTable

        ShowTb = DB.Table("Select ShowName,NodeName from ReportsList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        If ShowTb.Rows.Count = 0 Then       '假如为报表方式为空时.则直接显示普通方式下的
            ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        End If
        index = -1

        For i = 0 To ShowTb.Rows.Count - 1
            If ShowTb.Rows(i).Item(0).ToString.Trim = FilterName Then
                index = i
                Exit For
            End If
        Next

        Select Case FilterName
            Case "所属地区"         '特殊处理。因为是判断项目状态
                If index > -1 Then
                    For i = TempTable.Rows.Count - 1 To 0 Step -1
                        If TempTable.Rows(i).Item(index).ToString.Trim <> FilterValue.Trim And TempTable.Rows(i).Item(index).ToString.Trim <> "空" Then
                            'System.Web.HttpContext.Current.Response.Write(TempTable.Rows(i).Item(index).ToString.Trim & "-" & FilterValue & "<br>")
                            TempTable.Rows(i).Delete()
                        End If
                    Next
                End If
        End Select

        Return TempTable
    End Function

    ''' <summary>
    ''' 外网用户检测
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Public Function HomePageUserCheck() As Boolean
        Dim UserName, PassWord As String
        If Session("LoginName") = "" Then
            If Not System.Web.HttpContext.Current.Request.Cookies("LoginName") Is Nothing Then
                UserName = System.Web.HttpContext.Current.Request.Cookies("LoginName").Value
                Try
                    PassWord = System.Web.HttpContext.Current.Request.Cookies("PassWord").Value
                Catch ex As Exception
                    PassWord = ""
                End Try
            Else
                Return False
            End If
        Else
            UserName = Session("LoginName")
            PassWord = Session("PassWord")
        End If

        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT YGDM FROM GY_YGDM where DLMC='" & Me.SqlFilter(UserName) & "' and DLPWD='" & EnCrypt.MD5(PassWord) & "' and IsOut=1", "EnterprisesTable")
        If tb.Rows.Count > 0 Then
            System.Web.HttpContext.Current.Response.Cookies("LoginName").Value = UserName
            System.Web.HttpContext.Current.Response.Cookies("PassWord").Value = PassWord
            Session("LoginName") = UserName
            Session("PassWord") = PassWord
            Return True
        Else
            Return False
        End If
    End Function

#End Region


#Region "SQL_XML入库常用函数"


    ''' <summary>
    ''' 由SQL生成临时的XMLDOM。
    ''' </summary>
    ''' <param name="Name"></param>
    ''' <param name="TmpXml"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetXML_MKDM(ByVal Name As String, ByRef TmpXml As XmlDocument) As String
        Dim MKDM As Integer = Me.GetMKDM(Name)
        If MKDM = -1 Then Return Name & "库名不存在"
        Dim Row As DataRow = DB.Row("Select XsnDir From GY_MKXX Where MKDM=" & MKDM, "d")
        If Row Is Nothing Then
            Return Name & "库名不存在"
        End If
        Dim XsnDir As String = Row.Item("XsnDir").ToString
        Dim XsnFile As String = Server.MapPath("./") & "/TemplateLibrary/" & XsnDir & "/template.xml"

        If System.IO.File.Exists(XsnFile) = False Then
            Return Name & "模板存在问题，请联系管理员"
        End If

        Dim Tb As New Data.DataTable
        Tb = Me.DB.Table("SELECT FormContent FROM XX_XMJC where (NOT (FormContent IS NULL)) and (State<>-100 or state is null) FOR xml Auto,TYPE", "dd")
        Dim i As Integer
        Dim StrTmp As New StringBuilder
        For i = 0 To Tb.Rows.Count - 1
            StrTmp.Append(Tb.Rows(i).Item(0).ToString().Replace("<XX_XMJC>", "").Replace("</XX_XMJC>", "").Replace("<FormContent>", "").Replace("</FormContent>", ""))
        Next
        Try
            TmpXml.Load(XsnFile)
            TmpXml.DocumentElement.InnerXml = StrTmp.ToString
            Return Nothing
        Catch ex As Exception
            Return "XML结构错误"
        End Try
    End Function


#End Region

    Public ReadOnly Property ErrMessage() As String
        Get
            Return _ErrMessage
        End Get
    End Property


    ''' <summary>
    ''' 检测上传文件的扩展名
    ''' </summary>
    ''' <param name="FileUpload1"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CheckUploadFileType(ByVal FileUpload1 As HtmlInputFile) As String
        Dim FileType As String = GetSystemParameters("UpLoad_Filter")
        If FileType Is Nothing Then FileType = "空"
        Dim FileName As String = FileUpload1.PostedFile.FileName
        Dim StrImgType As String = FileName.Substring(FileName.LastIndexOf(".") + 1).ToLower        '得到上传时原文件的扩展名
        If StrImgType.Trim = "" Then StrImgType = "空" '过滤掉无扩展名的文件
        Dim temp As String() = FileType.Split("|")
        Dim flag As Boolean = False
        Dim i As Integer
        For i = 0 To UBound(temp)
            If temp(i).ToLower = StrImgType Then
                flag = True
                Exit For
            End If
        Next
        If Not flag Then
            Return "目前本系统支持的格式为:" + FileType + "\n你现在上传的文件格式为:" + StrImgType
        Else
            Return Nothing
        End If
    End Function

    ''' <summary>
    ''' 将目录的文件信息以dataset的形式返回
    ''' </summary>
    ''' <param name="BasePath"></param>
    ''' <param name="OpFolder"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetFileListToDataSet(ByVal BasePath As String, ByVal OpFolder As String, ByVal ListKind As Integer) As DataSet
        '将目录文件列表存以DataSet的形式返回
        Dim Values As New ArrayList
        Dim MyFiles, MyDirs As String()
        Dim ds As DataSet = New DataSet("myDataSet")
        If ListKind <= 1 Then
            MyDirs = Directory.GetDirectories(BasePath & OpFolder)         '//得到该目录下所有目录
            Values.AddRange(MyDirs)                             '//加入目录
        End If
        If ListKind = 2 Or ListKind = 0 Then
            MyFiles = Directory.GetFiles(BasePath & OpFolder)          '//得到该目录下所有文件
            Values.AddRange(MyFiles)                            '//加入文件
        End If
        Dim i As Integer
        Dim myTable As DataTable = New DataTable("Table")
        Dim c1 As DataColumn = New DataColumn("序号")
        Dim c2 As DataColumn = New DataColumn("名称")
        Dim c3 As DataColumn = New DataColumn("大小")
        Dim c4 As DataColumn = New DataColumn("类型")
        Dim c5 As DataColumn = New DataColumn("最后修改时间")
        myTable.Columns.Add(c1)
        myTable.Columns.Add(c2)
        myTable.Columns.Add(c3)
        myTable.Columns.Add(c4)
        myTable.Columns.Add(c5)
        ds.Tables.Add(myTable)
        Dim newRow As DataRow

        Dim FolderLen As Integer
        Try
            FolderLen = MyDirs.GetUpperBound(0)
        Catch ex As Exception
            FolderLen = -1
        End Try
        For i = 0 To Values.Count - 1
            Dim FileInfo As New System.IO.FileInfo(Values(i))
            If FileInfo.Name <> "分发临时文件夹" And FileInfo.Name <> "临时附件文件夹" Then
                newRow = myTable.NewRow()
                If i <= FolderLen Then
                    Dim dt As New Data.DataTable
                    newRow(1) = FileInfo.Name
                    newRow(2) = ""
                    newRow(3) = "文件夹"
                    newRow(4) = FileInfo.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
                Else
                    Dim FileType As String
                    FileType = FileInfo.Extension
                    newRow(1) = FileInfo.Name.Trim
                    Dim FileSize As Integer
                    FileSize = FileInfo.Length
                    If FileSize > 0 Then
                        FileSize = FileSize \ 1024
                        If FileSize = 0 Then FileSize = 1
                    End If
                    newRow(2) = FileSize & "K"
                    newRow(3) = FileType
                    newRow(4) = FileInfo.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
                End If
                myTable.Rows.Add(newRow)
            End If
        Next
        ds.AcceptChanges()
        Return ds
    End Function

    Function SqlFilter(ByVal Str As String) As String
        Dim Fy_In As String = "exec|insert|select|delete|update|master|truncate|char|declare"      '注每个后面加个空格
        Dim TempSqlin As String()
        TempSqlin = Fy_In.Split("|")
        Str = Str.Replace("'", "''")
        Dim i As Integer
        For i = 0 To TempSqlin.Length - 1
            Str = Str.Replace(TempSqlin(i), "")
        Next
        Return Str
    End Function

    Function CheckNull(ByVal mypage As Page, ByVal text As TextBox, ByVal Message As String) As Boolean
        If text.Text.Trim.Length = 0 Then
            Js.alert(mypage, Message)
            Return False
        End If
        Return True
    End Function

    Function CheckIsInt(ByVal mypage As Page, ByVal text As TextBox, ByVal message As String) As Boolean
        If Js.IsInt(text.Text) = False Then
            Js.alert(mypage, "你输入的宽度不是数字")
            Return False
        End If
        Return True
    End Function

    Public Function MD5(ByVal str As String, ByVal code As Integer) As String       '用口令方式加密
        If (code = 16) Then '//16位MD5加密（取32位加密的9~25字符） 
            Return System.Web.Security.FormsAuthentication.HashPasswordForStoringInConfigFile(str, "MD5").ToLower().Substring(8, 16)
        End If

        If (code = 32) Then '//32位加密 
            Return System.Web.Security.FormsAuthentication.HashPasswordForStoringInConfigFile(str, "MD5").ToLower()
        End If
        Return "00000000000000000000000000000000"
    End Function

#Region "数据库用户模块"

    ''' <summary>
    ''' 验证用户的有效性.
    ''' </summary>
    ''' <param name="UName"></param>
    ''' <param name="MD5Pwd"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CheckUserAuthentication(ByVal UName As String, ByVal MD5Pwd As String) As Boolean
        If UName.Trim.Length = 0 Or MD5Pwd.Trim.Length = 0 Then Return False
        Dim Topstr As String = pub.GetWebConfig("SunfunSoft.Xman.Session.TopStr").ToString
        Dim Tb As New Data.DataTable
        Try
            Dim sqlstr As String
            sqlstr = "SELECT YGDM,DLMC FROM GY_YGDM Where DLMC='" & SqlFilter(UName) & "' and DLPWD='" & SqlFilter(MD5Pwd) & "' and QYBZ=1"
            Tb = DB.Table(sqlstr, "dd")
        Catch ex As Exception
            HttpContext.Current.Response.Write("网站暂停，请稍候再试或联系管理员")
            HttpContext.Current.Response.End()
        End Try

        If Tb.Rows.Count = 0 Then
            Session(Topstr & "_UName") = ""
            Session(Topstr & "_UPwd") = ""
            HttpContext.Current.Response.Cookies(Topstr & "_UName").Expires = Now.Date.AddDays(-1)
            HttpContext.Current.Response.Cookies(Topstr & "_UName").Value = ""
            HttpContext.Current.Response.Cookies(Topstr & "_UPwd").Expires = Now.Date.AddDays(-1)
            HttpContext.Current.Response.Cookies(Topstr & "_UPwd").Value = ""
            Return False
        Else
            Session(Topstr & "_UName") = SqlFilter(UName)
            Session(Topstr & "_UPwd") = MD5Pwd
            HttpContext.Current.Response.Cookies(Topstr & "_UName").Expires = Now.Date.AddDays(1)
            HttpContext.Current.Response.Cookies(Topstr & "_UName").Value = SqlFilter(UName)
            HttpContext.Current.Response.Cookies(Topstr & "_UPwd").Expires = Now.Date.AddDays(1)
            HttpContext.Current.Response.Cookies(Topstr & "_UPwd").Value = MD5Pwd
            Return True
        End If
    End Function

    ''' <summary>
    ''' 直接检测COOKIES和SESSION.看是否已经登陆过.
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CheckUserAuthentication() As Boolean
        Dim Uname, MD5Pwd As String
        Dim Topstr As String = pub.GetWebConfig("SunfunSoft.Xman.Session.TopStr").ToString
        If Session(Topstr & "_UName") = "" Then
            If HttpContext.Current.Request.Cookies(Topstr & "_UName") Is Nothing Then
                Return False
            Else
                Uname = HttpContext.Current.Request.Cookies(Topstr & "_UName").Value
            End If
        Else
            Uname = Session(Topstr & "_UName")
        End If
        If Session(Topstr & "_UPwd") = "" Then
            If HttpContext.Current.Request.Cookies(Topstr & "_UPwd") Is Nothing Then
                Return False
            Else
                MD5Pwd = HttpContext.Current.Request.Cookies(Topstr & "_UPwd").Value
            End If
        Else
            MD5Pwd = Session(Topstr & "_UPwd")
        End If
        Return CheckUserAuthentication(Uname, MD5Pwd)
    End Function

#End Region



#Region "Infojet 基本函数"
    Function InfoJetRegister(ByVal PublicUrl As String, ByVal Path As String) As String
        If PublicUrl Is Nothing Then        '当上传文件调用时，Publicurl为空。
            Return PublicUrl
        End If
        '得到列表后,进行检测,模板是否已经注册过.
        Dim uriList As String() = InfoJetSoft.Service.InfoJetService.List()
        Dim RegFlag As Boolean = False
        Dim i As Integer
        For i = 0 To uriList.GetUpperBound(0)
            If uriList(i) = PublicUrl Then
                RegFlag = True
                Exit For
            End If
        Next

        If RegFlag = False Then
            '如果检测不到模板,则进行注册
            Dim XsnDir As String
            Dim index As Integer
            index = PublicUrl.LastIndexOf("/")
            If index > 0 Then
                XsnDir = PublicUrl.Substring(index)
            Else
                index = PublicUrl.LastIndexOf("\")
                If index > 0 Then
                    XsnDir = PublicUrl.Substring(index)
                Else
                    XsnDir = ""     '出错
                End If
            End If

            Dim uri As String = Path & "TemplateLibrary\" & XsnDir
            Dim Fs As IO.FileStream = New IO.FileStream(uri, System.IO.FileMode.Open, System.IO.FileAccess.Read, System.IO.FileShare.Read)  '当False为True是.向文件添加内容
            Dim xsnContent(Fs.Length) As Byte
            Dim strread As New IO.BinaryReader(Fs) '流处理要传输的文件
            strread.Read(xsnContent, 0, xsnContent.Length)
            PublicUrl = InfoJetSoft.Service.InfoJetService.Register(Context, xsnContent)
        End If
        Return PublicUrl
    End Function
#End Region



#Region "Webservice调用公用函数"

    Function UpdateMapping(ByVal FID As Integer) As Boolean
        '二维表映射
        Dim Tb As New Data.DataTable

        Try
            Tb = DB.Table("select XX_XMJC.MKDM,MKMC from XX_XMJC,GY_MKXX where XX_XMJC.MKDM=GY_MKXX.MKDM and FID=" & FID, "XX_XMJC")
        Catch ex As Exception
            Return False
        End Try


        Dim MKDM As String
        Dim MKMC As String

        MKDM = Tb.Rows(0)("MKDM")
        MKMC = Tb.Rows(0)("MKMC").ToString

        Dim LibraryPath As String

        LibraryPath = System.AppDomain.CurrentDomain.BaseDirectory & "\FormFolder\"

        Dim FormLibraryNode As String

        Dim Kid, i As Integer
        Try
            Tb = DB.Table("SELECT MapXpath FROM GY_MKXX where MKDM=" & MKDM & " and MapXpath is not null", "dd")
        Catch ex As Exception
            'Response.Write("SQL映射出错,请确定已经设置过,或联系管理员.")
            'Response.End()
            Return False
        End Try
        Dim SaveFile As String = LibraryPath & MKMC & "\" & FID & ".xml"
        Dim j As Integer
        If Tb.Rows.Count > 0 Then
            FormLibraryNode = Tb.Rows(0)(0)
            DB.Query("Delete " & MKMC & "_Mapping where Fid=" & FID)      '先删除原来的记录,因为要进行更新

            XmlClass.GetXmlFile(SaveFile)
            Dim Exnodelist As XmlNodeList = XmlClass.FindNodes("//" & FormLibraryNode)
            For i = 0 To Exnodelist.Count - 1
                Kid = DB.ExeScalar("INSERT INTO [" & MKMC & "_Mapping](FID) VALUES(" & FID & ");Select AId from " & MKMC & "_Mapping where aid = @@IDENTITY")
                For j = 0 To Exnodelist.Item(i).ChildNodes.Count - 1
                    Try
                        If Not Exnodelist.Item(i).ChildNodes(j).ChildNodes(0) Is Nothing Then
                            DB.Query("update [" & MKMC & "_Mapping] set " & Exnodelist.Item(i).ChildNodes(j).Name.Replace(":", "") & " = '" & Exnodelist.Item(i).ChildNodes(j).ChildNodes(0).Value & "' where aid=" & Kid)
                        Else
                            DB.Query("update [" & MKMC & "_Mapping] set " & Exnodelist.Item(i).ChildNodes(j).Name.Replace(":", "") & " = '' where aid=" & Kid)
                        End If
                    Catch ex As Exception
                        '表示插表失败,一般都是读出的XML节点内容为空
                    End Try
                Next
            Next
        End If

        '对扩展属性进行映射
        Tb = DB.Table("SELECT AID,MapExtName FROM MapConfig where (IsTotal  is null or IsTotal = 0) and  MKDM=" & MKDM, "dd")
        If Tb.Rows.Count > 0 Then
            DB.Query("Delete " & MKMC & "_MapExt where Fid=" & FID)
            Kid = DB.ExeScalar("INSERT INTO [" & MKMC & "_MapExt](FID) VALUES(" & FID & ");Select AId from " & MKMC & "_MapExt where aid = @@IDENTITY")
            XmlClass.GetXmlFile(SaveFile)
            For i = 0 To Tb.Rows.Count - 1
                Dim Exnode As XmlNode = XmlClass.FindNode("//" & Tb.Rows(i)("MapExtName").ToString())
                Try
                    If Not Exnode.ChildNodes(0) Is Nothing Then
                        DB.Query("update [" & MKMC & "_MapExt] set " & Tb.Rows(i)("MapExtName").ToString().Replace(":", "") & " = '" & Exnode.ChildNodes.Item(0).Value & "' where aid=" & Kid)
                    Else
                        DB.Query("update [" & MKMC & "_MapExt] set " & Tb.Rows(i)("MapExtName").ToString().Replace(":", "") & " = '' where aid=" & Kid)
                    End If
                Catch ex As Exception
                    '表示插表失败,一般都是读出的XML节点内容为空
                End Try
            Next
        End If
        Return True
    End Function

    Function GetPCount(ByVal cph As String, ByVal pch As String, ByVal tbname As String, ByVal sqlstr As String) As Integer
        Dim sql As String
        Dim count As Integer = 0
        sql = "select sum(convert(int,my数量)) from " & tbname & " where my产品号='" & cph & "' and my批号='" & pch & "'" & sqlstr & ""
        Dim tb As New DataTable
        tb = DB.Table(sql, "aa")
        If tb.Rows.Count > 0 Then
            If tb.Rows(0)(0).ToString <> "" Then
                Try
                    count = Convert.ToInt32(tb.Rows(0)(0).ToString)
                Catch ex As Exception
                    Return 0
                End Try
            End If
        End If
        Return count
    End Function

    ''' <summary>
    ''' 二维映射公共功能函数
    ''' </summary>
    ''' <param name="Name"></param>
    ''' <param name="Xpath"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetDataPublicFun_Mapping(ByVal Name As String, ByVal Xpath As String) As String
        '当传入值只是拿一个结构时.返回为空
        If Xpath = "null" Or Xpath = "sum(null)" Or Xpath = "count(null)" Then
            Return Nothing
        End If

        Dim TempXpath As String = Xpath.Replace("sum(", "#")
        Dim temp As String()
        temp = TempXpath.Split("#")
        Dim CenterResult As Double = 0
        Dim LastResult As Double = 0
        Dim Math As String = Nothing
        Dim j As Integer
        Dim idx As Int16
        Dim TmpMath As String
        For j = 1 To temp.Length - 1
            temp(j) = "sum(" & temp(j)
            idx = temp(j).LastIndexOf(")")
            If idx > 0 Then
                TmpMath = temp(j).Substring(idx + 1)
                temp(j) = temp(j).Substring(0, idx + 1)
            Else
                TmpMath = Nothing
            End If
            Dim TempSql As String = ReplaceXpath2Select(temp(j), Name)
            'Return TempSql
            If TempSql Is Nothing Then
                CenterResult = 0
            Else
                'Node1.InnerText = Node1.InnerText & TempSql            '输出SQL语句
                Dim row1 As Data.DataRow
                Try

                    If pub.GetWebConfig("SunfunSoft.Xman.Title") = "康泰生物销售管理系统" Then
                        If TempSql.IndexOf("kt_入库单") > 0 And TempSql.IndexOf("Mapping") > 0 And TempSql.IndexOf("MapExt") > 0 Then
                            TempSql = TempSql.Replace("my批号", "a.my批号").Replace("my产品号", "a.my产品号")
                        End If
                        'If TempSql.IndexOf("kt_入库单") > 0 And TempSql.IndexOf("Mapping") > 0 And TempSql.IndexOf("my单据名称") > 0 Then
                        '    TempSql = TempSql.Replace("my单据名称", "my单据类型")
                        'End If
                        If TempSql.IndexOf("kt_发货单") > 0 And TempSql.IndexOf("Mapping") > 0 And TempSql.IndexOf("MapExt") > 0 Then
                            TempSql = TempSql.Replace("my批号", "a.my批号").Replace("my产品号", "a.my产品号")
                        End If
                        If TempSql.IndexOf("kt_调整单") > 0 And TempSql.IndexOf("Mapping") > 0 And TempSql.IndexOf("MapExt") > 0 Then
                            TempSql = TempSql.Replace("my批号", "a.my批号").Replace("my产品号", "a.my产品号")
                        End If
                    End If
                    row1 = DB.Row(TempSql, "select")
                Catch ex As Exception
                    row1 = Nothing
                End Try
                If row1 Is Nothing Then              '数据返回值为空时
                    CenterResult = 0
                Else
                    'Node1.InnerText = Node1.InnerText & "[" & row1.Item(0).ToString & "]"          '输出结果
                    If IsDBNull(row1.Item(0)) Then
                        CenterResult = 0
                    Else
                        CenterResult = CDbl(row1.Item(0).ToString)
                    End If
                End If
            End If

            Select Case Math
                Case Nothing
                    LastResult = CenterResult
                Case "-"
                    LastResult = LastResult - CenterResult
                Case "+"
                    LastResult = LastResult + CenterResult
                Case "*"
                    LastResult = LastResult * CenterResult
            End Select
            '得到下个操作数的符号
            Math = TmpMath
        Next
        Return LastResult
    End Function

    ''' <summary>
    ''' 将Xpath语句转换成SQL语句
    ''' </summary>
    ''' <param name="Xpath"></param>
    ''' <param name="MKMC"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function ReplaceXpath2Select(ByVal Xpath As String, ByVal MKMC As String) As String
        Dim SelectStr As New StringBuilder                          '最终生成的查询语句
        Dim SelNode As String = String.Empty                        '所要得到结果的结点名
        Dim TempStr As String = Xpath
        Dim IdxTemp As Integer                                      '临时索引号


        '当传入值只是拿一个结构时.返回为空
        If TempStr = "null" Or TempStr = "sum(null)" Or TempStr = "count(null)" Then
            Return Nothing
        End If

        '先得到节点的最后一级.也就是返回的节点名
        IdxTemp = TempStr.LastIndexOf("/")
        If IdxTemp > 0 Then
            SelNode = TempStr.Substring(IdxTemp + 1)
            IdxTemp = SelNode.IndexOf("[")
            If IdxTemp > 0 Then         '如果最后的节点存在条件.则要去掉条件
                SelNode = SelNode.Substring(0, IdxTemp)
            End If
            'SelNode = SelNode.Replace(")", "").Replace("-", "").Replace("+", "")      '去除-,+,) 等符号
            SelNode = SelNode.Replace(")", "")      '去除-,+,) 等符号
        Else
            SelNode = TempStr
        End If
        If SelNode.IndexOf("*") >= 0 Then           '如果存在乘法
            SelNode = SelNode.Replace("*", ")*convert(numeric(18,4),")
        End If
        If SelNode.IndexOf("-") >= 0 Then           '如果存在减法
            SelNode = SelNode.Replace("-", ")-convert(numeric(18,4),")
        End If
        If SelNode.IndexOf("+") >= 0 Then           '如果存在加法
            SelNode = SelNode.Replace("+", ")+convert(numeric(18,4),")
        End If
        '----------------------------------------------

        '对XPAHT中一些没有用的字符替换掉
        TempStr = TempStr.Replace("1=1 and", "")                     '1=1 and 去除
        TempStr = TempStr.Replace("number(translate(", "Date(")                'number(translate(  转换成Date(
        TempStr = TempStr.Replace("!=", "<>")                       ' !=  换成 <>
        TempStr = TempStr.Replace("[last()]", "")                   '[last()]  为空
        TempStr = TempStr.Replace("my:标题/my:表单号", "a.Fid")       'my:标题/my:表单号 换成FID
        '----------------------------------------------

        If TempStr.IndexOf("count(") > -1 Then
            SelectStr.Append("Select count(convert(numeric(18,4),")
        Else
            SelectStr.Append("Select Sum(convert(numeric(18,4),")
        End If

        Dim Tb As New Data.DataTable
        Try
            Tb = DB.Table("select Aid From " & MKMC & "_MapExt", "dd")
        Catch ex As Exception
            'Return Nothing
        End Try

        If Tb.Rows.Count > 0 Then
            SelectStr.Append(SelNode & ")) From " & MKMC & "_Mapping as a," & MKMC & "_MapExt as b where a.FID=b.FID")
        Else                    '当不存在扩展映射内容时.只读取一个表.
            SelectStr.Append(SelNode & ")) From " & MKMC & "_Mapping as a where 1=1")
        End If

        '对XPATH的所有条件部分进行处理.先用正则得到.然后进行转换
        Dim TempItem As String          '交换时的临时变量
        Dim OutStr As String            '用在存条件的临时变时
        Dim Temp As System.Text.RegularExpressions.MatchCollection = System.Text.RegularExpressions.Regex.Matches(TempStr, "\[[^\[]*]")
        Dim temp1 As System.Text.RegularExpressions.MatchCollection
        Dim i, j As Integer
        For i = 0 To Temp.Count - 1
            OutStr = ReplaceWhere(Temp.Item(i).ToString.Trim)
            'OutStr = Temp.Item(i).ToString.Trim
            temp1 = System.Text.RegularExpressions.Regex.Matches(OutStr, "Date\([^\(]*\)")
            For j = 0 To temp1.Count - 1
                TempItem = temp1.Item(j).ToString.Trim
                IdxTemp = TempItem.LastIndexOf("/")
                If IdxTemp > 0 Then
                    OutStr = OutStr.Replace(TempItem, "Date(" & TempItem.Substring(IdxTemp + 1))
                End If
            Next
            OutStr = OutStr.Replace("Date(", "convert(numeric(18,0),Replace(")                '将DATE函数转换成SQL的convert(datetime,
            SelectStr.Append(" and " & OutStr.Replace("[", "").Replace("]", ""))
        Next
        Return SelectStr.ToString.Replace(":", "")
    End Function

    ''' <summary>
    ''' 将Xpath语句转换成SQL语句,用于对库的查询（webservice）
    ''' </summary>
    ''' <param name="Xpath"></param>
    ''' <param name="MKMC"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function Xpath2Select(ByVal Xpath As String, ByVal MKMC As String) As String
        Dim SelectStr As New StringBuilder                          '最终生成的查询语句
        Dim SelNode As String = String.Empty                        '所要得到结果的结点名
        Dim TempStr As String = Xpath
        Dim IdxTemp As Integer                                      '临时索引号


        '当传入值只是拿一个结构时.返回为空
        If TempStr = "null" Or TempStr = "sum(null)" Or TempStr = "count(null)" Then
            Return Nothing
        End If

        '先得到节点的最后一级.也就是返回的节点名
        IdxTemp = TempStr.LastIndexOf("/")
        If IdxTemp > 0 Then
            SelNode = TempStr.Substring(IdxTemp + 1)
            IdxTemp = SelNode.IndexOf("[")
            If IdxTemp > 0 Then         '如果最后的节点存在条件.则要去掉条件
                SelNode = SelNode.Substring(0, IdxTemp)
            End If
            'SelNode = SelNode.Replace(")", "").Replace("-", "").Replace("+", "")      '去除-,+,) 等符号
            SelNode = SelNode.Replace(")", "")      '去除-,+,) 等符号
        Else
            SelNode = TempStr
        End If


        '对XPAHT中一些没有用的字符替换掉
        TempStr = TempStr.Replace("1=1 and", "")                     '1=1 and 去除
        TempStr = TempStr.Replace("number(translate(", "Date(")                'number(translate(  转换成Date(
        TempStr = TempStr.Replace("!=", "<>")                       ' !=  换成 <>
        TempStr = TempStr.Replace("[last()]", "")                   '[last()]  为空
        TempStr = TempStr.Replace("my:标题/my:表单号", "a.Fid")       'my:标题/my:表单号 换成FID
        '----------------------------------------------

        SelectStr.Append("Select fid ")
        If SelNode <> TempStr Then
            SelectStr.Append("," & SelNode & " ")
        End If
        Dim Tb As New Data.DataTable
        Try
            Tb = DB.Table("select Aid From " & MKMC & "_MapExt", "dd")
        Catch ex As Exception
            'Return Nothing
        End Try

        SelectStr.Append(" From " & MKMC & "_MapExt as a where 1=1")

        '对XPATH的所有条件部分进行处理.先用正则得到.然后进行转换
        Dim TempItem As String          '交换时的临时变量
        Dim OutStr As String            '用在存条件的临时变时
        Dim Temp As System.Text.RegularExpressions.MatchCollection = System.Text.RegularExpressions.Regex.Matches(TempStr, "\[[^\[]*]")
        Dim temp1 As System.Text.RegularExpressions.MatchCollection
        Dim i, j As Integer
        For i = 0 To Temp.Count - 1
            OutStr = ReplaceWhere(Temp.Item(i).ToString.Trim)
            If OutStr.IndexOf("''") > 0 Then
                OutStr = OutStr.Replace("''", "'空'")
            End If
            'OutStr = Temp.Item(i).ToString.Trim
            temp1 = System.Text.RegularExpressions.Regex.Matches(OutStr, "Date\([^\(]*\)")
            For j = 0 To temp1.Count - 1
                TempItem = temp1.Item(j).ToString.Trim
                IdxTemp = TempItem.LastIndexOf("/")
                If IdxTemp > 0 Then
                    OutStr = OutStr.Replace(TempItem, "Date(" & TempItem.Substring(IdxTemp + 1))
                End If
            Next
            OutStr = OutStr.Replace("Date(", "convert(numeric(18,0),Replace(")                '将DATE函数转换成SQL的convert(datetime,
            SelectStr.Append(" and " & OutStr.Replace("[", "").Replace("]", ""))
        Next
        Return SelectStr.ToString.Replace(":", "")
    End Function

    ''' <summary>
    ''' 去除条件语句中存在的多级节点 "/" 和 contains
    ''' </summary>
    ''' <param name="OutStr"></param>
    ''' <returns></returns>
    ''' <remarks>主要根据空格来划分.然后进行重组</remarks>
    Function ReplaceWhere(ByVal OutStr As String) As String
        Dim Temp2 As String()
        Dim j, index As Integer
        Dim StrBuder As New StringBuilder

        Temp2 = OutStr.Split(" ")
        For j = 0 To Temp2.Length - 1
            '处理条件时的多级节点.类似于  my:标题/my:表单号
            index = Temp2(j).LastIndexOf("/")
            If index > 0 Then
                If Temp2(j).IndexOf("Date(") >= 0 Then           '当多级节点是日期比较时.进行处理
                    Temp2(j) = "Date(" & Temp2(j).Substring(index + 1)
                Else
                    Temp2(j) = Temp2(j).Substring(index + 1)
                End If
            End If
            '接下来用 contains进行处理
            index = Temp2(j).IndexOf(")")
            If Temp2(j).IndexOf("contains(") > 0 And index > 0 Then
                Temp2(j) = Temp2(j).Substring(0, index - 1).Replace("contains(", "")
                Temp2(j) = Temp2(j).Replace(",'", " like '%") & "%'"
            End If
            StrBuder.Append(Temp2(j) & " ")
        Next
        Return StrBuder.ToString
    End Function

    ''' <summary>
    ''' 根据XmlDocument对像.得到命名空间
    ''' </summary>
    ''' <param name="xmlDoc"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetXmlNamespaceManager(ByVal xmlDoc As XmlDocument) As XmlNamespaceManager
        Dim i As Integer
        Dim names As XmlNamespaceManager = New XmlNamespaceManager(xmlDoc.NameTable)
        If xmlDoc.DocumentElement Is Nothing Then Return names
        For i = 0 To xmlDoc.DocumentElement.Attributes.Count - 1
            Dim temp As String() = xmlDoc.DocumentElement.Attributes(i).Name.Split(":")
            If temp.GetUpperBound(0) > 0 Then       '过滤一些属性值,因为节点上不一定都是命名空间的.
                names.AddNamespace(temp(1), xmlDoc.DocumentElement.Attributes(i).InnerText)
            End If
        Next
        Return names
    End Function


    ''' <summary>
    ''' 对XML的内容进行转义
    ''' </summary>
    ''' <param name="str"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function Rp_Xml_Value(ByVal str As String) As String
        str = str.Replace("&", "&amp;")
        str = str.Replace("'", "&apos;")
        str = str.Replace("""", "&quot;")
        str = str.Replace(">", "&gt;")
        str = str.Replace("<", "&lt;")
        Return str
    End Function


#Region "表单操作的相关函数，包括删除表单，附件等"
    ''' <summary>
    ''' 删除附件功能函数
    ''' </summary>
    ''' <param name="Fid"></param>
    ''' <param name="MKMC"></param>
    ''' <remarks></remarks>
    Sub DeleteAnnexFile(ByVal Fid As Integer, ByVal MKMC As String)
        Dim i, j As Integer
        Dim SaveBase As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & "\Annex\"
        Dim SaveFile As String
        For i = 0 To 20
            For j = 0 To 20
                SaveFile = Fid & "_" & i & "_" & j & ".txt"
                If System.IO.File.Exists(SaveBase & SaveFile) = True Then
                    Try
                        System.IO.File.Delete(SaveBase & SaveFile)
                    Catch ex As Exception
                    End Try
                End If
            Next
        Next
    End Sub

    ''' <summary>
    ''' 将表单状态反写到数据库中去。
    ''' </summary>
    ''' <param name="state"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function FormSynSQL(ByVal state As String, ByVal FID As Integer) As Integer
        Dim TmpState As Integer
        Select Case state
            Case "已完成"
                TmpState = -1
            Case "进行中"
                TmpState = 0
            Case "已取消"
                TmpState = -2
            Case Else
                Dim tb As New DataTable
                tb = DB.Table("Select cid,value from Xconfig where config='表单标签' and value='" & Me.SqlFilter(state) & "'", "dd")
                If tb.Rows.Count > 0 Then
                    TmpState = tb.Rows(0).Item(0)
                Else
                    TmpState = -100
                End If
        End Select
        If TmpState >= -2 Then
            DB.Query("update XX_XMJC set state=" & TmpState & " where fid=" & FID)
        End If
    End Function

    ''' <summary>
    ''' 同步表单状态
    ''' </summary>
    ''' <param name="Fid"></param>
    ''' <param name="MKMC"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function SynFormState(ByVal Fid As Integer, ByVal MKMC As String, ByVal Login_User As String) As String
        '从模板信息表中,得到当前模板的模板名
        Dim State As String
        Dim Row As DataRow = DB.Row("SELECT xmdm,lock,MKDM,state FROM XX_XMJC where fid=" & Fid, "XX_XMJC")
        If Row Is Nothing Then
            Return "表单不存在"
        End If
        Dim XMDM As String = Row.Item("XMDM").ToString
        Dim MKDM As String = Row.Item("MKDM").ToString
        State = Me.Form_State(Row.Item("state").ToString)

        Dim DFileName As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & "\" & Fid & ".xml"
        Dim TempFileName As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & ".库.xml"

        Try
            Dim Node As System.Xml.XmlNode = XmlClass.GetXmlFile(DFileName).ChildNodes(0)
            Dim Fid_NodeName As String = XmlClass.GetFormID
            XmlClass.UpdateNode("//" & Node.Name & "/" & Fid_NodeName.Replace("表单号", "标题") & "[" & Fid_NodeName & "='" & Fid & "']", Fid_NodeName.Replace("表单号", "状态"), State)
        Catch ex As Exception
            Return "更新表单出错"
        End Try

        Try
            Dim Node As System.Xml.XmlNode = XmlClass.GetXmlFile(TempFileName).ChildNodes(0)
            Dim Fid_NodeName As String = XmlClass.GetFormID
            XmlClass.UpdateNode("//" & Node.Name & "/" & Fid_NodeName.Replace("表单号", "标题") & "[" & Fid_NodeName & "='" & Fid & "']", Fid_NodeName.Replace("表单号", "状态"), State)
        Catch ex As Exception
            Return "更新库出错"
        End Try

        ''当是二维映射,或是开启同步标志.进行同步
        'If pub.GetWebConfig("SunfunSoft.Xman.FormLibrary.SQLMapping").ToLower = "true" Or pub.GetWebConfig("SunfunSoft.Xman.FormLibrary.Synchronization").ToLower = "true" Then
        '    '提交到服务，进行同步处理
        '    SynSubmit(Fid, "提交")
        'End If

        FormInfo.SubmitForm(Fid)

        UpdateOrderFormLog(Fid, GetUserID(Login_User), Login_User)           '调用订阅功能

        Return "OK"
    End Function


    ''' <summary>
    ''' 删除表单函数
    ''' </summary>
    ''' <param name="Fid"></param>
    ''' <remarks></remarks>
    Function DeleteForm(ByVal Fid As Integer, ByVal MKMC As String, ByVal UserID As Integer, ByVal Login_User As String)
        '从模板信息表中,得到当前模板的模板名
        Dim tb As New Data.DataTable

        tb = DB.Table("SELECT xmdm,lock,MKDM FROM XX_XMJC where fid=" & Fid, "XX_XMJC")
        If tb.Rows.Count <= 0 Then
            'Return "表示表单已经不存在"
            Return ""
        End If
        Dim XMDM As String = tb.Rows(0).Item(0)
        Dim MKDM As String = tb.Rows(0).Item(2)
        Dim Lock As Integer
        Try
            Lock = tb.Rows(0)(1)
        Catch ex As Exception
            Lock = 0
        End Try

        If Lock = 1 Then
            Return "此表单已经锁定,删除文件前请解锁"
            Exit Function
        End If
        tb = Nothing

        Dim DFileName As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & "\" & Fid & ".xml"

        '先删除数据库
        'DB.Query("delete GY_XMXX where XMDM = " & XMDM)
        'System_UserOp_Log(UserID, "delete GY_XMXX where XMDM = " & XMDM)
        'DB.Query("delete XX_XMJC where FID = " & Fid)
        'System_UserOp_Log(UserID, "delete XX_XMJC where FID = " & Fid)

        '只做删除标志  -100
        DB.Query("update XX_XMJC set state=-100 where FID = " & Fid)
        System_UserOp_Log(UserID, "update XX_XMJC set state=-100 where FID = " & Fid)
        DB.Query("update GY_XMXX set XMJD='已删除' where XMDM = " & XMDM)
        System_UserOp_Log(UserID, "update GY_XMXX set XMJD='已删除' where XMDM = " & XMDM)


        '当是二维映射,或是开启同步标志 时.进行同步删除
        If pub.GetWebConfig("SunfunSoft.Xman.FormLibrary.SQLMapping").ToLower = "true" Or pub.GetWebConfig("SunfunSoft.Xman.FormLibrary.Synchronization").ToLower = "true" Then
            DB.Query("delete [" & MKMC & "_Mapping] where fid=" & Fid)
            System_UserOp_Log(UserID, "delete [" & MKMC & "_Mapping] where fid=" & Fid)
            DB.Query("delete [" & MKMC & "_MapExt] where fid=" & Fid)
            System_UserOp_Log(UserID, "delete [" & MKMC & "_MapExt] where fid=" & Fid)
            '提交到服务，进行同步处理
            FormInfo.DelForm(Fid)
            'SynSubmit(Fid, "删除|" & MKMC)
            Return "处理完成"
        Else
            If pub.GetWebConfig("SunfunSoft.Xman.FormLibrary.IsSQL2005").ToLower = "true" Then
                DB.Query("Set ARITHABORT ON")      '因为要插入ＸＭＬ字段．所以必须先开起这个开关
                DB.Query("Delete FormLibrary_" & MKDM & " where fid = " & Fid)
                System_UserOp_Log(UserID, "Delete FormLibrary_" & MKDM & " where fid = " & Fid)
            Else
                '再删除库中的记录
                Dim TempFileName As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & ".库.xml"
                Try
                    Dim Node As System.Xml.XmlNode = XmlClass.GetXmlFile(TempFileName).ChildNodes(0)
                    Dim Fid_NodeName As String = XmlClass.GetFormID
                    XmlClass.DelNode("//" & Node.Name & "/" & Fid_NodeName.Replace("表单号", "标题") & "[" & Fid_NodeName & "='" & Fid & "']")
                Catch ex As Exception
                    Log(Login_User, "Form_Manage_NoLC.aspx", ex.Message.ToString(), Fid)
                End Try
            End If
            '再删除文件
            'Try
            '    If File.Exists(DFileName) = True Then
            '        File.Delete(DFileName)
            '        System_UserOp_Log(UserID, "删除文件:" & DFileName)
            '    End If
            '    DeleteAnnexFile(Fid, MKMC)
            'Catch ex As Exception
            '    Return "表单正在使用中,删除文件失败!"
            'End Try
        End If

    End Function
#End Region

    ''' <summary>
    ''' 返回结果
    ''' </summary>
    ''' <param name="ResultNodeName"></param>
    ''' <param name="ResultStr"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function RetError(ByVal ResultNodeName As String, ByVal ResultStr As String) As XmlDocument
        If ResultStr Is Nothing Then
            ResultStr = "null"
        End If
        Dim ResultXml As New XmlDocument
        ResultXml.LoadXml(ResultNodeName)
        ResultXml.DocumentElement.InnerXml = ResultStr
        Return ResultXml
    End Function

    ''' <summary>
    ''' 根据XPATH语句提取关键字,生成全文索引的SQL语句
    ''' </summary>
    ''' <param name="Xpath"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetFullTextSql(ByVal Xpath As String) As String
        Dim FullTextSql As New StringBuilder
        Dim Temp As System.Text.RegularExpressions.MatchCollection = System.Text.RegularExpressions.Regex.Matches(Xpath, "'[^']*'")
        Dim TempStr As String = String.Empty
        Dim i As Integer
        For i = 0 To Temp.Count - 1
            TempStr = Temp.Item(i).ToString.Trim
            If TempStr <> "" And TempStr <> "'通过'" And TempStr <> "'不通过'" And TempStr <> "''" And TempStr <> "'true'" And TempStr.Length > 3 Then
                '全文搜索的字符必须大于一个字符,加上''一定得大于三个字符
                If FullTextSql.Length = 0 Then FullTextSql.Append("( ")
                FullTextSql.Append("contains(Forms," & TempStr & ") or ")
            End If
        Next
        If FullTextSql.Length > 0 Then FullTextSql.Append(" 1<>1) and ")
        Return FullTextSql.ToString
    End Function

    ''' <summary>
    ''' 对命名空间进行替换,当用SQL2005时.主要应用于Webservice中
    ''' </summary>
    ''' <param name="Xpath"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function ReplaceNameSpaces(ByVal Xpath As String) As String
        'Dim ReplaceStr As String = pub.GetWebConfig("SunfunSoft.Xman.FormLibrary.SQL2005.NameSpacesReplaceString")
        'Dim Temp() As String
        'Dim i As Integer
        'Xpath = Xpath.ToLower
        'If ReplaceStr.Length > 0 Then
        '    Temp = ReplaceStr.ToLower.Split("|")
        '    For i = 0 To Temp.GetUpperBound(0)
        '        Xpath = Xpath.Replace(Temp(i), "*:")
        '    Next
        'End If
        Return (Xpath.Replace("'", "''"))
    End Function


    ''' <summary>
    ''' 对输入的库名进行转换为模板代码,主要应用于Webservice中
    ''' </summary>
    ''' <param name="KuName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetMKDM(ByVal KuName As String) As Integer
        Dim TempSql As String
        Dim Tb As New Data.DataTable
        TempSql = "SELECT MKDM FROM GY_MKXX where MKMC='" & KuName.Replace("'", "''") & "'"
        Try
            Tb = DB.Table(TempSql, "dd")
        Catch ex As Exception
            Return -1
        End Try
        If Tb.Rows.Count = 0 Then
            Return -1
        End If
        Return Tb.Rows(0)(0)
    End Function


    Function GetLCDMByMKDM(ByVal MKDM As Integer) As Integer
        Dim TempSql As String
        Dim Tb As New Data.DataTable
        TempSql = "SELECT NOLCDM FROM GY_MKXX where MKDM='" & MKDM & "'"
        Try
            Tb = DB.Table(TempSql, "dd")
        Catch ex As Exception
            Return -1
        End Try
        If Tb.Rows.Count = 0 Then
            Return -1
        End If
        Return Tb.Rows(0)(0)
    End Function


    ''' <summary>
    ''' 当在SQL里Query的查询语句出现模糊查询语句时,进行转换
    ''' </summary>
    ''' <param name="Xpath"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function ReplaceXpath_Contains(ByVal Xpath As String)
        '只对出现一次Contains的情况进行处理
        Xpath = Me.ReplaceXpath_substring(Xpath)            '先处理substring
        Dim TempXpath As String = Xpath
        Dim Idx As Integer = TempXpath.ToLower.IndexOf("contains")
        If Idx < 0 Then
            Return Xpath
        End If
        Dim TempStr As String = TempXpath.Substring(0, Idx)
        Dim Idx1 As Integer
        While Idx > 0
            TempXpath = TempXpath.Substring(Idx)        '去substring前面的部分,用来做临时
            Idx1 = TempXpath.IndexOf(",")
            Try
                TempStr += TempXpath.Substring(0, Idx1) & "[1]"     '添加"[1]"部分
            Catch ex As Exception       '如果出错
                TempStr = Xpath
            End Try
            TempXpath = TempXpath.Substring(Idx1)
            Idx = TempXpath.ToLower.IndexOf("substring")        '得到下一个substring的位置
            If Idx > 0 Then
                TempStr += TempXpath.Substring(0, Idx)  '添加二个substring之间的内容
            Else
                TempStr += TempXpath            '添加最后面,没有出现substring所留下来的内容
            End If
        End While
        Return TempStr
    End Function

    Function ReplaceXpath_substring(ByVal xpath)
        '只对出现N次Substring的情况进行处理
        Dim TempXpath As String = xpath
        Dim Idx As Integer = TempXpath.ToLower.IndexOf("substring")
        If Idx < 0 Then
            Return xpath
        End If
        Dim TempStr As String = TempXpath.Substring(0, Idx)
        Dim Idx1 As Integer
        While Idx > 0
            TempXpath = TempXpath.Substring(Idx)        '去substring前面的部分,用来做临时
            Idx1 = TempXpath.IndexOf(",")
            Try
                TempStr += TempXpath.Substring(0, Idx1) & "[1]"     '添加"[1]"部分
            Catch ex As Exception       '如果出错
                TempStr = xpath
            End Try
            TempXpath = TempXpath.Substring(Idx1)
            Idx = TempXpath.ToLower.IndexOf("substring")        '得到下一个substring的位置
            If Idx > 0 Then
                TempStr += TempXpath.Substring(0, Idx)  '添加二个substring之间的内容
            Else
                TempStr += TempXpath            '添加最后面,没有出现substring所留下来的内容
            End If
        End While
        Return TempStr
    End Function

#End Region



#Region "Ｘ－ＭＡＮ基本函数"

    ''' <summary>
    ''' 检测XMANCONFIG里,是不是显示的标志
    ''' </summary>
    ''' <param name="Xpath"></param>
    ''' <param name="Path"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetXmanConfigEnabled(ByVal Xpath As String, ByVal Path As String) As Boolean
        Dim Node As System.Xml.XmlNode = XmanConfig(Xpath, Path)
        If Node Is Nothing Then
            Return False
        Else
            If Node.Attributes("Enabled").Value.ToLower = "true" Then
                Return True
            Else
                Return False
            End If
        End If
    End Function

    ''' <summary>
    ''' 检测XMANCONFIG里,得到新的名称
    ''' </summary>
    ''' <param name="Xpath"></param>
    ''' <param name="Path"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetXmanConfigName(ByVal Xpath As String, ByVal Path As String) As String
        Dim Node As System.Xml.XmlNode = XmanConfig(Xpath, Path)
        If Node Is Nothing Then
            Return ""
        Else
            If Node.Attributes("Name") Is Nothing Then
                Return ""
            Else
                Return Node.Attributes("Name").Value.Trim
            End If
        End If
    End Function

    ''' <summary>
    ''' 读取XMAN的配置文件.返回查询结果
    ''' </summary>
    ''' <param name="Xpath"></param>
    ''' <param name="Path"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function XmanConfig(ByVal Xpath As String, ByVal Path As String) As XmlNode
        Dim FileName As String = Server.MapPath(Path)
        If FileName.Length = 0 Then Return Nothing
        Dim XmlDoc As New System.Xml.XmlDocument
        Try
            XmlDoc.Load(FileName & "/xman.config")
            Return XmlDoc.DocumentElement.SelectSingleNode(Xpath)
        Catch ex As Exception
            Return Nothing
        End Try
    End Function

    ''' <summary>
    ''' 读取XMAN的样式文件.返回查询结果
    ''' </summary>
    ''' <param name="Path"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetXmanStyleList(ByVal Path As String) As XmlNodeList
        Dim FileName As String = Server.MapPath(Path)
        If FileName.Length = 0 Then Return Nothing
        Dim XmlDoc As New System.Xml.XmlDocument
        Try
            XmlDoc.Load(FileName & "/Style.config")
        Catch ex As Exception
            Return Nothing
        End Try
        Return XmlDoc.DocumentElement.SelectNodes("/样式配置/样式列表")
    End Function

    ''' <summary>
    ''' 创建Gridview的标题栏
    ''' </summary>
    ''' <param name="Gridview1"></param>
    ''' <param name="LCDM"></param>
    ''' <param name="LCFlag">流程标志</param>
    ''' <remarks></remarks>
    Sub CreateGridviewTitle(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal LCFlag As Boolean)
        Dim TempTable As New Data.DataTable
        Dim i As Integer
        Dim tb As New Data.DataTable
        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")
        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Try
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim
                '过滤掉FID,项目状态,项目代码,防止出错
                If TempColumnName.Trim.ToUpper = "FID" Or TempColumnName.Trim.ToUpper = "项目状态" Or TempColumnName.Trim.ToUpper = "项目代码" Then
                    TempColumnName = TempColumnName.Trim.ToUpper & "1"
                End If
                Dim TempCell1 As New BoundField()
                TempCell1.HeaderText = TempColumnName
                TempCell1.DataField = TempColumnName
                TempCell1.SortExpression = TempColumnName
                Gridview1.Columns.Add(TempCell1)
            Catch ex As Exception
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Temp1 += 1
                Dim TempCell1 As New BoundField()
                TempCell1.HeaderText = TempColumnName
                TempCell1.DataField = TempColumnName
                TempCell1.SortExpression = TempColumnName
                Gridview1.Columns.Add(TempCell1)
            End Try
        Next



        '添加FID到Gridview1中。
        If LCFlag = True Then
            Dim TempCell1 As New BoundField()
            TempCell1.HeaderText = "项目状态"
            TempCell1.DataField = "项目状态"
            TempCell1.SortExpression = "项目状态"
            Gridview1.Columns.Add(TempCell1)

            Dim TempCell2 As New BoundField()
            TempCell2.HeaderText = "项目代码"
            TempCell2.DataField = "项目代码"
            TempCell2.SortExpression = "项目代码"
            Gridview1.Columns.Add(TempCell2)
        Else
            'Dim TempCell3 As New BoundField()
            'TempCell3.HeaderText = "表单状态"
            'TempCell3.DataField = "表单状态"
            'TempCell3.SortExpression = "表单状态"
            'Gridview1.Columns.Add(TempCell3)

            Dim TempCell As New BoundField()
            TempCell.HeaderText = "FID"
            TempCell.DataField = "FID"
            TempCell.SortExpression = "FID"
            Gridview1.Columns.Add(TempCell)
        End If

    End Sub
    ''' <summary>
    ''' 创建Gridview的标题栏(有自定义列)
    ''' </summary>
    ''' <param name="Gridview1"></param>
    ''' <param name="LCDM"></param>
    ''' <param name="LCFlag">流程标志</param>
    ''' <remarks></remarks>
    Sub CreateGridviewTitle_NEW(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal LCFlag As Boolean, ByVal mkdm As Integer)
        Dim TempTable As New Data.DataTable
        Dim i As Integer
        Dim tb As New Data.DataTable
        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")
        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Try
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim
                '过滤掉FID,项目状态,项目代码,防止出错
                If TempColumnName.Trim.ToUpper = "FID" Or TempColumnName.Trim.ToUpper = "项目状态" Or TempColumnName.Trim.ToUpper = "项目代码" Then
                    TempColumnName = TempColumnName.Trim.ToUpper & "1"
                End If
                Dim TempCell1 As New BoundField()
                TempCell1.HeaderText = TempColumnName
                TempCell1.DataField = TempColumnName
                TempCell1.SortExpression = TempColumnName
                Gridview1.Columns.Add(TempCell1)
            Catch ex As Exception
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Temp1 += 1
                Dim TempCell1 As New BoundField()
                TempCell1.HeaderText = TempColumnName
                TempCell1.DataField = TempColumnName
                TempCell1.SortExpression = TempColumnName
                Gridview1.Columns.Add(TempCell1)
            End Try
        Next



        '添加FID到Gridview1中。
        If LCFlag = True Then
            Dim TempCell1 As New BoundField()
            TempCell1.HeaderText = "项目状态"
            TempCell1.DataField = "项目状态"
            TempCell1.SortExpression = "项目状态"
            Gridview1.Columns.Add(TempCell1)

            Dim TempCell2 As New BoundField()
            TempCell2.HeaderText = "项目代码"
            TempCell2.DataField = "项目代码"
            TempCell2.SortExpression = "项目代码"
            Gridview1.Columns.Add(TempCell2)
        Else
            'Dim TempCell3 As New BoundField()
            'TempCell3.HeaderText = "表单状态"
            'TempCell3.DataField = "表单状态"
            'TempCell3.SortExpression = "表单状态"
            'Gridview1.Columns.Add(TempCell3)

            'Dim TempCell As New BoundField()
            'TempCell.HeaderText = "FID"
            'TempCell.DataField = "FID"
            'TempCell.SortExpression = "FID"
            'Gridview1.Columns.Add(TempCell)
            'Gridview1.Columns.Add(TempCell)
            'Gridview1.Columns.Add(TempCell)
        End If
        '添加自定义列
        Dim columndt As New DataTable
        columndt = DB.Table("select * from [MapConfig_link] where mkdm=" & mkdm & "", "aaa")
        If columndt.Rows.Count > 0 Then
            Dim k As Integer
            For k = 0 To columndt.Rows.Count - 1
                Dim TempCell As New BoundField()
                TempCell.HeaderText = columndt.Rows(k)("ColumnName").ToString
                ' TempCell.DataField = columndt.Rows(k)("ColumnName").ToString
                ' TempCell.SortExpression = "FID"
                Gridview1.Columns.Add(TempCell)
            Next
        End If


    End Sub
    ''' <summary>
    ''' 在报表浏览方式下的创建Gridview的标题目栏
    ''' </summary>
    ''' <param name="Gridview1"></param>
    ''' <param name="LCDM"></param>
    ''' <param name="LCFlag"></param>
    ''' <remarks></remarks>
    Sub CreateGridviewTitle_Reports(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal LCFlag As Boolean)
        Dim TempTable As New Data.DataTable
        Dim i As Integer
        Dim tb As New Data.DataTable
        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ReportsList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        If ShowTb.Rows.Count = 0 Then       '假如为报表方式为空时.则直接显示普通方式下的
            ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        End If
        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Try
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim
                '过滤掉FID,项目状态,项目代码,防止出错
                If TempColumnName.Trim.ToUpper = "FID" Or TempColumnName.Trim.ToUpper = "项目状态" Or TempColumnName.Trim.ToUpper = "项目代码" Then
                    TempColumnName = TempColumnName.Trim.ToUpper & "1"
                End If
                Dim TempCell1 As New BoundField()
                TempCell1.HeaderText = TempColumnName
                TempCell1.DataField = TempColumnName
                TempCell1.SortExpression = TempColumnName
                Gridview1.Columns.Add(TempCell1)
            Catch ex As Exception
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Temp1 += 1
                Dim TempCell1 As New BoundField()
                TempCell1.HeaderText = TempColumnName
                TempCell1.DataField = TempColumnName
                TempCell1.SortExpression = TempColumnName
                Gridview1.Columns.Add(TempCell1)
            End Try
        Next
        '添加FID到Gridview1中。
        If LCFlag = True Then
            Dim TempCell1 As New BoundField()
            TempCell1.HeaderText = "项目状态"
            TempCell1.DataField = "项目状态"
            TempCell1.SortExpression = "项目状态"
            Gridview1.Columns.Add(TempCell1)

            Dim TempCell2 As New BoundField()
            TempCell2.HeaderText = "项目代码"
            TempCell2.DataField = "项目代码"
            TempCell2.SortExpression = "项目代码"
            Gridview1.Columns.Add(TempCell2)
        Else
            Dim TempCell As New BoundField()
            TempCell.HeaderText = "FID"
            TempCell.DataField = "FID"
            TempCell.SortExpression = "FID"
            Gridview1.Columns.Add(TempCell)
        End If

    End Sub

    Sub CreateGridviewTitle_ReportsEdit(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal LCFlag As Boolean)
        Dim TempTable As New Data.DataTable
        Dim i As Integer
        Dim tb As New Data.DataTable
        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ReportsList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        If ShowTb.Rows.Count = 0 Then       '假如为报表方式为空时.则直接显示普通方式下的
            ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        End If
        Dim Temp1 As Integer = 1

        Gridview1.Columns.Clear()


        For i = 0 To ShowTb.Rows.Count - 1
            'Try
            Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim
            '过滤掉FID,项目状态,项目代码,防止出错
            If TempColumnName.Trim.ToUpper = "FID" Or TempColumnName.Trim.ToUpper = "项目状态" Or TempColumnName.Trim.ToUpper = "项目代码" Then
                TempColumnName = TempColumnName.Trim.ToUpper & "1"
            End If

            Dim customField As New TemplateField
            customField.HeaderText = TempColumnName
            customField.SortExpression = TempColumnName
            customField.ItemTemplate = New GridViewTemplate("textbox", TempColumnName)
            'If i = 0 Then
            '    Dim customField1 As New TemplateField
            '    customField1.HeaderText = ""
            '    customField1.SortExpression = ""
            '    customField1.ItemTemplate = New GridViewTemplate("linkbutton", "LinkSingle")
            '    Gridview1.Columns.Add(customField1)
            'End If
            Gridview1.Columns.Add(customField)
        Next
        '添加FID到Gridview1中。
        If LCFlag = True Then

            'Dim customField As New TemplateField
            'customField.HeaderText = "项目状态"
            'customField.SortExpression = "项目状态"
            'customField.ItemTemplate = New GridViewTemplate("textbox", "项目状态")
            'Gridview1.Columns.Add(customField)

            Dim TempCell1 As New BoundField()
            TempCell1.HeaderText = "项目状态"
            TempCell1.DataField = "项目状态"
            TempCell1.SortExpression = "项目状态"
            Gridview1.Columns.Add(TempCell1)

            'customField.HeaderText = "项目代码"
            'customField.SortExpression = "项目代码"
            'customField.ItemTemplate = New GridViewTemplate("textbox", "项目代码")
            'Gridview1.Columns.Add(customField)

            Dim TempCell2 As New BoundField()
            TempCell2.HeaderText = "项目代码"
            TempCell2.DataField = "项目代码"
            TempCell2.SortExpression = "项目代码"
            Gridview1.Columns.Add(TempCell2)
        Else
            'Dim customField As New TemplateField
            'customField.HeaderText = "FID"
            'customField.SortExpression = "FID"
            'customField.ItemTemplate = New GridViewTemplate("textbox", "FID")
            'Gridview1.Columns.Add(customField)

            Dim TempCell As New BoundField()
            TempCell.HeaderText = "FID"
            TempCell.DataField = "FID"
            TempCell.SortExpression = "FID"
            Gridview1.Columns.Add(TempCell)
        End If
    End Sub


    ''' <summary>
    ''' 填充Gridview数据,无流程只填充FID,有流程填充项目代码和流程状态
    ''' </summary>
    ''' <param name="Gridview1"></param>
    ''' <param name="LCDM"></param>
    ''' <param name="SqlQuerry"></param>
    ''' <param name="SelectSQL"></param>
    ''' <param name="SortName"></param>
    ''' <param name="LCFlag"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function FillDataToGridview(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal SqlQuerry As String, ByVal SelectSQL As String, ByVal SortName As String, ByVal LCFlag As Boolean) As Data.DataTable
        Dim TempTable As New Data.DataTable
        Dim MaxTitle As Integer = 0
        Dim i, j As Integer
        Dim tb As New Data.DataTable

        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")
        MaxTitle = ShowTb.Rows.Count

        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Try
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim
                '过滤掉FID,项目状态,项目代码,防止出错
                If TempColumnName.Trim.ToUpper = "FID" Or TempColumnName.Trim.ToUpper = "项目状态" Or TempColumnName.Trim.ToUpper = "项目代码" Then
                    TempColumnName = TempColumnName.Trim.ToUpper & "1"
                End If
                Dim c As DataColumn = New DataColumn(TempColumnName)
                If TempColumnName = "客户编号" Then
                    c.DataType = System.Type.GetType("System.Double")
                End If
                TempTable.Columns.Add(c)
            Catch ex As Exception
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Dim c As DataColumn = New DataColumn(TempColumnName)
                TempTable.Columns.Add(c)
                Temp1 += 1
            End Try
        Next

        '添加FID到Gridview1中。
        If LCFlag = True Then
            Dim c1 As DataColumn = New DataColumn("项目状态")
            TempTable.Columns.Add(c1)
            Dim c2 As DataColumn = New DataColumn("项目代码")
            TempTable.Columns.Add(c2)
        Else
            'Dim c3 As DataColumn = New DataColumn("表单状态")
            'TempTable.Columns.Add(c3)
            Dim c2 As DataColumn = New DataColumn("FID")
            TempTable.Columns.Add(c2)
        End If

        Dim mkdm As Integer
        tb = DB.Table("select MKDM from GY_MKXX where nolcdm = " & LCDM, "dd")
        If tb.Rows.Count <= 0 Then
            _ErrMessage = "功能模板有问题!"
            Return Nothing
            Exit Function
        Else
            mkdm = tb.Rows(0).Item(0)
        End If

        Dim BaseUrl As String
        Dim MKMC As String

        If LCFlag = True Then       '如果是有注程的。则MKMC要在下面得到。
            BaseUrl = Server.MapPath("../../") & "FormFolder/"
        Else
            tb = DB.Table("SELECT MKMC,XsnDir FROM GY_MKXX where NoLcDM =" & LCDM, "GY_MKXX")
            If tb.Rows.Count <= 0 Then
                _ErrMessage = "功能模板有问题!"
                Return Nothing
                Exit Function
            End If
            MKMC = tb.Rows(0).Item("mkmc").ToString().Trim()

            BaseUrl = Server.MapPath("../../") & "FormFolder/" & MKMC & "/"
        End If
        Dim FileName As String = ""

        Dim Sql As String = SelectSQL
        If SqlQuerry.Trim.Length > 0 Then

            Dim hastable As Boolean = True

            Dim tablename As String = MKMC & "_MapSearch "
            Try
                tb = DB.Table("select top 1 cid from " & tablename, "dd")
                hastable = True
            Catch ex As Exception
                hastable = False
            End Try



            Dim Ls As String()
            Ls = SqlQuerry.Replace("'", "''").Trim.Split(" ")
            SqlQuerry = ""
            For i = 0 To Ls.GetUpperBound(0)
                If SqlQuerry.Length > 0 Then
                    If hastable = True Then


                        SqlQuerry = SqlQuerry & "And FormID in ( SELECT FormID FROM " & tablename & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%' GROUP BY FormID)"

                    Else
                        SqlQuerry = SqlQuerry & " and XMDM in(SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%' and mkdm=" & mkdm & ")"
                    End If
                Else
                    If hastable = True Then
                        SqlQuerry = "SELECT FormID FROM " & tablename & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                        'SqlQuerry = "SELECT XMDM FROM " & tablename & " WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    Else
                        SqlQuerry = "SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%' and mkdm =" & mkdm
                    End If
                End If
                If i > 2 Then Exit For
            Next
            Sql += "  And XX_XMJC.FID in ( " & SqlQuerry & " GROUP BY FormID) "
        End If
        If LCFlag = False Then      '暂时时有流程没有置顶功能
            Sql = Sql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交' order by TopNum DESC,GY_XMXX.XMDM desc"
        Else
            Sql = Sql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交' order by GY_XMXX.XMDM desc"
        End If

        Dim Fid, XMDM As String
        tb = DB.Table(Sql, "GY_XMXX")
        For i = 0 To tb.Rows.Count - 1
            Dim NewRow As DataRow = TempTable.NewRow()
            If LCFlag = False Then
                Fid = tb.Rows(i).Item(0).ToString.Trim
                FileName = BaseUrl & Fid & ".xml"
                NewRow(MaxTitle) = Fid
                'NewRow(MaxTitle + 1) = Fid
                'NewRow(MaxTitle) = Form_State(tb.Rows(i)("state").ToString.Trim)
            Else
                XMDM = tb.Rows(i).Item(0).ToString.Trim
                NewRow(ShowTb.Rows.Count) = tb.Rows(i).Item(4).ToString.Trim
                NewRow(ShowTb.Rows.Count + 1) = XMDM
                Dim TempTb As New Data.DataTable
                TempTb = DB.Table("SELECT GY_MKXX.MKMC,XX_XMJC.Fid FROM XX_XMJC,GY_MKXX where GY_MKXX.MKDM=XX_XMJC.MKDM and XX_XMJC.XMDM=" & XMDM, "GY_MKXX")
                If TempTb.Rows.Count = 0 Then
                    For j = 0 To ShowTb.Rows.Count - 1
                        NewRow(j) = "空"
                    Next
                Else
                    FileName = BaseUrl & TempTb.Rows(0).Item(0) & "/" & TempTb.Rows(0).Item(1) & ".xml"
                End If
            End If

            If SortName.Trim <> "" Then
                If XmlClass.GetXmlFile(FileName) Is Nothing Then
                    '表示找不到记录，则显示空记录
                    For j = 0 To ShowTb.Rows.Count - 1
                        Try
                            NewRow(j) = "空"
                        Catch ex As Exception
                        End Try

                    Next
                Else
                    '再列自定义的列
                    For j = 0 To ShowTb.Rows.Count - 1
                        If ShowTb.Rows(j).Item(0).ToString.Trim = SortName And SortName <> "FID" Then
                            '当不是排序列,或是为FID时,不进行处理.
                            Dim dd As System.Xml.XmlNode = XmlClass.FindNode("//" & ShowTb.Rows(j).Item(1).ToString.Replace("<", "").Replace(">", ""))
                            If dd Is Nothing Then
                                NewRow(j) = "空"
                            Else
                                If dd.ChildNodes.Item(0) Is Nothing Then
                                    NewRow(j) = "空"
                                Else
                                    If dd.ChildNodes.Item(0).Value Is Nothing Then
                                        If dd.HasChildNodes = True Then     '当是父节点.但是存在子节点时.则显示子节点的内容(或是超文本框)
                                            Dim TempOut As String = dd.ChildNodes.Item(0).OuterXml.ToString.Trim
                                            If TempOut.Length >= 100 Then
                                                NewRow(j) = Server.HtmlEncode(TempOut.Substring(0, 98)) & "..."
                                            Else
                                                NewRow(j) = Server.HtmlEncode(TempOut)
                                            End If
                                        Else
                                            NewRow(j) = "空"
                                        End If
                                    Else
                                        If dd.ChildNodes.Item(0).Value.ToString.Trim.Length >= 100 Then
                                            NewRow(j) = Server.HtmlEncode(dd.ChildNodes.Item(0).Value.ToString.Substring(0, 98)) & "..."
                                        Else
                                            NewRow(j) = Server.HtmlEncode(dd.ChildNodes.Item(0).Value)
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    Next
                End If
            End If
            TempTable.Rows.Add(NewRow)      '将列添加到表中
        Next
        Gridview1.DataSource = TempTable
        'Gridview1.Columns(Gridview1.Columns.Count - 1).Visible = False
        Return TempTable
    End Function


    ''' <summary>
    ''' 填充Gridview数据,无流程只填充FID,有流程填充项目代码和流程状态
    ''' </summary>
    ''' <param name="Gridview1"></param>
    ''' <param name="LCDM"></param>
    ''' <param name="SqlQuerry"></param>
    ''' <param name="SelectSQL"></param>
    ''' <param name="LCFlag"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function FillDataToGridviewBySQL(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal SqlQuerry As String, ByVal SelectSQL As String, ByVal LCFlag As Boolean) As Data.DataTable
        Dim TempTable As New Data.DataTable
        Dim MaxTitle As Integer = 0
        Dim tableName As String
        Dim i, j As Integer
        Dim tb As New Data.DataTable
        Dim userid As Integer
        Dim tempdt As New Data.DataTable
        Dim mkmc As String

        tempdt = DB.Table("select * from gy_lcdm where lcdm = " & LCDM, "tempdt")
        If tempdt.Rows.Count > 0 Then
            mkmc = tempdt.Rows(0).Item("LCMC").ToString
            tableName = tempdt.Rows(0).Item("LCMC").ToString
        End If

        tableName = tableName & "_mapext"   '获取表单名称

        '得到个性化配置
        Dim strOrder As String = String.Empty
        Dim strWhere As String = String.Empty
        userid = GetUserID(Me.GetWebUserName) '获取当前用户ID

        tempdt = DB.Table("select config,value from xconfig where userid = " & userid & " and lcdm = " & LCDM & " and config='排序方式'", "config")
        If tempdt.Rows.Count > 0 Then
            For i = 0 To tempdt.Rows.Count - 1
                strOrder = strOrder & tempdt.Rows(i).Item("value").ToString.Replace("#", "'") & ","
            Next
        Else
            tempdt = DB.Table("select config,value from xconfig where lcdm = " & LCDM & " and config='排序方式全局'", "config")
            If tempdt.Rows.Count > 0 Then
                For i = 0 To tempdt.Rows.Count - 1
                    strOrder = strOrder & tempdt.Rows(i).Item("value").ToString.Replace("#", "'") & ","
                Next
            End If
        End If

        tempdt = DB.Table("select config,value from xconfig where userid = " & userid & " and lcdm = " & LCDM & " and config='过滤方式'", "config")
        If tempdt.Rows.Count > 0 Then
            For i = 0 To tempdt.Rows.Count - 1
                strWhere = strWhere & " and " & tempdt.Rows(i).Item("value").ToString.Replace("#", "'")
            Next
        Else
            tempdt = DB.Table("select config,value from xconfig where lcdm = " & LCDM & " and config='过滤方式全局'", "config")
            If tempdt.Rows.Count > 0 Then
                For i = 0 To tempdt.Rows.Count - 1
                    strWhere = strWhere & " and " & tempdt.Rows(i).Item("value").ToString.Replace("#", "'")
                Next
            End If
        End If

        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")
        MaxTitle = ShowTb.Rows.Count

        Dim Sql As String
        Sql = "select " & tableName & ".fid as fid," & tableName & ".fid as 项目代码 "
        If MaxTitle <> 0 Then
            Sql = Sql & ", "
        End If

        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Dim showname As String = ShowTb.Rows(i).Item(0).ToString.Trim
            Dim nodename As String = ShowTb.Rows(i).Item(1).ToString.Trim.Replace("<", "").Replace(":", "").Replace(">", "")
            '过滤掉FID,项目状态,项目代码,防止出错
            Try
                If showname.Trim.ToUpper = "FID" Or showname.Trim.ToUpper = "项目状态" Or showname.Trim.ToUpper = "项目代码" Then
                    showname = showname.Trim.ToUpper & "1"
                End If
            Catch ex As Exception
                showname = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Temp1 += 1
            End Try
            '构建SQL语句的select部分
            If i = ShowTb.Rows.Count - 1 Then
                Sql = Sql & tableName & "." & nodename & " as " & showname
            Else
                Sql = Sql & tableName & "." & nodename & " as " & showname & ","
            End If
        Next

        Sql = Sql & " from " & tableName & ","    '创建FROM


        Dim tempSql As String = SelectSQL
        If SqlQuerry.Trim.Length > 0 Then

            Dim hastable As Boolean = True
            Dim searchTable As String = mkmc & "_MapSearch "

            Try
                tb = DB.Table("select top 1 cid from " & searchTable, "dd")
                hastable = True
            Catch ex As Exception
                hastable = False
            End Try



            Dim Ls As String()
            Ls = SqlQuerry.Replace("'", "''").Trim.Split(" ")
            SqlQuerry = ""
            For i = 0 To Ls.GetUpperBound(0)
                If SqlQuerry.Length > 0 Then
                    If hastable = True Then
                        SqlQuerry = SqlQuerry & "And FormID in ( SELECT FormID FROM " & searchTable & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%' GROUP BY FormID)"
                    Else
                        SqlQuerry = SqlQuerry & " and XMDM in(SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%')"
                    End If

                Else
                    If hastable = True Then
                        SqlQuerry = "SELECT FormID FROM " & searchTable & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    Else
                        SqlQuerry = "SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    End If
                End If
                If i > 2 Then Exit For
            Next
            If hastable = True Then
                tempSql += "  And XX_XMJC.FID in ( " & SqlQuerry & " GROUP BY FormID) "
            Else
                tempSql += "  And GY_XMXX.XMDM in ( " & SqlQuerry & " GROUP BY XMDM) "
            End If

        End If
        If LCFlag = False Then      '暂时时有流程没有置顶功能
            tempSql = tempSql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交'"
        Else
            tempSql = tempSql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交'"
        End If

        tempSql = tempSql.Replace("SELECT XX_XMJC.FID FROM ", "").Replace("SELECT XX_XMJC.FID,GY_XMXX.XMDM,XX_XMJC.state FROM ", "") '对原先传递进来的数据进行处理，以构建一条完整的SQL语句

        Sql = Sql & tempSql & " and " & tableName & ".fid = xx_xmjc.fid"  '增加限制条件
        Sql = Sql & strWhere '增加自定义条件


        Sql = Sql & " order by "
        If LCFlag = False Then      '暂时时有流程没有置顶功能
            Sql = Sql & " TopNum DESC,"
            'Else
            '    Sql = Sql & " fid desc"
        End If
        Sql = Sql & strOrder & " fid desc"  '增加自定义排序条件
        ''说明：排序方式按置顶>自定义>FID的顺序

        TempTable = DB.Table(Sql, "dd")
        Return TempTable
    End Function




    Function FillDataToGridviewBySQLWithAadvancedSearch(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal SqlQuerry As String, ByVal SelectSQL As String, ByVal LCFlag As Boolean, ByVal advancedSearchStr As String) As Data.DataTable
        Dim TempTable As New Data.DataTable
        Dim MaxTitle As Integer = 0
        Dim tableName As String
        Dim i, j As Integer
        Dim tb As New Data.DataTable
        Dim userid As Integer
        Dim tempdt As New Data.DataTable
        Dim mkmc As String
        tempdt = DB.Table("select * from gy_lcdm where lcdm = " & LCDM, "tempdt")
        If tempdt.Rows.Count > 0 Then
            mkmc = tempdt.Rows(0).Item("LCMC").ToString
            tableName = tempdt.Rows(0).Item("LCMC").ToString
        End If

        tableName = tableName & "_mapext"   '获取表单名称

        '得到个性化配置
        Dim strOrder As String = String.Empty
        Dim strWhere As String = String.Empty
        userid = GetUserID(Me.GetWebUserName) '获取当前用户ID

        tempdt = DB.Table("select config,value from xconfig where userid = " & userid & " and lcdm = " & LCDM & " and config='排序方式'", "config")
        If tempdt.Rows.Count > 0 Then
            For i = 0 To tempdt.Rows.Count - 1
                strOrder = strOrder & tempdt.Rows(i).Item("value").ToString.Replace("#", "'") & ","
            Next
        Else
            tempdt = DB.Table("select config,value from xconfig where lcdm = " & LCDM & " and config='排序方式全局'", "config")
            If tempdt.Rows.Count > 0 Then
                For i = 0 To tempdt.Rows.Count - 1
                    strOrder = strOrder & tempdt.Rows(i).Item("value").ToString.Replace("#", "'") & ","
                Next
            End If
        End If

        tempdt = DB.Table("select config,value from xconfig where userid = " & userid & " and lcdm = " & LCDM & " and config='过滤方式'", "config")
        If tempdt.Rows.Count > 0 Then
            For i = 0 To tempdt.Rows.Count - 1
                strWhere = strWhere & " and " & tempdt.Rows(i).Item("value").ToString.Replace("#", "'")
            Next
        Else
            tempdt = DB.Table("select config,value from xconfig where lcdm = " & LCDM & " and config='过滤方式全局'", "config")
            If tempdt.Rows.Count > 0 Then
                For i = 0 To tempdt.Rows.Count - 1
                    strWhere = strWhere & " and " & tempdt.Rows(i).Item("value").ToString.Replace("#", "'")
                Next
            End If
        End If

        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")
        MaxTitle = ShowTb.Rows.Count

        Dim Sql As String
        Sql = "select " & tableName & ".fid as fid," & tableName & ".fid as 项目代码 "
        If MaxTitle <> 0 Then
            Sql = Sql & ", "
        End If

        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Dim showname As String = ShowTb.Rows(i).Item(0).ToString.Trim
            Dim nodename As String = ShowTb.Rows(i).Item(1).ToString.Trim.Replace("<", "").Replace(":", "").Replace(">", "")
            '过滤掉FID,项目状态,项目代码,防止出错
            Try
                If showname.Trim.ToUpper = "FID" Or showname.Trim.ToUpper = "项目状态" Or showname.Trim.ToUpper = "项目代码" Then
                    showname = showname.Trim.ToUpper & "1"
                End If
            Catch ex As Exception
                showname = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Temp1 += 1
            End Try
            '构建SQL语句的select部分
            If i = ShowTb.Rows.Count - 1 Then
                Sql = Sql & tableName & "." & nodename & " as " & showname
            Else
                Sql = Sql & tableName & "." & nodename & " as " & showname & ","
            End If
        Next

        Sql = Sql & " from " & tableName & ","    '创建FROM


        Dim tempSql As String = SelectSQL
        If SqlQuerry.Trim.Length > 0 Then
            Dim hastable As Boolean = True
            Dim searchTable As String = mkmc & "_MapSearch "

            Try
                tb = DB.Table("select top 1 cid from " & searchTable, "dd")
                hastable = True
            Catch ex As Exception
                hastable = False
            End Try



            Dim Ls As String()
            Ls = SqlQuerry.Replace("'", "''").Trim.Split(" ")
            SqlQuerry = ""
            For i = 0 To Ls.GetUpperBound(0)
                If SqlQuerry.Length > 0 Then
                    If hastable = True Then
                        SqlQuerry = SqlQuerry & "And FormID in ( SELECT FormID FROM " & searchTable & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%' GROUP BY FormID)"
                    Else
                        SqlQuerry = SqlQuerry & " and XMDM in(SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%')"
                    End If

                Else
                    If hastable = True Then
                        SqlQuerry = "SELECT FormID FROM " & searchTable & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    Else
                        SqlQuerry = "SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    End If
                End If
                If i > 2 Then Exit For
            Next
            If hastable = True Then
                tempSql += "  And XX_XMJC.FID in ( " & SqlQuerry & " GROUP BY FormID) "
            Else
                tempSql += "  And GY_XMXX.XMDM in ( " & SqlQuerry & " GROUP BY XMDM) "
            End If
        End If
        If LCFlag = False Then      '暂时时有流程没有置顶功能
            tempSql = tempSql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交'"
        Else
            tempSql = tempSql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交'"
        End If

        tempSql = tempSql.Replace("SELECT XX_XMJC.FID FROM ", "") '对原先传递进来的数据进行处理，以构建一条完整的SQL语句

        Sql = Sql & tempSql & " and " & tableName & ".fid = xx_xmjc.fid"  '增加限制条件
        Sql = Sql & strWhere '增加自定义条件
        Sql = Sql & advancedSearchStr

        Sql = Sql & " order by "
        If LCFlag = False Then      '暂时时有流程没有置顶功能
            Sql = Sql & " TopNum DESC,"
            'Else
            '    Sql = Sql & " fid desc"
        End If
        Sql = Sql & strOrder & " fid desc"  '增加自定义排序条件
        ''说明：排序方式按置顶>自定义>FID的顺序

        TempTable = DB.Table(Sql, "dd")
        Return TempTable
    End Function

    ''' <summary>
    ''' 获取高级显示列表的总数量
    ''' </summary>
    ''' <param name="thisMKDM">当前列表的MKDM</param>
    ''' <param name="upMKDM">继承列表的MKDM</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function getAdvanceShowListCount(ByVal userid As Integer, ByVal thisMKDM As Integer, ByVal upMKDM As Integer) As Integer
        Dim tempdt As New DataTable
        Dim tableName As String
        Dim lcdm As Integer
        tempdt = DB.Table("select mkmc,nolcdm from gy_mkxx where mkdm = " & upMKDM, "tempdt")
        If tempdt.Rows.Count > 0 Then
            tableName = tempdt.Rows(0).Item("MKMC").ToString
            lcdm = tempdt.Rows(0).Item("nolcdm")
        End If



        tableName = tableName & "_mapext"   '获取表单名称

        Dim tempsql As String
        If CheckListFormQX_LCDM(userid, lcdm) = True Then
            tempsql = "XX_XMJC.XMDM = GY_XMXX.XMDM and (GY_XMXX.XMJD is not null)  and (state<>-100 or state is null and state<>-17 )"
        Else
            tempsql = "((XX_XMJC.XMDM = GY_XMXX.XMDM And GY_XMXX.LCDM=" & GetLCDMByMKDM(upMKDM) & " and (GY_XMXX.XMJD is not null) and GY_XMXX.XMSM='" & GetUserName(userid, 1) & "') and (state<>-100 or state is null)   or (XX_XMJC.MKDM = " & upMKDM & " and XX_XMJC.XMDM = GY_XMXX.XMDM and (GY_XMXX.XMJD is not null) and " & tableName & ".fid in (select FID from GY_XmXD where YGDM=" & userid & ") )  and (state<>-100 or state is null) and state<>-17 )"

        End If



        Dim sql As String

        sql = "select count(*) from " & tableName & ",GY_XMXX,XX_XMJC where XX_XMJC.MKDM = " & upMKDM & " and " & tempsql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交' and " & tableName & ".fid = xx_xmjc.fid "

        sql = sql & getshowListFilter(thisMKDM)

        Dim count As Integer
        Try
            tempdt = DB.Table(sql, "dd")
            count = tempdt.Rows(0).Item(0)
        Catch ex As Exception

            count = 0
        End Try

        Return count




    End Function

    Function FillDataToGridviewBySQLWithAadvancedSearchAndShowListFilter(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal SqlQuerry As String, ByVal SelectSQL As String, ByVal LCFlag As Boolean, ByVal advancedSearchStr As String, ByVal showlistFilterStr As String) As Data.DataTable
        Dim TempTable As New Data.DataTable
        Dim MaxTitle As Integer = 0
        Dim tableName As String
        Dim i, j As Integer
        Dim tb As New Data.DataTable
        Dim userid As Integer
        Dim tempdt As New Data.DataTable
        Dim mkmc As String
        tempdt = DB.Table("select * from gy_lcdm where lcdm = " & LCDM, "tempdt")
        If tempdt.Rows.Count > 0 Then
            mkmc = tempdt.Rows(0).Item("LCMC").ToString()
            tableName = tempdt.Rows(0).Item("LCMC").ToString
        End If

        tableName = tableName & "_mapext"   '获取表单名称

        '得到个性化配置
        '得到个性化配置
        Dim strOrder As String = String.Empty
        Dim strWhere As String = String.Empty
        userid = GetUserID(Me.GetWebUserName) '获取当前用户ID

        tempdt = DB.Table("select config,value from xconfig where userid = " & userid & " and lcdm = " & LCDM & " and config='排序方式'", "config")
        If tempdt.Rows.Count > 0 Then
            For i = 0 To tempdt.Rows.Count - 1
                strOrder = strOrder & tempdt.Rows(i).Item("value").ToString.Replace("#", "'") & ","
            Next
        Else
            tempdt = DB.Table("select config,value from xconfig where lcdm = " & LCDM & " and config='排序方式全局'", "config")
            If tempdt.Rows.Count > 0 Then
                For i = 0 To tempdt.Rows.Count - 1
                    strOrder = strOrder & tempdt.Rows(i).Item("value").ToString.Replace("#", "'") & ","
                Next
            End If
        End If

        tempdt = DB.Table("select config,value from xconfig where userid = " & userid & " and lcdm = " & LCDM & " and config='过滤方式'", "config")
        If tempdt.Rows.Count > 0 Then
            For i = 0 To tempdt.Rows.Count - 1
                strWhere = strWhere & " and " & tempdt.Rows(i).Item("value").ToString.Replace("#", "'")
            Next
        Else
            tempdt = DB.Table("select config,value from xconfig where lcdm = " & LCDM & " and config='过滤方式全局'", "config")
            If tempdt.Rows.Count > 0 Then
                For i = 0 To tempdt.Rows.Count - 1
                    strWhere = strWhere & " and " & tempdt.Rows(i).Item("value").ToString.Replace("#", "'")
                Next
            End If
        End If

        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")
        MaxTitle = ShowTb.Rows.Count

        Dim Sql As String
        Sql = "select " & tableName & ".fid as fid," & tableName & ".fid as 项目代码 "
        If MaxTitle <> 0 Then
            Sql = Sql & ", "
        End If

        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Dim showname As String = ShowTb.Rows(i).Item(0).ToString.Trim
            Dim nodename As String = ShowTb.Rows(i).Item(1).ToString.Trim.Replace("<", "").Replace(":", "").Replace(">", "")
            '过滤掉FID,项目状态,项目代码,防止出错
            Try
                If showname.Trim.ToUpper = "FID" Or showname.Trim.ToUpper = "项目状态" Or showname.Trim.ToUpper = "项目代码" Then
                    showname = showname.Trim.ToUpper & "1"
                End If
            Catch ex As Exception
                showname = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Temp1 += 1
            End Try
            '构建SQL语句的select部分
            If i = ShowTb.Rows.Count - 1 Then
                Sql = Sql & tableName & "." & nodename & " as " & showname
            Else
                Sql = Sql & tableName & "." & nodename & " as " & showname & ","
            End If
        Next

        Sql = Sql & " from " & tableName & ","    '创建FROM


        Dim tempSql As String = SelectSQL
        If SqlQuerry.Trim.Length > 0 Then
            Dim hastable As Boolean = True
            Dim searchTable As String = mkmc & "_MapSearch "

            Try
                tb = DB.Table("select top 1 cid from " & searchTable, "dd")
                hastable = True
            Catch ex As Exception
                hastable = False
            End Try



            Dim Ls As String()
            Ls = SqlQuerry.Replace("'", "''").Trim.Split(" ")
            SqlQuerry = ""
            For i = 0 To Ls.GetUpperBound(0)
                If SqlQuerry.Length > 0 Then
                    If hastable = True Then
                        SqlQuerry = SqlQuerry & "And FormID in ( SELECT FormID FROM " & searchTable & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%' GROUP BY FormID)"
                    Else
                        SqlQuerry = SqlQuerry & " and XMDM in(SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%')"
                    End If

                Else
                    If hastable = True Then
                        SqlQuerry = "SELECT FormID FROM " & searchTable & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    Else
                        SqlQuerry = "SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    End If
                End If
                If i > 2 Then Exit For
            Next
            If hastable = True Then
                tempSql += "  And XX_XMJC.FID in ( " & SqlQuerry & " GROUP BY FormID) "
            Else
                tempSql += "  And GY_XMXX.XMDM in ( " & SqlQuerry & " GROUP BY XMDM) "
            End If
        End If
        If LCFlag = False Then      '暂时时有流程没有置顶功能
            tempSql = tempSql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交'"
        Else
            tempSql = tempSql & " and GY_XMXX.XMJD<>'已删除' and GY_XMXX.XMJD<>'未提交'"
        End If

        tempSql = tempSql.Replace("SELECT XX_XMJC.FID FROM ", "") '对原先传递进来的数据进行处理，以构建一条完整的SQL语句

        Sql = Sql & tempSql & " and " & tableName & ".fid = xx_xmjc.fid"  '增加限制条件
        Sql = Sql & strWhere '增加自定义条件
        Sql = Sql & advancedSearchStr
        Sql = Sql & showlistFilterStr

        Sql = Sql & " order by "
        If LCFlag = False Then      '暂时时有流程没有置顶功能
            Sql = Sql & " TopNum DESC,"
            'Else
            '    Sql = Sql & " fid desc"
        End If
        Sql = Sql & strOrder & " fid desc"  '增加自定义排序条件
        ''说明：排序方式按置顶>自定义>FID的顺序

        TempTable = DB.Table(Sql, "dd")
        Return TempTable
    End Function




    ''' <summary>
    ''' 在报表浏览方式下的填充数据
    ''' </summary>
    ''' <param name="Gridview1"></param>
    ''' <param name="LCDM"></param>
    ''' <param name="SqlQuerry"></param>
    ''' <param name="SelectSQL"></param>
    ''' <param name="SortName"></param>
    ''' <param name="LCFlag"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function FillDataToGridview_Reports(ByVal Gridview1 As GridView, ByVal LCDM As Integer, ByVal SqlQuerry As String, ByVal SelectSQL As String, ByVal SortName As String, ByVal LCFlag As Boolean) As Data.DataTable
        Dim TempTable As New Data.DataTable
        Dim MaxTitle As Integer = 0
        Dim i, j As Integer
        Dim tb As New Data.DataTable

        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select ShowName,NodeName from ReportsList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        If ShowTb.Rows.Count = 0 Then       '假如为报表方式为空时.则直接显示普通方式下的
            ShowTb = DB.Table("Select ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "dd")
        End If
        MaxTitle = ShowTb.Rows.Count

        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Try
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim
                '过滤掉FID,项目状态,项目代码,防止出错
                If TempColumnName.Trim.ToUpper = "FID" Or TempColumnName.Trim.ToUpper = "项目状态" Or TempColumnName.Trim.ToUpper = "项目代码" Then
                    TempColumnName = TempColumnName.Trim.ToUpper & "1"
                End If
                Dim c As DataColumn = New DataColumn(TempColumnName)
                TempTable.Columns.Add(c)
            Catch ex As Exception
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Dim c As DataColumn = New DataColumn(TempColumnName)
                TempTable.Columns.Add(c)
                Temp1 += 1
            End Try
        Next
        '添加FID到Gridview1中。
        If LCFlag = True Then
            Dim c1 As DataColumn = New DataColumn("项目状态")
            TempTable.Columns.Add(c1)
            Dim c2 As DataColumn = New DataColumn("项目代码")
            TempTable.Columns.Add(c2)
        Else
            Dim c2 As DataColumn = New DataColumn("FID")
            TempTable.Columns.Add(c2)
        End If



        Dim BaseUrl As String
        Dim MKMC As String
        If LCFlag = True Then       '如果是有注程的。则MKMC要在下面得到。
            BaseUrl = Server.MapPath("../../") & "FormFolder/"
        Else
            tb = DB.Table("SELECT MKMC,XsnDir FROM GY_MKXX where NoLcDM =" & LCDM, "GY_MKXX")
            If tb.Rows.Count <= 0 Then
                _ErrMessage = "功能模板有问题!"
                Return Nothing
                Exit Function
            End If
            MKMC = tb.Rows(0).Item(0).ToString.Trim
            BaseUrl = Server.MapPath("../../") & "FormFolder/" & MKMC & "/"
        End If
        Dim FileName As String = ""

        Dim Sql As String = SelectSQL
        If SqlQuerry.Trim.Length > 0 Then
            Dim hastable As Boolean = True
            Dim searchTable As String = mkmc & "_MapSearch "

            Try
                tb = DB.Table("select top 1 cid from " & searchTable, "dd")
                hastable = True
            Catch ex As Exception
                hastable = False
            End Try



            Dim Ls As String()
            Ls = SqlQuerry.Replace("'", "''").Trim.Split(" ")
            SqlQuerry = ""
            For i = 0 To Ls.GetUpperBound(0)
                If SqlQuerry.Length > 0 Then
                    If hastable = True Then
                        SqlQuerry = SqlQuerry & "And FormID in ( SELECT FormID FROM " & searchTable & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%' GROUP BY FormID)"
                    Else
                        SqlQuerry = SqlQuerry & " and XMDM in(SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%')"
                    End If

                Else
                    If hastable = True Then
                        SqlQuerry = "SELECT FormID FROM " & searchTable & "  WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    Else
                        SqlQuerry = "SELECT XMDM FROM FormSearchData WHERE FormData LIKE '%" & Ls.GetValue(i) & "%'"
                    End If
                End If
                If i > 2 Then Exit For
            Next
            If hastable = True Then
                Sql += "  And XX_XMJC.FID in ( " & SqlQuerry & " GROUP BY FormID) "
            Else
                Sql += "  And GY_XMXX.XMDM in ( " & SqlQuerry & " GROUP BY XMDM) "
            End If

        End If
        If LCFlag = False Then      '暂时时无流程没有置顶功能
            Sql = Sql & " order by TopNum DESC,GY_XMXX.XMDM desc"
        Else
            Sql = Sql & " order by GY_XMXX.XMDM desc"
        End If

        Dim Fid, XMDM As String
        tb = DB.Table(Sql, "GY_XMXX")
        For i = 0 To tb.Rows.Count - 1
            Dim NewRow As DataRow = TempTable.NewRow()
            If LCFlag = False Then
                Fid = tb.Rows(i).Item(0).ToString.Trim
                FileName = BaseUrl & Fid & ".xml"
                NewRow(MaxTitle) = Fid
            Else
                XMDM = tb.Rows(i).Item(0).ToString.Trim
                NewRow(ShowTb.Rows.Count) = tb.Rows(i).Item(4).ToString.Trim
                NewRow(ShowTb.Rows.Count + 1) = XMDM
                Dim TempTb As New Data.DataTable
                TempTb = DB.Table("SELECT GY_MKXX.MKMC,XX_XMJC.Fid FROM XX_XMJC,GY_MKXX where GY_MKXX.MKDM=XX_XMJC.MKDM and XX_XMJC.XMDM=" & XMDM, "GY_MKXX")
                If TempTb.Rows.Count = 0 Then
                    For j = 0 To ShowTb.Rows.Count - 1
                        NewRow(j) = "空"
                    Next
                Else
                    FileName = BaseUrl & TempTb.Rows(0).Item(0) & "/" & TempTb.Rows(0).Item(1) & ".xml"
                End If
            End If

            If SortName.Trim <> "" Then
                If XmlClass.GetXmlFile(FileName) Is Nothing Then
                    '表示找不到记录，则显示空记录
                    For j = 0 To ShowTb.Rows.Count - 1
                        NewRow(j) = "空"
                    Next
                Else
                    '再列自定义的列
                    For j = 0 To ShowTb.Rows.Count - 1
                        If ShowTb.Rows(j).Item(0).ToString.Trim = SortName And SortName <> "FID" Then
                            '当不是排序列,或是为FID时,不进行处理.
                            Dim dd As System.Xml.XmlNode = XmlClass.FindNode("//" & ShowTb.Rows(j).Item(1).ToString.Replace("<", "").Replace(">", ""))
                            If dd Is Nothing Then
                                NewRow(j) = "空"
                            Else
                                If dd.ChildNodes.Item(0) Is Nothing Then
                                    NewRow(j) = "空"
                                Else
                                    If dd.ChildNodes.Item(0).Value Is Nothing Then
                                        If dd.HasChildNodes = True Then     '当是父节点.但是存在子节点时.则显示子节点的内容(或是超文本框)
                                            Dim TempOut As String = dd.ChildNodes.Item(0).OuterXml.ToString.Trim
                                            If TempOut.Length >= 100 Then
                                                NewRow(j) = Server.HtmlEncode(TempOut.Substring(0, 98)) & "..."
                                            Else
                                                NewRow(j) = Server.HtmlEncode(TempOut)
                                            End If
                                        Else
                                            NewRow(j) = "空"
                                        End If
                                    Else
                                        If dd.ChildNodes.Item(0).Value.ToString.Trim.Length >= 100 Then
                                            NewRow(j) = Server.HtmlEncode(dd.ChildNodes.Item(0).Value.ToString.Substring(0, 98)) & "..."
                                        Else
                                            NewRow(j) = Server.HtmlEncode(dd.ChildNodes.Item(0).Value)
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    Next
                End If
            End If
            TempTable.Rows.Add(NewRow)      '将列添加到表中
        Next
        Gridview1.DataSource = TempTable
        'Gridview1.Columns(Gridview1.Columns.Count - 1).Visible = False
        Return TempTable
    End Function

    ''' <summary>
    ''' 根据表单状态ID.返因状态名称
    ''' </summary>
    ''' <param name="state"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function Form_State(ByVal state As String) As String
        Dim TmpState As Integer
        Try
            TmpState = state
        Catch ex As Exception
            Return "进行中"
        End Try
        Select Case TmpState
            Case -1
                Return "已完成"
            Case 0
                Return "进行中"
            Case -2
                Return "已取消"
            Case Else
                Dim tb As New DataTable
                tb = DB.Table("Select cid,value from Xconfig where config='表单标签' and cid=" & TmpState, "dd")
                If tb.Rows.Count > 0 Then
                    Return tb.Rows(0).Item(1).ToString
                Else
                    Return "进行中"
                End If
        End Select
    End Function


    ''' <summary>
    ''' 处理订阅信息
    ''' </summary>
    ''' <param name="Fid"></param>
    ''' <remarks></remarks>
    Sub UpdateOrderFormLog(ByVal Fid As String, ByVal UserID As Integer, ByVal Login_User As String)
        Dim Tb As New Data.DataTable
        Dim i As Int16
        Dim LCDM, MKDM, XMDM As Integer
        Dim SqlStr As String = ""
        Dim XMMC As String = ""
        Dim MsgID As Integer            '消息ＩＤ
        Tb = DB.Table("select GY_XMXX.LCDM,XX_XMJC.MKDM,XX_XMJC.XMDM,GY_XMXX.XMMC from GY_XMXX,XX_XMJC where GY_XMXX.XMDM = XX_XMJC.XMDM  and XX_XMJC.FID =" & Fid, "XX_XMJC")
        If Tb.Rows.Count > 0 Then                       '表示查询流程代码时,没有找到
            LCDM = Tb.Rows(0).Item(0)
            MKDM = Tb.Rows(0).Item(1)
            XMDM = Tb.Rows(0).Item(2)
            XMMC = Tb.Rows(0).Item(3).ToString()
            Tb = DB.Table("select UserID,LCDM,XMDM,MKDM from Order_Form_Table where LCDM = " & LCDM & " and MKDM = " & MKDM, "Order_Form_Table")
            For i = 0 To Tb.Rows.Count - 1
                MsgID = DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind) values('" & Me.GetUserName(UserID, 3) & " 更新了(" & XMMC & ") 表单',0,'新的订阅信息'," & Tb.Rows(i).Item(0) & ",getdate(),0,3);Select CId from SendMessage where Cid = @@IDENTITY")
                SqlStr = " insert into Order_Form_Log(UserID,LCDM,XMDM,MKDM,OpDate,OpUserId,LookFlag,msgid) values("
                SqlStr += Tb.Rows(i).Item(0) & "," & Tb.Rows(i).Item(1) & "," & XMDM & "," & Tb.Rows(i).Item(3) & ",getdate()"
                SqlStr += "," & UserID & ",0," & MsgID & ")"
                DB.Query(SqlStr)
            Next
        End If
    End Sub

    ''' <summary>
    ''' 根据模块ID,创建相对应的SQL数据表,用来当做表单库
    ''' </summary>
    ''' <param name="MKDM"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CreateFormLibrary(ByVal MKDM As Integer) As Boolean
        Dim FormTableName As String = "FormLibrary_" & MKDM     '表名
        '创建FormLibrary表
        Dim CreateTable As String = String.Empty
        CreateTable += "SET ANSI_NULLS ON" & vbCrLf
        CreateTable += "SET QUOTED_IDENTIFIER ON" & vbCrLf
        CreateTable += "CREATE TABLE [dbo].[" & FormTableName & "](" & vbCrLf
        CreateTable += "[LID] [numeric](18, 0) IDENTITY(1,1) NOT NULL," & vbCrLf
        CreateTable += "[FID] [numeric](18, 0) NULL," & vbCrLf
        CreateTable += "[MKDM] [numeric](18, 0) NULL," & vbCrLf
        CreateTable += "[Forms] [xml] NULL," & vbCrLf
        CreateTable += "[RootName] [nvarchar](200) NULL," & vbCrLf
        CreateTable += "[RootNameSpace] [nvarchar](800) NULL," & vbCrLf
        CreateTable += "[NameSpaces] [text] NULL," & vbCrLf
        CreateTable += "CONSTRAINT [PK_" & FormTableName & "] PRIMARY KEY CLUSTERED " & vbCrLf
        CreateTable += "([LID] Asc" & vbCrLf
        CreateTable += ")WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]" & vbCrLf
        CreateTable += ") ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]" & vbCrLf
        DB.Query(CreateTable)
        If Not DB.ErrorMessage Is Nothing Then
            _ErrMessage = CreateTable
            Return False
        End If
        '创建FormLibrary索引
        Dim CreateIndex As String = String.Empty
        CreateIndex += "BEGIN TRANSACTION" & vbCrLf
        CreateIndex += "SET QUOTED_IDENTIFIER ON" & vbCrLf
        CreateIndex += "SET ARITHABORT ON" & vbCrLf
        CreateIndex += "SET NUMERIC_ROUNDABORT OFF" & vbCrLf
        CreateIndex += "SET CONCAT_NULL_YIELDS_NULL ON" & vbCrLf
        CreateIndex += "SET ANSI_NULLS ON" & vbCrLf
        CreateIndex += "SET ANSI_PADDING ON" & vbCrLf
        CreateIndex += "SET ANSI_WARNINGS ON" & vbCrLf
        CreateIndex += "COMMIT" & vbCrLf
        CreateIndex += "BEGIN TRANSACTION" & vbCrLf
        CreateIndex += "CREATE NONCLUSTERED INDEX IX_" & FormTableName & " ON dbo." & FormTableName & vbCrLf
        CreateIndex += "( FID ) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]" & vbCrLf
        CreateIndex += "CREATE PRIMARY XML INDEX XML_IX_" & FormTableName & " ON dbo." & FormTableName & "(Forms)" & vbCrLf
        CreateIndex += "WITH( STATISTICS_NORECOMPUTE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)" & vbCrLf
        CreateIndex += "CREATE XML INDEX XML_IX_" & FormTableName & "_1 ON dbo." & FormTableName & "(Forms)" & vbCrLf
        CreateIndex += "USING XML INDEX XML_IX_" & FormTableName & vbCrLf
        CreateIndex += "FOR VALUE" & vbCrLf
        CreateIndex += "WITH( STATISTICS_NORECOMPUTE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)" & vbCrLf
        CreateIndex += "CREATE XML INDEX XML_IX_" & FormTableName & "_2 ON dbo." & FormTableName & "(Forms)" & vbCrLf
        CreateIndex += "USING XML INDEX XML_IX_" & FormTableName & vbCrLf
        CreateIndex += "	FOR PROPERTY" & vbCrLf
        CreateIndex += "WITH( STATISTICS_NORECOMPUTE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)" & vbCrLf
        CreateIndex += "CREATE XML INDEX XML_IX_" & FormTableName & "_3 ON dbo." & FormTableName & "(Forms)" & vbCrLf
        CreateIndex += "USING XML INDEX XML_IX_" & FormTableName & vbCrLf
        CreateIndex += "FOR PATH" & vbCrLf
        CreateIndex += "WITH( STATISTICS_NORECOMPUTE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)" & vbCrLf
        CreateIndex += "COMMIT" & vbCrLf
        DB.Query(CreateIndex)
        If Not DB.ErrorMessage Is Nothing Then
            _ErrMessage = CreateIndex
            Return False
        End If

        '创建FormLibrary全文索引
        Dim CreateFullText As String = String.Empty
        CreateFullText += "CREATE FULLTEXT CATALOG FullText_" & FormTableName & vbCrLf
        CreateFullText += "CREATE FULLTEXT INDEX ON " & FormTableName & "(Forms)" & vbCrLf
        CreateFullText += "KEY INDEX PK_" & FormTableName & " ON FullText_" & FormTableName & vbCrLf
        DB.Query(CreateFullText)
        If Not DB.ErrorMessage Is Nothing Then
            _ErrMessage = CreateFullText
            Return False
        End If

        Return True
    End Function

    Function GetShowFieldDate_NoLc(ByVal MKDM As Integer, ByVal XMDM As Integer, ByVal ShowNum As Integer) As DataTable
        Dim TempTable As New Data.DataTable
        Dim i, j As Integer
        Dim tb As New Data.DataTable
        'XMDM         '得到项目代码
        'MKDM       '用来得到模块名称.去取XML文件的路径
        'ShowNum    '用来指向显示前几个显示列
        Dim LCDM As Integer         '得到流程代码.用来查询显示列

        tb = DB.Table("SELECT LCDM FROM GY_XMXX Where XMDM=" & XMDM, "bb")
        If tb.Rows.Count = 0 Then
            Return Nothing
            Exit Function
        End If
        LCDM = tb.Rows(0)(0)


        tb = DB.Table("SELECT MKMC FROM GY_MKXX where MKDM=" & MKDM, "dd")
        If tb.Rows.Count = 0 Then
            Return Nothing
            Exit Function
        End If
        Dim MKMC As String = tb.Rows(0).Item(0).ToString.Trim


        '得到要显示的字段。并加入TABLE中。
        Dim ShowTb As New Data.DataTable
        ShowTb = DB.Table("Select top " & ShowNum & " ShowName,NodeName from ShowList_LCDM where LCDM = " & LCDM & " order by ID", "ShowList_LCDM")

        Dim BaseUrl As String = Server.MapPath("../../") & "FormFolder/" & MKMC & "/"
        Dim FileName As String = ""

        tb = DB.Table("SELECT  FID FROM XX_XMJC where XMDM = " & XMDM & " and MKDM=" & MKDM, "GY_xjmc")
        If tb.Rows.Count = 0 Then
            Return Nothing
            Exit Function
        End If
        Dim Fid As String = tb.Rows(0)(0)
        FileName = BaseUrl & Fid & ".xml"



        Dim Temp1 As Integer = 1
        For i = 0 To ShowTb.Rows.Count - 1
            Try
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim
                '过滤掉FID,项目状态,项目代码,防止出错
                Dim c As DataColumn = New DataColumn(TempColumnName)
                TempTable.Columns.Add(c)
            Catch ex As Exception
                Dim TempColumnName As String = ShowTb.Rows(i).Item(0).ToString.Trim & "[" & Temp1 & "]"
                Dim c As DataColumn = New DataColumn(TempColumnName)
                TempTable.Columns.Add(c)
                Temp1 += 1
            End Try
        Next
        For j = ShowTb.Rows.Count To ShowNum - 1
            TempTable.Columns.Add(New DataColumn("未设置" & j))
        Next

        Dim NewRow As DataRow = TempTable.NewRow()

        If XmlClass.GetXmlFile(FileName) Is Nothing Then
            '表示找不到记录，则显示空记录
            For j = 0 To ShowNum - 1
                NewRow(j) = "空"
            Next
        Else
            '再列自定义的列
            For j = 0 To ShowTb.Rows.Count - 1
                Dim dd As System.Xml.XmlNode = XmlClass.FindNode("//" & ShowTb.Rows(j).Item(1).ToString.Replace("<", "").Replace(">", ""))
                If dd Is Nothing Then
                    NewRow(j) = "空"
                Else
                    If dd.ChildNodes.Item(0) Is Nothing Then
                        NewRow(j) = "空"
                    Else
                        If dd.ChildNodes.Item(0).Value Is Nothing Then
                            If dd.HasChildNodes = True Then     '当是父节点.但是存在子节点时.则显示子节点的内容(或是超文本框)
                                Dim TempOut As String = dd.ChildNodes.Item(0).OuterXml.ToString.Trim
                                If TempOut.Length > 30 Then
                                    NewRow(j) = Server.HtmlEncode(TempOut.Substring(0, 30)) & "..."
                                Else
                                    NewRow(j) = Server.HtmlEncode(TempOut)
                                End If
                            Else
                                NewRow(j) = "空"
                            End If
                        Else
                            If dd.ChildNodes.Item(0).Value.ToString.Trim.Length > 30 Then
                                NewRow(j) = Server.HtmlEncode(dd.ChildNodes.Item(0).Value.ToString.Substring(0, 30)) & "..."
                            Else
                                NewRow(j) = Server.HtmlEncode(dd.ChildNodes.Item(0).Value)
                            End If
                        End If
                    End If
                End If
            Next
            '如果没有达到三个.则相应的内容填上空
            For j = ShowTb.Rows.Count To ShowNum - 1
                NewRow(j) = "无"
            Next
        End If
        TempTable.Rows.Add(NewRow)      '将列添加到表中
        tb = Nothing
        Return TempTable
    End Function

    '写错误日志
    Function Log(ByVal UserName As String, ByVal Path As String, ByVal ErrMessage As String, ByVal Meno As String) As Boolean
        Dim Sql As String
        Sql = "Insert into ErrLog(userName,Path,ErrMessage,Dates,Meno) values('" & SqlFilter(UserName) & "','" & SqlFilter(Path) & "','" & SqlFilter(ErrMessage) & "','" & Now() & "','" & SqlFilter(Meno) & "')"
        DB.Query(Sql)
        If DB.ErrorMessage Is Nothing Then
            Return True
        Else
            Return False
        End If
    End Function

    '写同步表
    Function SynSubmit(ByVal FID As Integer, ByVal Ftype As String) As Boolean
        DB.Query("Insert into [SynSubmit](FID,[Ftype]) values(" & FID & ",'" & SqlFilter(Ftype) & "')")
        If DB.ErrorMessage Is Nothing Then
            Return True
        Else
            Return False
        End If
    End Function



    '得到系统表中的参数值
    Function GetSystemParameters(ByVal Params As String) As String
        Dim Tb As New Data.DataTable
        Tb = DB.Table("SELECT CSZ FROM GY_XTCS WHERE (CSM = '" & Params & " ')", "GY_XTCS")
        If Tb.Rows.Count = 0 Then
            Return Nothing
        Else
            If IsDBNull(Tb.Rows(0)(0)) = True Then
                Return Nothing
            Else
                Return Tb.Rows(0)(0).ToString
            End If
        End If
    End Function


    ''' <summary>
    ''' 清除附件内容（用在相似新建时去除附件内容).
    ''' </summary>
    ''' <param name="Fid"></param>
    ''' <param name="MKMC"></param>
    ''' <remarks></remarks>
    Sub ClearFormAnnex(ByVal Fid As Integer, ByVal MKMC As String, ByVal Login_User As String)
        '取得模板名称,和模板路径
        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT XX_XMJC.FID,Gy_MKXX.MKMC,GY_MKXX.XsnDir FROM XX_XMJC, GY_MKXX WHERE XX_XMJC.MKDM = GY_MKXX.MKDM AND (XX_XMJC.Fid = " & Fid & ")", "XX_XMJC")
        If tb.Rows.Count = 0 Then
            'Response.Write("非法访问")
            'Response.End()
        End If
        Dim XsnDir As String = tb.Rows(0).Item(2).ToString.Trim

        Dim Opfile As String = Server.MapPath("../../") & "\Submit_Temp\" & Login_User & "\" & Fid & ".xml"
        If System.IO.File.Exists(Opfile) = False Then      '若文件不存在,读取临时目录下的文件
            Opfile = Server.MapPath("../../") & "\Submit_Temp\CreateTemp\" & Fid & ".xml"
        End If


        Dim SchemaFile As String = Server.MapPath("../../") & "\TemplateLibrary\" & XsnDir & "\myschema.xsd"
        Dim SaveBase As String = Server.MapPath("../../") & "\FormFolder\" & MKMC & "\Annex\"
        pub.CreateDir(SaveBase)
        If System.IO.File.Exists(SchemaFile) = False Then
            Response.Write("请更新模板")
            Response.End()
        End If
        XmlClass.GetXmlFile(SchemaFile)
        Dim NodeList As XmlNodeList = XmlClass.FindNodes("/xsd:schema/xsd:element[@type='xsd:base64Binary']")
        Dim NodeList1 As XmlNodeList
        Dim AnnNodeName As String
        'Dim SaveFile As String
        Dim i, j As Integer
        '查询找附件的节点.并进行还原
        For i = 0 To NodeList.Count - 1
            AnnNodeName = NodeList.Item(i).Attributes("name").Value
            XmlClass.GetXmlFile(Opfile)
            NodeList1 = XmlClass.FindNodes("//my:" & AnnNodeName)
            For j = 0 To NodeList1.Count - 1
                'SaveFile = NodeList1.Item(j).InnerText
                NodeList1.Item(j).InnerText = ""
            Next
            XmlClass.Save()
        Next

    End Sub

    Function CheckFormWriteFlag(ByVal userid As Integer, ByVal MKDM As Integer) As Boolean
        If GetUserHaveQX(userid, MKDM) >= 2 Then
            Return True
        Else
            Return False
        End If

        ''这里对表单进行处理，判断表单是只读，或是可写的，或是没有权限的。
        'Dim tb As New Data.DataTable
        'Dim WriteFlag As Boolean    '表单可写标志
        'Dim Sql As String
        'Sql = "Select GY_Group.Group_ID,GY_Group.FormWriteFlag"
        'Sql += " from GY_Group, GY_Group_info, GY_YGQX"
        'Sql += " where Gy_Group.Group_id = Gy_Group_Info.Group_id"
        'Sql += " and GY_Group.Group_ID = GY_YGQX.Group_ID"
        'Sql += " and GY_YGQX.YGDM =  " & userid
        'Sql += "and GY_Group_info.MKDM =" & MKDM
        'tb = DB.Table(Sql, "GY_Group")
        'If tb.Rows.Count = 0 Then
        '    WriteFlag = False
        '    '非法访问，没有权限！")
        'Else
        '    If IsDBNull(tb.Rows(0).Item(1)) = True Then     '为NULL值时，表示为只读
        '        WriteFlag = False
        '    Else
        '        If tb.Rows(0).Item(1) = True Then              '为1时，表示可写
        '            WriteFlag = True
        '        Else
        '            WriteFlag = False
        '        End If
        '    End If
        'End If
        'Return WriteFlag
    End Function

    Function AutoAddProject_HasNoLC(ByVal LCDM As Integer, ByVal Login_User As String, ByVal BasePath As String) As String
        '自动添加无流程项目

        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT LCMC FROM GY_LCDM where LCDM = " & LCDM, "GY_LCDM")
        If tb.Rows.Count = 0 Then
            _ErrMessage = "参数错误或非法访问,流程代码在数据库表中查询不到!"
            Return Nothing
        End If
        Dim XMMC As String = tb.Rows(0).Item(0)         '因为是无流程,流程名称与项目名称一样
        Dim UserID As Integer = GetUserID(Login_User)

        Dim XMLX As String = Now()
        '添加一个项目(自动添加,项目名称,登陆名,登陆时间)        '得到流程名，用流程名做为项目的名称
        Try
            DB.Query("insert into GY_XMXX(xmmc,xmsm,xmlx,lcdm) values('" & XMMC & "','" & Login_User & "','" & XMLX & "'," & LCDM & ")")
        Catch ex As Exception
            _ErrMessage = "新建失败,向项目信息表中添加记录失败!"
            Return Nothing
        End Try
        '得到新建项目的项目代码            
        Dim XMDM As String = DB.ExeScalar("select XMDM from GY_XMXX where xmmc='" & XMMC & "' and xmsm='" & Login_User & "' and xmlx='" & XMLX & "' order by xmdm desc")
        If XMDM = Nothing Then
            _ErrMessage = "数据库查询失败!查询刚插入的记录,未能查找!"
            Return Nothing
        End If
        tb = DB.Table("SELECT MKDM,xdlj,XsnDir FROM GY_MKXX where NoLcDM =" & LCDM, "GY_MKXX")
        Dim XsnDir As String = tb.Rows(0).Item(2).ToString.Trim
        Dim MKDM As Integer = tb.Rows(0).Item(0)
        '写进程表.由于是一个项目一张单.所以只写一条记录

        DB.Query("insert into XX_XMJC(xmdm,mkdm,spbz,timebz,ruletime) values(" & XMDM & "," & MKDM & ",0,0,'')")

        '得到进程ID,也就是表单ID
        tb = DB.Table("select Fid from XX_XMJC where XMDM=" & XMDM & " and MKDM = " & MKDM & " order by FID desc", "XX_XMJC")
        If tb.Rows.Count = 0 Then           '表示出错
            _ErrMessage = "查询刚插入的进程表出错,或是结果为空"
            Return Nothing
        End If
        Dim Fid As Integer = tb.Rows(0).Item(0)

        Dim XmlFileName As String = Server.MapPath(BasePath) & "\TemplateLibrary\" & XsnDir & "\template.xml"

        '暂时存在临时目录下,因为新建.不一定会提交.会产生垃圾文件,所以放在临时目录下先.
        'Dim DFileName As String = Server.MapPath(BasePath) & "\FormFolder\" & XMMC & "\" & Fid & ".xml"
        Me.pub.CreateDir(Server.MapPath(BasePath) & "\Submit_Temp\CreateTemp\")
        Dim DFileName As String = Server.MapPath(BasePath) & "\Submit_Temp\CreateTemp\" & Fid & ".xml"


        If System.IO.File.Exists(XmlFileName) = False Then      '表示模板文件不存在
            _ErrMessage = "模板存在问题,模板文件找不到,请更新此模板!"
            Return Nothing
        End If
        Try
            System.IO.File.Copy(XmlFileName, DFileName, True)
        Catch ex As Exception
            _ErrMessage = XmlFileName & "-" & DFileName & "功能存在问题,你重新新建功能!复制文件出错"
            Return Nothing
        End Try


        Dim WriteFlag As Boolean    '表单可写标志
        '这里对表单进行处理，判断表单是只读，或是可写的，或是没有权限的。
        WriteFlag = CheckFormWriteFlag(UserID, MKDM)

        Dim Result As String = AutoFillDate(DFileName, Fid, XMDM, Login_User, WriteFlag, 0)
        If Not Result Is Nothing Then               '对自动生成的值进行相应的填写
            _ErrMessage = "自动填写表单错误:" & Result
            Return Nothing
        End If
        Return DFileName
    End Function

    ''' <summary>
    ''' 根据用户ID,得到相应的用户信息
    ''' </summary>
    ''' <param name="UserId"></param>
    ''' <param name="RetKind"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetUserName(ByVal UserId As Integer, ByVal RetKind As Integer)
        Dim tb As New DataTable
        Dim Retstr As String = ""
        tb = DB.Table("select YGXM,DLMC from GY_YGDM where YGDM=" & UserId, "12421")
        If tb.Rows.Count > 0 Then
            If RetKind = 1 Then Return tb.Rows(0)("DLMC")
            If RetKind = 2 Then Return tb.Rows(0)("YGXM")
            If RetKind = 3 Then Return tb.Rows(0)("YGXM") & "(" & tb.Rows(0)("DLMC") & ")"
        Else
            Retstr = "用户不存在"
        End If
    End Function

    ''' <summary>
    ''' 根据用户名姓名得到用户ID
    ''' </summary>
    ''' <param name="UserName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetUserIDByXM(ByVal UserName As String) As Integer
        Dim UserID As Integer
        If UserName.Trim.Length = 0 Then UserID = -1

        Dim tb As New Data.DataTable
        Try
            tb = DB.Table("select YGDM from GY_YGDM where YGXM ='" & Me.SqlFilter(UserName) & "' and QYBZ=1", "GY_YGDM")
        Catch ex As Exception
            UserID = -1
        End Try
        If tb.Rows.Count > 0 Then
            Return tb.Rows(0).Item(0)
        Else
            UserID = -1
        End If
        Return UserID

    End Function

    ''' <summary>
    ''' 根据用户名姓名得到用户ID
    ''' </summary>
    ''' <param name="UserName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetUserIDByDLMC(ByVal UserName As String) As Integer
        Dim UserID As Integer
        If UserName.Trim.Length = 0 Then UserID = -1

        Dim tb As New Data.DataTable
        Try
            tb = DB.Table("select YGDM from GY_YGDM where DLMC ='" & Me.SqlFilter(UserName) & "' and QYBZ=1", "GY_YGDM")
        Catch ex As Exception
            UserID = -1
        End Try
        If tb.Rows.Count > 0 Then
            Return tb.Rows(0).Item(0)
        Else
            UserID = -1
        End If
        Return UserID

    End Function

    ''' <summary>
    ''' 根据用户名得到用户ID
    ''' </summary>
    ''' <param name="UserName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetUserID(ByVal UserName As String) As Integer
        Dim UserID As Integer
        If UserName.Trim.Length = 0 Then UserID = -1

        Dim tb As New Data.DataTable
        Try
            tb = DB.Table("select YGDM from GY_YGDM where DLMC ='" & Me.SqlFilter(UserName) & "' and QYBZ=1", "GY_YGDM")
        Catch ex As Exception
            UserID = -1
        End Try
        If tb.Rows.Count > 0 Then
            Return tb.Rows(0).Item(0)
        Else
            UserID = -1
        End If

        'If UserID = -1 And UserName <> "admin" Then             '当是超时.或是非法访问时
        '    Try
        '        HttpContext.Current.Response.Write("<script language='javascript'>")
        '        HttpContext.Current.Response.Write("alert('登陆超时');" & vbCrLf)

        '        If File.Exists(Server.MapPath("./main.aspx")) = True Then
        '            HttpContext.Current.Response.Write("window.location.href='default.aspx';")
        '            HttpContext.Current.Response.Write("</script>")
        '            HttpContext.Current.Response.End()
        '        End If
        '        If File.Exists(Server.MapPath("../main.aspx")) = True Then
        '            HttpContext.Current.Response.Write("window.location.href='../default.aspx';")
        '            HttpContext.Current.Response.Write("</script>")
        '            HttpContext.Current.Response.End()
        '        End If
        '        If File.Exists(Server.MapPath("../../main.aspx")) = True Then
        '            HttpContext.Current.Response.Write("window.location.href='../../default.aspx';")
        '            HttpContext.Current.Response.Write("</script>")
        '            HttpContext.Current.Response.End()
        '        End If
        '    Catch ex As Exception
        '    End Try
        'Else
        Return UserID
        'End If
    End Function

    Function GetUserNameByDLMC(ByVal DLMC As String) As String
        Dim tb As New DataTable
        Dim Retstr As String = ""
        tb = DB.Table("select YGDM,YGXM,DLMC from GY_YGDM where DLMC='" & DLMC & "'", "12421")
        If tb.Rows.Count > 0 Then
            Return tb.Rows(0).Item(1).ToString()
        Else
            Return ""
        End If
    End Function

    Function GetDLMCByUserName(ByVal UserName As String)
        Dim tb As New DataTable
        Dim Retstr As String = ""
        tb = DB.Table("select YGDM,YGXM,DLMC from GY_YGDM where YGXM='" & UserName & "'", "12421")
        If tb.Rows.Count > 0 Then
            Return tb.Rows(0).Item(2).ToString()
        Else
            Return ""
        End If
    End Function

    ''' <summary>
    ''' 对表单进行自动的填充
    ''' </summary>
    ''' <param name="DFileName">表单目标文件</param>
    ''' <param name="Fid">表单号</param>
    ''' <param name="xmdm">项目代码</param>
    ''' <param name="Login_User">操作用户</param>
    ''' <param name="WriteFlag">读写标志</param>
    ''' <param name="ImportFID">前一表单ID</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function AutoFillDate(ByVal DFileName As String, ByVal Fid As String, ByVal xmdm As String, ByVal Login_User As String, ByVal WriteFlag As Boolean, ByVal ImportFID As String) As String

        Dim RootNode As System.Xml.XmlNode
        RootNode = XmlClass.GetXmlFile(DFileName)
        If Not XmlClass.ErrorMessage Is Nothing Then
            Return "表单结构存在问题,请联系管理员!"
        End If
        Dim RootNodeName As String = XmlClass.GetRootNodeName
        Dim Search_Fid As String = XmlClass.GetFormID
        Dim Xpath As String = "//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题")
        Dim DateTemp As String = Now
        Dim TitleNodeStr As String = String.Empty
        Dim NS_Str As String = Search_Fid.Replace("表单号", "")

        Dim row As DataRow = DB.Row("Select state from XX_XMJC where FID=" & Fid, "dd")
        If row Is Nothing Then
            Return "表单不存在"
        End If

        TitleNodeStr += vbCrLf & "<" & NS_Str & "表单号" & ">" & Fid & "</" & NS_Str & "表单号>" & vbCrLf

        TitleNodeStr += "<" & NS_Str & "状态" & ">" & Form_State(row.Item("state").ToString.Trim) & "</" & NS_Str & "状态>" & vbCrLf

        TitleNodeStr += "<" & NS_Str & "项目代码" & ">" & xmdm & "</" & NS_Str & "项目代码>" & vbCrLf

        TitleNodeStr += "<" & NS_Str & "操作者" & ">" & Login_User & "</" & NS_Str & "操作者>" & vbCrLf

        TitleNodeStr += "<" & NS_Str & "填表时间" & ">" & DateTemp & "</" & NS_Str & "填表时间>" & vbCrLf

        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT XX_XMJC.FID,Gy_MKXX.MKMC,GY_MKXX.XsnDir,Gy_MKXX.[View] FROM XX_XMJC, GY_MKXX WHERE XX_XMJC.MKDM = GY_MKXX.MKDM AND (XX_XMJC.Fid = " & Fid & ")", "XX_XMJC")
        Dim View As String
        If tb.Rows.Count = 0 Then
            View = "默认视图"
        Else
            If IsDBNull(tb.Rows(0).Item(3)) = True Then
                View = "默认视图"
            Else
                View = tb.Rows(0).Item(3)
            End If
        End If
        TitleNodeStr += "<" & NS_Str & "视图" & ">" & View & "</" & NS_Str & "视图>" & vbCrLf

        Dim YZM As String = String.Empty
        If WriteFlag = True Then
            YZM = EnCrypt.EnCryptUserName(Fid, Login_User, DateTemp)
        Else
            YZM = "000000000000000000000000000000"
        End If

        TitleNodeStr += "<" & NS_Str & "验证码" & ">" & YZM & "</" & NS_Str & "验证码>" & vbCrLf

        '==============================================================================================
        '当新建的表单需要从前一表单拉内容时,将值写进去.
        If ImportFID.Trim.Length > 0 Then
            TitleNodeStr += "<" & NS_Str & "传递值" & ">" & ImportFID.Trim & "</" & NS_Str & "传递值>" & vbCrLf
        End If
        '==============================================================================================

        '-------------------设置域名------------------
        Dim Host As String = GetHost()
        Dim NodeTemp2 As XmlNode

        TitleNodeStr += "<" & NS_Str & "备用1" & ">" & Host & "</" & NS_Str & "备用1>"
        TitleNodeStr += "<" & NS_Str & "备用2" & ">" & "</" & NS_Str & "备用2>"

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用3"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用3>" & NodeTemp2.InnerXml & "</my:备用3>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用3></my:备用3>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用4"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用4>" & NodeTemp2.InnerXml & "</my:备用4>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用4></my:备用4>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用5"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用5>" & NodeTemp2.InnerXml & "</my:备用5>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用5></my:备用5>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用6"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用6>" & NodeTemp2.InnerXml & "</my:备用6>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用6></my:备用6>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用7"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用7>" & NodeTemp2.InnerXml & "</my:备用7>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用7></my:备用7>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用8"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用8>" & NodeTemp2.InnerXml & "</my:备用8>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用8></my:备用8>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用9"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用9>" & NodeTemp2.InnerXml & "</my:备用9>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用9></my:备用9>" & vbCrLf
            End If
        End If
        'TitleNodeStr += "<" & NS_Str & "备用1" & ">" & Host & "</" & NS_Str & "备用1>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用2" & ">" & "</" & NS_Str & "备用2>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用3" & ">" & "</" & NS_Str & "备用3>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用4" & ">" & "</" & NS_Str & "备用4>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用5" & ">" & "</" & NS_Str & "备用5>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用6" & ">" & "</" & NS_Str & "备用6>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用7" & ">" & "</" & NS_Str & "备用7>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用8" & ">" & "</" & NS_Str & "备用8>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用9" & ">" & "</" & NS_Str & "备用9>" & vbCrLf
        TitleNodeStr += "<" & NS_Str & "备用说明" & ">备用1=主机域名,备用2=反写-记录-FID-XPATH-XML-记录-反写" & "</" & NS_Str & "备用说明>" & vbCrLf

        '===========================  检测是否有存档标志,如果有,复制回来 ==============================

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "存档"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                If NodeTemp2.ChildNodes.Item(0).Value = "否" Then
                    '不存档.直接删除当前节点.
                    TitleNodeStr += "<" & NS_Str & "存档" & ">否</" & NS_Str & "存档>" & vbCrLf
                End If
            End If
        End If
        '==============================================================================================
        '============================ 检测审批信息,如果有,则复制回来 ==================================
        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "审批信息"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:审批信息>" & NodeTemp2.InnerXml & "</my:审批信息>" & vbCrLf
            Else
                TitleNodeStr += "<my:审批信息></my:审批信息>" & vbCrLf
            End If
        Else
            'System.Web.HttpContext.Current.Response.Write("找不到审批节点")
            'System.Web.HttpContext.Current.Response.End()
        End If
        '==============================================================================================

        Dim TitleNode As System.Xml.XmlNode = XmlClass.FindNode(Xpath)
        If TitleNode Is Nothing Then
            Return "数据模板错误,请更新模板!"
        End If
        TitleNode.InnerXml = TitleNodeStr
        XmlClass.Save()
        Return Nothing



        '此段代码为了是过滤一些只有组.没有组成员的节点.因为经过UPDATE后,组会自动加上空格.所以去掉
        'Dim TempText As String = IO.Text_File_Read(DFileName)
        'Dim Temp1, Temp2 As String
        'Dim Index As Integer
        'If WriteFlag = True Then
        '    Index = TempText.LastIndexOf(EnCrypt.EnCryptUserName(Fid, Login_User, DateTemp))
        'Else
        '    Index = TempText.LastIndexOf("000000000000000000000000000000")
        'End If

        'If Index <= 0 Then
        '    Return "数据模板错误,结构性错误"
        'End If
        'Temp1 = TempText.Substring(0, Index)
        'Temp2 = TempText.Substring(Index)
        'Temp2 = Temp2.Replace("  ", "")
        'IO.Text_File_SaveAs(DFileName, Temp1 & Temp2.Replace(Chr(13) & Chr(10), ""), Encoding.UTF8)
        'Return Nothing
    End Function


    ''' <summary>
    ''' 对表单进行自动的填充
    ''' </summary>
    ''' <param name="DFileName">表单目标文件</param>
    ''' <param name="Fid">表单号</param>
    ''' <param name="xmdm">项目代码</param>
    ''' <param name="Login_User">操作用户</param>
    ''' <param name="WriteFlag">读写标志</param>
    ''' <param name="ImportFID">前一表单ID</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function AutoFillDate(ByVal DFileName As String, ByVal Fid As String, ByVal xmdm As String, ByVal Login_User As String, ByVal WriteFlag As Boolean, ByVal ImportFID As String, ByVal msgID As Integer) As String

        Dim RootNode As System.Xml.XmlNode
        RootNode = XmlClass.GetXmlFile(DFileName)
        If Not XmlClass.ErrorMessage Is Nothing Then
            Return "表单结构存在问题,请联系管理员!"
        End If
        Dim RootNodeName As String = XmlClass.GetRootNodeName
        Dim Search_Fid As String = XmlClass.GetFormID
        Dim Xpath As String = "//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题")
        Dim DateTemp As String = Now
        Dim TitleNodeStr As String = String.Empty
        Dim NS_Str As String = Search_Fid.Replace("表单号", "")

        Dim row As DataRow = DB.Row("Select state from XX_XMJC where FID=" & Fid, "dd")
        If row Is Nothing Then
            Return "表单不存在"
        End If

        TitleNodeStr += vbCrLf & "<" & NS_Str & "表单号" & ">" & Fid & "</" & NS_Str & "表单号>" & vbCrLf

        TitleNodeStr += "<" & NS_Str & "状态" & ">" & Form_State(row.Item("state").ToString.Trim) & "</" & NS_Str & "状态>" & vbCrLf

        TitleNodeStr += "<" & NS_Str & "项目代码" & ">" & xmdm & "</" & NS_Str & "项目代码>" & vbCrLf

        TitleNodeStr += "<" & NS_Str & "操作者" & ">" & Login_User & "</" & NS_Str & "操作者>" & vbCrLf

        TitleNodeStr += "<" & NS_Str & "填表时间" & ">" & DateTemp & "</" & NS_Str & "填表时间>" & vbCrLf

        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT XX_XMJC.FID,Gy_MKXX.MKMC,GY_MKXX.XsnDir,Gy_MKXX.[View] FROM XX_XMJC, GY_MKXX WHERE XX_XMJC.MKDM = GY_MKXX.MKDM AND (XX_XMJC.Fid = " & Fid & ")", "XX_XMJC")
        Dim View As String
        If tb.Rows.Count = 0 Then
            View = "默认视图"
        Else
            If IsDBNull(tb.Rows(0).Item(3)) = True Then
                View = "默认视图"
            Else
                View = tb.Rows(0).Item(3)
            End If
        End If
        TitleNodeStr += "<" & NS_Str & "视图" & ">" & View & "</" & NS_Str & "视图>" & vbCrLf

        Dim YZM As String = String.Empty
        If WriteFlag = True Then
            YZM = EnCrypt.EnCryptUserName(Fid, Login_User, DateTemp)
        Else
            YZM = "000000000000000000000000000000"
        End If

        TitleNodeStr += "<" & NS_Str & "验证码" & ">" & YZM & "</" & NS_Str & "验证码>" & vbCrLf

        '==============================================================================================
        '当新建的表单需要从前一表单拉内容时,将值写进去.
        If ImportFID.Trim.Length > 0 Then
            TitleNodeStr += "<" & NS_Str & "传递值" & ">" & ImportFID.Trim & "</" & NS_Str & "传递值>" & vbCrLf
        End If
        '==============================================================================================

        '-------------------设置域名------------------
        Dim Host As String = GetHost()
        Dim NodeTemp2 As XmlNode

        TitleNodeStr += "<" & NS_Str & "备用1" & ">" & Host & "</" & NS_Str & "备用1>"
        TitleNodeStr += "<" & NS_Str & "备用2" & ">" & "</" & NS_Str & "备用2>"

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用3"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用3>" & NodeTemp2.InnerXml & "</my:备用3>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用3></my:备用3>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用4"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用4>" & NodeTemp2.InnerXml & "</my:备用4>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用4></my:备用4>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用5"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用5>" & NodeTemp2.InnerXml & "</my:备用5>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用5></my:备用5>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用6"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用6>" & NodeTemp2.InnerXml & "</my:备用6>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用6></my:备用6>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用7"))
        If Not NodeTemp2 Is Nothing Then


            If msgID <> 0 Then
                TitleNodeStr += "<my:备用7>" & msgID.ToString() & "</my:备用7>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用7></my:备用7>" & vbCrLf
            End If
            'If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
            '    TitleNodeStr += "<my:备用7>" & NodeTemp2.InnerXml & "</my:备用7>" & vbCrLf
            'Else
            '    TitleNodeStr += "<my:备用7></my:备用7>" & vbCrLf
            'End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用8"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用8>" & NodeTemp2.InnerXml & "</my:备用8>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用8></my:备用8>" & vbCrLf
            End If
        End If

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "备用9"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:备用9>" & NodeTemp2.InnerXml & "</my:备用9>" & vbCrLf
            Else
                TitleNodeStr += "<my:备用9></my:备用9>" & vbCrLf
            End If
        End If
        'TitleNodeStr += "<" & NS_Str & "备用1" & ">" & Host & "</" & NS_Str & "备用1>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用2" & ">" & "</" & NS_Str & "备用2>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用3" & ">" & "</" & NS_Str & "备用3>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用4" & ">" & "</" & NS_Str & "备用4>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用5" & ">" & "</" & NS_Str & "备用5>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用6" & ">" & "</" & NS_Str & "备用6>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用7" & ">" & "</" & NS_Str & "备用7>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用8" & ">" & "</" & NS_Str & "备用8>" & vbCrLf
        'TitleNodeStr += "<" & NS_Str & "备用9" & ">" & "</" & NS_Str & "备用9>" & vbCrLf
        TitleNodeStr += "<" & NS_Str & "备用说明" & ">备用1=主机域名,备用2=反写-记录-FID-XPATH-XML-记录-反写" & "</" & NS_Str & "备用说明>" & vbCrLf

        '===========================  检测是否有存档标志,如果有,复制回来 ==============================

        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "存档"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                If NodeTemp2.ChildNodes.Item(0).Value = "否" Then
                    '不存档.直接删除当前节点.
                    TitleNodeStr += "<" & NS_Str & "存档" & ">否</" & NS_Str & "存档>" & vbCrLf
                End If
            End If
        End If
        '==============================================================================================
        '============================ 检测审批信息,如果有,则复制回来 ==================================
        NodeTemp2 = XmlClass.FindNode("//" & RootNodeName & "/" & Search_Fid.Replace("表单号", "标题") & "/" & Search_Fid.Replace("表单号", "审批信息"))
        If Not NodeTemp2 Is Nothing Then
            If Not NodeTemp2.ChildNodes.Item(0) Is Nothing Then '判断第一条记录中是不有存在[存档]节点,来决定是否保存
                TitleNodeStr += "<my:审批信息>" & NodeTemp2.InnerXml & "</my:审批信息>" & vbCrLf
            Else
                TitleNodeStr += "<my:审批信息></my:审批信息>" & vbCrLf
            End If
        Else
            'System.Web.HttpContext.Current.Response.Write("找不到审批节点")
            'System.Web.HttpContext.Current.Response.End()
        End If
        '==============================================================================================

        Dim TitleNode As System.Xml.XmlNode = XmlClass.FindNode(Xpath)
        If TitleNode Is Nothing Then
            Return "数据模板错误,请更新模板!"
        End If
        TitleNode.InnerXml = TitleNodeStr
        XmlClass.Save()
        Return Nothing



        '此段代码为了是过滤一些只有组.没有组成员的节点.因为经过UPDATE后,组会自动加上空格.所以去掉
        'Dim TempText As String = IO.Text_File_Read(DFileName)
        'Dim Temp1, Temp2 As String
        'Dim Index As Integer
        'If WriteFlag = True Then
        '    Index = TempText.LastIndexOf(EnCrypt.EnCryptUserName(Fid, Login_User, DateTemp))
        'Else
        '    Index = TempText.LastIndexOf("000000000000000000000000000000")
        'End If

        'If Index <= 0 Then
        '    Return "数据模板错误,结构性错误"
        'End If
        'Temp1 = TempText.Substring(0, Index)
        'Temp2 = TempText.Substring(Index)
        'Temp2 = Temp2.Replace("  ", "")
        'IO.Text_File_SaveAs(DFileName, Temp1 & Temp2.Replace(Chr(13) & Chr(10), ""), Encoding.UTF8)
        'Return Nothing
    End Function

    Function CheckFormData(ByVal XmlFileName As String) As String
        '对表单进行检测,如果出错.则提示
        If XmlClass.GetXmlFile(XmlFileName) Is Nothing Then
            Return "模板文件出错，请出管理员联系！"
        End If
        Dim Node1 As System.Xml.XmlNode
        Dim Search_Fid As String = XmlClass.GetFormID

        '对表单ID进行检测.
        Node1 = XmlClass.FindNode("//" & Search_Fid)
        If Node1 Is Nothing Then        '表示没有找到节点.做返回操作
            Return "你上传的表单不合法,请检查模板是否存在<" & Search_Fid & ">节点"
        End If

        '对项目代码进行检测
        Node1 = XmlClass.FindNode("//" & Search_Fid.Replace("表单号", "项目代码"))
        If Node1 Is Nothing Then        '表示没有找到节点.做返回操作
            Return "你上传的表单不合法,请检查模板是否存在<" & Search_Fid.Replace("表单号", "项目代码") & ">节点"
        End If

        '对操作者进行检测
        Node1 = XmlClass.FindNode("//" & Search_Fid.Replace("表单号", "操作者"))
        If Node1 Is Nothing Then        '表示没有找到.做返回操作
            Return "你上传的表单不合法,请检查模板是否存在<" & Search_Fid.Replace("表单号", "操作者") & ">节点"
        End If

        '对填写时间进行检测
        Node1 = XmlClass.FindNode("//" & Search_Fid.Replace("表单号", "填表时间"))
        If Node1 Is Nothing Then        '表示没有找到.做返回操作
            Return "你上传的表单不合法,请检查模板是否存在<" & Search_Fid.Replace("表单号", "填表时间") & ">节点"
        End If

        '对视图进行检测
        Node1 = XmlClass.FindNode("//" & Search_Fid.Replace("表单号", "视图"))
        If Node1 Is Nothing Then        '表示没有找到.做返回操作
            Return "你上传的表单不合法,请检查模板是否存在<" & Search_Fid.Replace("表单号", "视图") & ">节点"
        End If

        '验证码
        Node1 = XmlClass.FindNode("//" & Search_Fid.Replace("表单号", "验证码"))
        If Node1 Is Nothing Then        '表示没有找到.做返回操作
            Return "你上传的表单不合法,请检查模板是否存在<" & Search_Fid.Replace("表单号", "验证码") & ">节点"
        End If
        Return Nothing
    End Function


    Function XmlDataToDB(ByVal Fid As Integer, ByVal OpDir As String) As String
        Dim MKMC As String      '模块名称
        Dim XMDM As String      '项目代码
        Dim MKDM As String      '模块代码
        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT XX_XMJC.FID,Gy_MKXX.MKMC,XX_XMJC.XMDM,XX_XMJC.MKDM FROM XX_XMJC, GY_MKXX WHERE XX_XMJC.MKDM = GY_MKXX.MKDM AND (XX_XMJC.Fid = " & Fid & ")", "XX_XMJC")
        If tb.Rows.Count = 0 Then
            Return "错误的表单号"
        End If
        MKMC = tb.Rows(0).Item(1)
        XMDM = tb.Rows(0).Item(2)
        MKDM = tb.Rows(0).Item(3)
        '清除原来的记录.
        DB.Query("delete FormSearchData where FormID =" & Fid)
        Dim OpFile As String = OpDir & MKMC & "\" & Fid & ".xml"
        XmlClass.GetXmlFile(OpFile)
        Dim RootNode As System.Xml.XmlNodeList = XmlClass.GetRootNode()
        '进行递归写表操作
        Add_Xml_To_Data(RootNode, Fid, XMDM)
        Return Nothing
    End Function

    Function Add_Xml_To_Data(ByVal xmluser As System.Xml.XmlNodeList, ByVal Fid As Integer, ByVal xmdm As Integer) As String
        '用递归的方法查找所有节点.并显示出来
        Dim i As Integer
        Dim Temp As String = String.Empty
        Dim DataValue As String = Nothing
        For i = 0 To xmluser.Count - 1
            If xmluser.Item(i).Name <> "#text" Then  '过滤掉为空的值项
                If xmluser.Item(i).ChildNodes.Count >= 1 Then
                    DataValue = xmluser.Item(i).ChildNodes.Item(0).Value
                    If Not DataValue Is Nothing Then
                        If DataValue.Trim.Length > 0 Then
                            If DataValue.Length > 500 Then DataValue = DataValue.Substring(0, 500)
                            DB.Query("insert into FormSearchData(FormID,FormData,xmdm) values(" & Fid & " ,'" & DataValue & "'," & xmdm & ")")
                        End If
                    End If
                    Add_Xml_To_Data(xmluser.Item(i).ChildNodes, Fid, xmdm)
                End If
            End If
        Next
        Return Temp
    End Function

    ''' <summary>
    ''' 这里对每个功能的权限进行判断,当不同组中对一个用户设置了权限,则取最高权限的那个权限设置
    ''' </summary>
    ''' <param name="UserID"></param>
    ''' <param name="MKDM"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetUserHaveQX(ByVal UserID As Integer, ByVal MKDM As Integer) As Integer

        Dim QxSum As Integer = 0
        Dim sql As String = "Select CanRead From GY_Ygqx,Gy_Group_Info,Gy_Group where Gy_Group_Info.Group_Id = Gy_Ygqx.Group_Id And Gy_Ygqx.Group_Id = Gy_Group.Group_ID and (Group_Kind is null or Group_Kind=0) and YGDM=" & UserID & " and MKDM =" & MKDM
        Dim tb As New Data.DataTable

        '读权限
        tb = DB.Table(sql & " and CanRead=1", "UserQX")
        If tb.Rows.Count > 0 Then QxSum += 1
        '写权限
        tb = DB.Table(sql & " and CanWrite=1", "UserQX")
        If tb.Rows.Count > 0 Then QxSum += 2
        '修改权限
        tb = DB.Table(sql & " and CanModify=1", "UserQX")
        If tb.Rows.Count > 0 Then QxSum += 4
        '删除权限
        tb = DB.Table(sql & " and CanDelete=1", "UserQX")
        If tb.Rows.Count > 0 Then QxSum += 8
        '全部权限
        tb = DB.Table(sql & " and CanAll=1", "UserQX")
        If tb.Rows.Count > 0 Then QxSum += 16

        Return QxSum
    End Function

    ''' <summary>
    '''检测有已发分发，修订，审阅的记录
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CheckSendFFQX(ByVal UserID As Integer, ByVal MKDM As Integer) As Boolean
        Dim tb As New DataTable
        tb = DB.Table("SELECT top 1 YGDM FROM Gy_XmXd,XX_XMJC where XX_XMJC.FID=GY_XMXD.FID and  FQR=" & UserID & " and MKDM=" & MKDM, "dd")
        If tb.Rows.Count > 0 Then
            Return True
        Else
            Return False
        End If
    End Function

    ''' <summary>
    ''' 检测有已收分发，修订，审阅的记录
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CheckDistributionQX(ByVal UserID As Integer, ByVal MKDM As Integer) As Boolean
        Dim tb As New DataTable
        tb = DB.Table("SELECT top 1 YGDM FROM Gy_XmXd,XX_XMJC where XX_XMJC.FID=GY_XMXD.FID and  YGDM=" & UserID & " and MKDM=" & MKDM, "dd")
        If tb.Rows.Count > 0 Then
            Return True
        Else
            Return False
        End If
    End Function

    ''' <summary>
    ''' 用来检测无流程中,表单列表功能,是否有权限访问.
    ''' </summary>
    ''' <param name="UserID"></param>
    ''' <param name="LCDM"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CheckListFormQX_LCDM(ByVal UserID As Integer, ByVal LCDM As Integer) As Boolean
        Dim tb As New Data.DataTable
        tb = DB.Table("SELECT MKDM FROM GY_MKXX where NoLcDm =" & LCDM, "GY_MKXX")
        If tb.Rows.Count = 0 Then
            Return False
        End If
        Dim MKDM As Int16 = tb.Rows(0)(0)
        Return CheckListFormQX_MKDM(UserID, MKDM)
    End Function

    ''' <summary>
    ''' 用来检测无流程中,表单列表功能,是否有权限访问.
    ''' </summary>
    ''' <param name="UserID"></param>
    ''' <param name="MKDM"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function CheckListFormQX_MKDM(ByVal UserID As Integer, ByVal MKDM As Integer) As Boolean
        Dim tb As New Data.DataTable
        Dim sql As String = "Select CanListForm From GY_Ygqx,Gy_Group_Info,Gy_Group where Gy_Group_Info.Group_Id = Gy_Ygqx.Group_Id And Gy_Ygqx.Group_Id = Gy_Group.Group_ID and (Group_Kind is null or Group_Kind=0) and YGDM=" & UserID & " and MKDM =" & MKDM & " and CanListForm=1"
        tb = DB.Table(sql, "UserQX")
        If tb.Rows.Count = 0 Then
            Return False
        Else
            Return True
        End If
    End Function





    Function GetUserLC_QX(ByVal UserID As Integer, ByVal LCDM As Integer, ByVal Kind As Integer) As Boolean

        Dim sql As String = "select CanNew,Withme,Finish,Finished,CanDel from GY_LCQX,GY_Group where GY_LCQX.Group_ID=GY_group.group_ID and LCDM=" & LCDM & " and YGDM=" & UserID
        Dim tb As New Data.DataTable
        tb = DB.Table(sql, "UserQX")
        If tb.Rows.Count = 0 Then
            Return False
        Else
            '先判断是不全功能,如果不是。再判断具体的功能
            If Kind > 5 Or Kind < 0 Then
                Return False
            Else
                If IsDBNull(tb.Rows(0)(Kind)) = False Then
                    If Int(tb.Rows(0)(Kind)) = 1 Then
                        Return True
                    Else
                        Return False
                    End If
                Else
                    Return False
                End If
            End If
        End If
    End Function

    Function Check_RZM() As String
        Dim YZM As HttpCookie = System.Web.HttpContext.Current.Request.Cookies("cnxmanyzm")
        If YZM Is Nothing Then
            Return "认证失败"
        End If
        Try
            If DB.GetRowCount("Select CID from Online_User where YZM='" & YZM.Value & "'", "dd") <= 0 Then
                Return "认证失败,请先登陆"
            End If
        Catch ex As Exception
            Return "系统维护,请联系管理员"
        End Try
        Return Nothing
    End Function

#End Region


    ''' <summary>
    ''' 记录用户登陆信息(当前登陆用户)
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function System_User_Login_Log() As Boolean
        Dim UserName As String = GetWebUserName()
        Return System_User_Login_Log(UserName)
    End Function

    ''' <summary>
    ''' 获取域名URL
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetHost()
        '-------------------设置域名------------------
        Dim Url As String = HttpContext.Current.Request.ServerVariables("Url").ToLower
        Dim Host As String = HttpContext.Current.Request.ServerVariables("http_host")
        Dim Port As String = HttpContext.Current.Request.ServerVariables("Server_Port")
        If pub.GetWebConfig("SunfunSoft.Xman.BaseUrl") <> "" Then
            '如果域名进行了URL转发.变成内网IP.则取配置文件里的域名.
            Host = pub.GetWebConfig("SunfunSoft.Xman.BaseUrl")
        Else
            Dim idx As Integer = Url.LastIndexOf("/")
            If idx > 0 Then Url = Url.Substring(0, idx + 1).Replace("/manager/forms/", "/").Replace("/public/", "/")
            'If Port = "80" Then
            Host = "http://" & Host & Url
            'Else
            '    Host = "http://" & Host & ":" & Port & Url
            'End If
        End If
        Return Host
    End Function


    ''' <summary>
    ''' 返回客户端IP
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetIP() As String
        Dim LoginIP As String = System.Web.HttpContext.Current.Request.ServerVariables("HTTP_X_FORWARDED_FOR")
        If LoginIP Is Nothing Then
            LoginIP = System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR")
        End If
        Return LoginIP
    End Function

    ''' <summary>
    ''' 记录用户登陆信息,指定用户
    ''' </summary>
    ''' <param name="UserName"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function System_User_Login_Log(ByVal UserName As String) As Boolean
        Dim LoginIP As String = GetIP()
        DB.Query("insert into User_Login_Log(LoginName,LoginIP) values('" & UserName & "','" & LoginIP & "')")
        If DB.ErrorMessage Is Nothing Then
            Return True
        Else
            _ErrMessage = DB.ErrorMessage
            Return False
        End If
    End Function

    ''' <summary>
    ''' 记录用户的操作内容
    ''' </summary>
    ''' <param name="UserID"></param>
    ''' <param name="OpContent"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function System_UserOp_Log(ByVal UserID As Integer, ByVal OpContent As String) As Boolean
        Dim LoginIP As String = System.Web.HttpContext.Current.Request.ServerVariables("HTTP_X_FORWARDED_FOR")
        If LoginIP Is Nothing Then
            LoginIP = System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR")
        End If
        If OpContent.Length > 5000 Then OpContent.Substring(0, 4999)
        DB.Query("INSERT INTO Op_History([UserID],[OpContent],[OpIP])VALUES(" & UserID & ",'" & Me.SqlFilter(OpContent) & "','" & Me.SqlFilter(LoginIP) & "')")
        If DB.ErrorMessage Is Nothing Then
            Return True
        Else
            _ErrMessage = DB.ErrorMessage
            Return False
        End If
    End Function

    Function GetCurrentPath_Info() As String
        '得到当前路径
        Dim Path_Info As String
        Path_Info = System.Web.HttpContext.Current.Request.ServerVariables("Path_Info").ToLower
        Dim index As Integer
        index = Path_Info.LastIndexOf("manager")
        If index > 0 Then       '去掉前面的部分.只留言后面的.
            Path_Info = "../" & Path_Info.Substring(index)
        End If
        Return Path_Info
    End Function

    Function GetMKXM(ByVal Path_Info As String) As Integer
        '根据路径信息得到模块代码
        Dim Tb As New Data.DataTable
        Tb = DB.Table("select MKDM,MKMC from GY_MKXX where XDLJ ='" & Path_Info & "'", "GY_MKXX")
        If Tb.Rows.Count > 0 Then
            If Tb.Rows.Count >= 2 Then
                HttpContext.Current.Response.Write("请联系管理员进行处理,当前功能存在二个功能名如下：")
                Dim i As Integer
                For i = 0 To Tb.Rows.Count - 1
                    HttpContext.Current.Response.Write("<br>" & i + 1 & "、" & Tb.Rows(i)(1))
                Next
                HttpContext.Current.Response.End()
            End If
            Return Tb.Rows(0)(0)
        Else
            Return 0
        End If
    End Function

    Function GetMKMCByMKDM(ByVal MKDM As Integer) As String
        Dim tbMKDM As New DataTable
        tbMKDM = DB.Table("select NoLcDM,XsnDir,MKMC,MKDM from [GY_MKXX] where MKDM = " & MKDM, "MKMC")
        If tbMKDM.Rows.Count > 0 Then
            Return tbMKDM.Rows(0).Item("mkmc").ToString()
        Else
            Return ""
        End If
    End Function

    Sub Checking()
        '这里对用户的访问权进行测试.如果无权.直接显示无权
        Dim UserID As Integer = Me.GetUserID(Me.GetWebUserName)
        If GetUserHaveQX(UserID, GetMKXM(GetCurrentPath_Info)) = False Then
            System.Web.HttpContext.Current.Response.Write("无权访问")
            System.Web.HttpContext.Current.Response.End()
        End If
    End Sub

    Sub Checking(ByVal Path_Info As String)
        If Path_Info.Trim = "" Then Path_Info = "------"
        '这里对用户的访问权进行测试.如果无权.直接显示无权
        Dim UserID As Integer = Me.GetUserID(Me.GetWebUserName)
        If GetUserHaveQX(UserID, GetMKXM(Path_Info)) = False Then
            System.Web.HttpContext.Current.Response.Write("无权访问")
            System.Web.HttpContext.Current.Response.End()
        End If
    End Sub

    Function GetCurrentVDir() As String
        '得到当前路径的虚拟目录的目录名,也就是域名后面的第一个目录名
        Dim Path_Info As String
        Path_Info = System.Web.HttpContext.Current.Request.ServerVariables("Path_Info")
        Dim index As Integer
        index = Path_Info.LastIndexOf("/")
        If index > 0 Then       '去掉最后的文件名`
            Path_Info = Path_Info.Substring(0, index)
        End If
        index = Path_Info.LastIndexOf("/")
        If index > 0 Then       '得到最后一级目录名
            Path_Info = Path_Info.Substring(index + 1)
        End If
        Return Path_Info
    End Function

    Function GetOpenConfig(ByVal OpText As String, ByVal UserID As Integer, ByVal LCDM As Integer) As Integer
        '得到当前用户的打开设置参数
        If OpText.Trim.Length = 0 Then      '如果当前类型传过来空时。直接返回错误
            Return -1
        End If
        Dim tb As New Data.DataTable
        tb = DB.Table("select value from Xconfig where Config='" & OpText & "' and UserID=" & UserID & " and LCDM=" & LCDM, "Xconfig")
        If tb.Rows.Count = 0 Then
            Return -1
        Else
            If IsDBNull(tb.Rows(0)(0)) = True Then
                Return -1
            Else
                Return tb.Rows(0)(0)
            End If
        End If
    End Function

    Function Tester(ByVal UserName As String) As Boolean
        Dim TesterList As String = pub.GetWebConfig("SunfunSoft.Xman.Tester").ToLower
        If TesterList.IndexOf(UserName.ToLower.Trim & ",") >= 0 Then
            Return True
        Else
            Return False
        End If
    End Function

    ''' <summary>
    ''' 得到当前登陆的用户用户名
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetWebUserName() As String
        Dim Login_User As String
        If pub.GetWebConfig("SunfunSoft.Xman.ADUserAuthentication").ToLower = "true" Then '得到当前的ＩＩＳ用户
            Login_User = System.Web.HttpContext.Current.Request.ServerVariables("LOGON_USER")
            Dim Temp As String() = Login_User.Split("\")
            Login_User = Temp(Temp.GetUpperBound(0))
        Else            '数据库验证方式
            Dim Topstr As String = pub.GetWebConfig("SunfunSoft.Xman.Session.TopStr").ToString
            If Session(Topstr & "_UName") = "" Then
                If HttpContext.Current.Request.Cookies(Topstr & "_UName") Is Nothing Then
                    Login_User = ""
                Else
                    Login_User = HttpContext.Current.Request.Cookies(Topstr & "_UName").Value
                End If
            Else
                Login_User = Session(Topstr & "_UName")
            End If
        End If
        DB.Query("update Online_User set Date1=getdate() where userid = " & GetUserID(Login_User))
        Return Login_User
    End Function

    ''' <summary>
    ''' 得到当前登陆的用户用户名，但不跟新最后活动时间。
    ''' </summary>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function GetWebUserNameWithoutUpdate() As String
        Dim Login_User As String
        If pub.GetWebConfig("SunfunSoft.Xman.ADUserAuthentication").ToLower = "true" Then '得到当前的ＩＩＳ用户
            Login_User = System.Web.HttpContext.Current.Request.ServerVariables("LOGON_USER")
            Dim Temp As String() = Login_User.Split("\")
            Login_User = Temp(Temp.GetUpperBound(0))
        Else            '数据库验证方式
            Dim Topstr As String = pub.GetWebConfig("SunfunSoft.Xman.Session.TopStr").ToString
            If Session(Topstr & "_UName") = "" Then
                If HttpContext.Current.Request.Cookies(Topstr & "_UName") Is Nothing Then
                    Login_User = ""
                Else
                    Login_User = HttpContext.Current.Request.Cookies(Topstr & "_UName").Value
                End If
            Else
                Login_User = Session(Topstr & "_UName")
            End If
        End If
        Return Login_User
    End Function

    Function getFormCreator(ByVal fid As String) As String

        Dim dt As New DataTable
        Dim sqlstr As String
        sqlstr = "select xmsm from gy_xmxx,xx_xmjc where gy_xmxx.xmdm = xx_xmjc.xmdm and xx_xmjc.fid=" & fid
        dt = DB.Table(sqlstr, "ddd")

        If dt.Rows.Count > 0 Then
            Return dt.Rows(0).Item("xmsm").ToString()
        Else
            Return ""
        End If


    End Function


#Region "流程管理相关函数"

    ''' <summary>
    ''' 通过流程状态的ID来获取流程状态名
    ''' </summary>
    ''' <param name="processID">流程状态ID</param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function getProcessStatusNameByID(ByVal processID As Integer) As String
        Dim dt As New DataTable
        Dim sqlstr As String
        Dim result As String
        sqlstr = "select statusName from processStatus where id = " & processID
        dt = DB.Table(sqlstr, "dd")
        If dt.Rows.Count > 0 Then
            result = dt.Rows(0).Item(0).ToString()
        Else
            result = String.Empty
        End If
        Return result
    End Function

    Function getProcessIDByStatusName(ByVal StatusName As String) As Integer
        Dim dt As New DataTable
        Dim sqlstr As String
        Dim result As Integer
        sqlstr = "select id  from processStatus where  statusName = " & StatusName
        dt = DB.Table(sqlstr, "dd")
        If dt.Rows.Count > 0 Then
            result = Convert.ToInt32(dt.Rows(0).Item(0))
        Else
            result = 0
        End If
        Return result
    End Function




    ''' <summary>
    ''' 插入流程历史
    ''' </summary>
    ''' <param name="formID"></param>
    ''' <param name="currentProcessID"></param>
    ''' <param name="nextProcessID"></param>
    ''' <param name="toUserList"></param>
    ''' <param name="sendmessage"></param>
    ''' <remarks></remarks>
    Sub insertProcessHistory(ByVal formID As Integer, ByVal currentProcessID As Integer, ByVal nextProcessID As Integer, ByVal toUserList As String, ByVal sendmessage As String, ByVal attentionNodeValue As String)
        Dim sqlstr As String
        sqlstr = "insert into processHistory ([fid],[currentProcess],[nextProcess],[fromUserName],[toUserName],[sendMessageContent],[sendTime],[remark],attentionNodeValue) values (" & formID & ",'" & getProcessStatusNameByID(currentProcessID) & "','" & getProcessStatusNameByID(nextProcessID) & "','" & GetUserNameByDLMC(GetWebUserName()) & "','" & toUserList & "','" & sendmessage & "',getdate(),'自动流转','" & attentionNodeValue & "')"
        DB.Query(sqlstr)

    End Sub

    Sub insertProcessHistory(ByVal formID As Integer, ByVal currentProcess As String, ByVal nextProcess As String, ByVal toUserList As String, ByVal sendmessage As String, ByVal attentionNodeValue As String)

        Dim sqlstr As String
        sqlstr = "insert into processHistory ([fid],[currentProcess],[nextProcess],[fromUserName],[toUserName],[sendMessageContent],[sendTime],[remark],attentionNodeValue) values (" & formID & ",'" & currentProcess & "','" & nextProcess & "','" & GetUserNameByDLMC(GetWebUserName()) & "','" & toUserList & "','" & sendmessage & "',getdate(),'自动流转','" & attentionNodeValue & "')"
        DB.Query(sqlstr)

    End Sub

    ''' <summary>
    ''' 改写流程历史中状态。
    ''' </summary>
    ''' <param name="fid"></param>
    ''' <remarks></remarks>
    Sub processOver(ByVal fid As Integer)
        Dim sqlstr As String
        sqlstr = "update processHistory set isover = 'true' where fid = " & fid & " and isover = 'false'"
        DB.Query(sqlstr)
    End Sub


#End Region

    Sub autoSend(ByVal toUserList As String, ByVal fid As Integer, ByVal sendMessage As String)


        Dim Login_User As String
        Login_User = GetWebUserName()

        Dim userid As Integer
        userid = GetUserID(Login_User)

        Dim tempFolder As String
        tempFolder = Server.MapPath("./" & "PersonalFolders/" & Login_User & "/临时附件文件夹")
        If System.IO.Directory.Exists(tempFolder) = False Then
            System.IO.Directory.CreateDirectory(tempFolder)
        End If
        Dim AttFolder As String = Server.MapPath("./") & "\PersonalFolders\MessageAttachment\"
        IO.CreateDir(AttFolder)

        Dim i As Integer = 0
        Dim YGDM As Integer
        Dim userNames() As String


        If toUserList.IndexOf(",") <> -1 Then
            userNames = toUserList.Substring(0, toUserList.Length - 1).Split(",")
        Else

            userNames = toUserList.Split(",")
        End If

        Dim sendUserNames(userNames.Length - 1) As String
        Dim userList As String = String.Empty

        For i = 0 To userNames.Length - 1
            sendUserNames(i) = GetDLMCByUserName(userNames(i))
            userList += userNames(i) & "(" & sendUserNames(i) & ");"
        Next

        Dim msgid As Integer
        For i = 0 To sendUserNames.Length - 1
            YGDM = GetUserIDByXM(userNames(i))

            Try
                msgid = DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,toidlist) values('" & sendMessage & "'," & userid & ",''," & YGDM & ",getdate(),0,1,'" & userList & "');Select CId from SendMessage where Cid = @@IDENTITY")
                DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & fid & "," & YGDM & ",''," & userid & ",0," & msgid & ")")
                msgid = DB.ExeScalar("insert into SendMessage(Title,FromID,Content,TOID,SendDate,LookFlag,msgkind,ToIdList) values('" & sendMessage & "'," & userid & ",'',0,getdate(),0,1,'" & userList & "');Select CId from SendMessage where Cid = @@IDENTITY")
                DB.ExeScalar("INSERT INTO [Gy_XmXd]([Fid],[YGDM] ,[XdText] ,[FQR],[XdBZ],msgid) VALUES (" & fid & ",0,''," & userid & ",0," & msgid & ")")
            Catch ex As Exception
            End Try
        Next

        '写入附件文件
        IO.CreateDir(AttFolder & "\" & msgid & "\")
        Dim Values As New ArrayList
        Dim MyFiles As String()
        MyFiles = Directory.GetFiles(tempFolder)          '//得到该目录下所有文件
        Values.AddRange(MyFiles)                            '//加入文件
        Dim TmpFileName As String
        For i = 0 To Values.Count - 1
            TmpFileName = Values.Item(i).ToString.Replace(tempFolder & "\", "")
            System.IO.File.Move(tempFolder & "\" & TmpFileName, AttFolder & "\" & msgid & "\" & TmpFileName)
            DB.Query("insert into MessageAttachment(msgid,filepath) values(" & msgid & ",'" & SqlFilter(TmpFileName) & "')")
        Next
    End Sub


    Function getshowListFilter(ByVal MKDM As Integer) As String
        Dim dt As New DataTable
        Dim sqlstr As String = String.Empty
        Dim tempstr As String = String.Empty

        tempstr = "select * from AdvancedShowListSetting where MKDM=" & MKDM
        dt = DB.Table(tempstr, "dd")

        Dim conditionNode As String
        Dim conditionType As String
        Dim conditionSymbol As String
        Dim conditionText As String

        For i As Integer = 0 To dt.Rows.Count - 1


            conditionNode = dt.Rows(i).Item("conditionNode").ToString()
            conditionType = dt.Rows(i).Item("conditionType").ToString()
            conditionSymbol = dt.Rows(i).Item("conditionSymbol").ToString()
            conditionText = dt.Rows(i).Item("conditionText").ToString()


            Select Case conditionSymbol
                Case "="
                    sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " = '" & conditionText & "'"
                Case "!="
                    sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " != '" & conditionText & "'"
                Case "like"
                    sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " like '%" & conditionText & "%'"
                Case ">"
                    Try

                        If conditionType = "typeNumber" Then
                            sqlstr = sqlstr & " and  cast( " & conditionNode.Replace(":", "") & " as int ) >" & conditionText

                        ElseIf conditionType = "typeDate" Then
                            sqlstr = sqlstr & " and  cast( " & conditionNode.Replace(":", "") & " as datetime ) >" & conditionText
                        Else
                            sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " >" & conditionText
                        End If
                        sqlstr = sqlstr & " and " & conditionNode.Replace(":", "") & " != '空' and " & conditionNode.Replace(":", "") & " != '' and " & conditionNode.Replace(":", "") & " is not null"
                    Catch ex As Exception
                        sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " > '" & conditionText & "'"
                    End Try
                Case "<"
                    Try
                        If conditionType = "typeNumber" Then
                            sqlstr = sqlstr & " and  cast( " & conditionNode.Replace(":", "") & " as int ) <" & conditionText
                        ElseIf conditionType = "typeDate" Then
                            sqlstr = sqlstr & " and  cast( " & conditionNode.Replace(":", "") & " as datetime ) <" & conditionText
                        Else
                            sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " < " & conditionText

                        End If
                        sqlstr = sqlstr & " and " & conditionNode.Replace(":", "") & " != '空' and " & conditionNode.Replace(":", "") & " != '' and " & conditionNode.Replace(":", "") & " is not null"
                    Catch ex As Exception
                        sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " < '" & conditionText & "'"
                    End Try
                Case "before"
                    Try
                        sqlstr = sqlstr & " and   DATEDIFF(day,getdate()," & conditionNode.Replace(":", "") & ") < " & conditionText & " "
                    Catch ex As Exception
                        sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " < '" & conditionText & "'"
                    End Try
                    sqlstr = sqlstr & " and " & conditionNode.Replace(":", "") & " != '空' and " & conditionNode.Replace(":", "") & " != '' and " & conditionNode.Replace(":", "") & " is not null"
                Case "after"
                    Try
                        sqlstr = sqlstr & " and   DATEDIFF(day," & conditionNode.Replace(":", "") & ",getdate()) < " & conditionText & " "
                    Catch ex As Exception
                        sqlstr = sqlstr & " and  " & conditionNode.Replace(":", "") & " < '" & conditionText & "'"
                    End Try
                    sqlstr = sqlstr & " and " & conditionNode.Replace(":", "") & " != '空' and " & conditionNode.Replace(":", "") & " != '' and " & conditionNode.Replace(":", "") & " is not null"
                Case "userLoginName"
                    Try
                        sqlstr = sqlstr & " and " & conditionNode.Replace(":", "") & " = '" & GetWebUserName() & "' "
                    Catch ex As Exception

                    End Try
                    sqlstr = sqlstr & " and " & conditionNode.Replace(":", "") & " != '空' and " & conditionNode.Replace(":", "") & " != '' and " & conditionNode.Replace(":", "") & " is not null"
                Case "userRealName"
                    Try
                        sqlstr = sqlstr & " and " & conditionNode.Replace(":", "") & " = '" & GetUserNameByDLMC(GetWebUserName()) & "' "
                    Catch ex As Exception

                    End Try
                    sqlstr = sqlstr & " and " & conditionNode.Replace(":", "") & " != '空' and " & conditionNode.Replace(":", "") & " != '' and " & conditionNode.Replace(":", "") & " is not null"
            End Select
        Next

        Return sqlstr

    End Function

    ''' <summary>
    ''' 创建查询数据表
    ''' </summary>
    ''' <param name="mkmc"></param>
    ''' <returns></returns>
    ''' <remarks></remarks>
    Function creatMapSearchTable(ByVal mkmc As String) As Boolean

        Dim tablename As String = mkmc & "_MapSearch"
        Dim sqlstr = String.Empty

        '创建表
        sqlstr += "SET ANSI_NULLS ON" & vbCrLf
        sqlstr += "SET QUOTED_IDENTIFIER ON" & vbCrLf
        sqlstr += "SET ANSI_PADDING ON" & vbCrLf
        sqlstr += "CREATE TABLE [dbo].[" & tablename & "](" & vbCrLf
        sqlstr += "[CID] [bigint] IDENTITY(1,1) NOT NULL," & vbCrLf
        sqlstr += "[FormID] [int] NULL," & vbCrLf
        sqlstr += "[XMDM] [int] NULL," & vbCrLf
        sqlstr += "[MKDM] [int] NULL," & vbCrLf
        sqlstr += "[FormData] [varchar](500) NULL," & vbCrLf
        sqlstr += "CONSTRAINT [PK_" & tablename & "] PRIMARY KEY CLUSTERED " & vbCrLf
        sqlstr += "(" & vbCrLf
        sqlstr += "[CID]Asc" & vbCrLf
        sqlstr += ")WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]" & vbCrLf
        sqlstr += ") ON [PRIMARY]" & vbCrLf
        sqlstr += "SET ANSI_PADDING OFF" & vbCrLf

        DB.Query(sqlstr)
        If DB.ErrorMessage <> "" Then
            Return False
        End If

        '创建索引
        sqlstr = String.Empty
        sqlstr += "CREATE NONCLUSTERED INDEX [IX_" & tablename & "_FormData] ON [dbo].[" & tablename & "] " & vbCrLf
        sqlstr += "(" & vbCrLf
        sqlstr += "[FormData]Asc" & vbCrLf
        sqlstr += ")WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]" & vbCrLf

        DB.Query(sqlstr)
        If DB.ErrorMessage <> "" Then
            Return False
        End If

        sqlstr = String.Empty

        sqlstr += "CREATE NONCLUSTERED INDEX [IX_" & tablename & "_FormID] ON [dbo].[" & tablename & "] " & vbCrLf
        sqlstr += "(" & vbCrLf
        sqlstr += "[FormID]Asc" & vbCrLf
        sqlstr += ")WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]" & vbCrLf

        DB.Query(sqlstr)
        If DB.ErrorMessage <> "" Then
            Return False
        End If

        sqlstr = String.Empty

        sqlstr += "CREATE NONCLUSTERED INDEX [IX_" & tablename & "_MKDM] ON [dbo].[" & tablename & "] " & vbCrLf
        sqlstr += "(" & vbCrLf
        sqlstr += "[MKDM]Asc" & vbCrLf
        sqlstr += ")WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]" & vbCrLf

        DB.Query(sqlstr)
        If DB.ErrorMessage <> "" Then
            Return False
        End If

        Return True
    End Function



    Protected Overrides Sub finalize()
        '释放各个类
        pub = Nothing
        Js = Nothing
        DB = Nothing
        Upload = Nothing
        XmlClass = Nothing
        IO = Nothing
        EnCrypt = Nothing
    End Sub



End Class
